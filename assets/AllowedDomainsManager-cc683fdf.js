import{j as d,c as b}from"./Icon-8dd1dd62.js";import{k as H}from"./index-13d794b2.js";import{f as I}from"./index-02c9c348.js";import{r as t,R as P}from"./index-8b3efc3f.js";import{t as j,g as E}from"./googleFaviconServiceHelper-8a59a545.js";import{C as F}from"./store-fcbe2a1f.js";import{g as A,s as K}from"./allowedDomainsDB-2da60848.js";import{t as U}from"./trackEventViaMessage-5bc40ab7.js";import{s as q}from"./scribeSuggestions-6bff5e43.js";import{B as R}from"./Button-7b9bff07.js";import{I as G,C as J}from"./Input-35a73570.js";const Q=()=>{const[p,s]=t.useState(null),[o,c]=t.useState(!0),[x,y]=t.useState(null);return t.useEffect(()=>{let i=!1;return(async()=>{var u;try{const m=await F.get("workspace/featured_app_tags/");if(!i){const f={app_tags:((u=m.data.app_tags)==null?void 0:u.slice(0,10))||[]};s(f)}}catch(m){i||y(m)}finally{i||c(!1)}})(),()=>{i=!0}},[]),{data:p,loading:o,error:x}},V=({includeTopDomains:p=!1,onChange:s}={})=>{const[o,c]=t.useState([]),[x,y]=t.useState(!0),{data:i}=Q(),[u,m]=t.useState(!1),f=t.useMemo(()=>{if(!p||!(i!=null&&i.app_tags))return[];const n=[];return i.app_tags.forEach(r=>{typeof r.root_domain_url=="string"&&n.push(r.root_domain_url.toLowerCase()),Array.isArray(r.multi_root_domains_urls)&&n.push(...r.multi_root_domains_urls.filter(Boolean).map(l=>l.toLowerCase()))}),[...new Set(n)]},[p,i]);t.useEffect(()=>{(async()=>{try{const n=await A(),r=Array.from(new Set(n.map(l=>l.toLowerCase())));c(r),s==null||s(r)}catch(n){console.error("Failed to load existing domains:",n)}finally{y(!1)}})()},[s]),t.useEffect(()=>{if(!p||u||f.length===0)return;const n=[...new Set([...o,...f])];c(n),s==null||s(n),m(!0)},[p,f,o,u,s]);const C=t.useCallback(n=>{const r=n.toLowerCase();if(!o.includes(r)){const l=[r,...o];c(l),s==null||s(l)}},[o,s]),_=t.useCallback(n=>{const r=n.toLowerCase(),l=o.filter(k=>k!==r);c(l),s==null||s(l)},[o,s]),h=t.useCallback(()=>{c([]),s==null||s([])},[s]);return{allowedDomains:o,isLoading:x,addDomain:C,removeDomain:_,clearDomains:h,topDomains:f}},W=P.memo(({className:p,onChange:s,addButtonType:o="icon",maxChipHeight:c,includeTopDomains:x=!1})=>{const[y,i]=t.useState(""),[u,m]=t.useState(null),[f,C]=t.useState({}),_=t.useRef(new Set),h=t.useRef(s),n=t.useRef(x),r=V({includeTopDomains:x,onChange:s}),[l,k]=t.useState([]);t.useEffect(()=>{n.current||A().then(e=>{var a;k(e),(a=h.current)==null||a.call(h,e),e.length===0&&q(!1)})},[]);const D=t.useCallback(e=>{n.current||K(e).then(()=>{var a;k(e),(a=h.current)==null||a.call(h,e)})},[]),{domains:g,isLoading:$,add:L,remove:N}=t.useMemo(()=>x?{domains:r.allowedDomains,isLoading:r.isLoading,add:r.addDomain,remove:r.removeDomain}:{domains:l,isLoading:!1,add:e=>D([e,...l]),remove:e=>D(l.filter(a=>a!==e))},[x,r,l,D]),z=t.useMemo(()=>{const e={};return g.forEach(a=>{const w=Object.prototype.hasOwnProperty.call(j,a),v=f[a];e[a]=w||v}),e},[g,f]),B=e=>{let a=e.trim().toLowerCase().replace(/^https?:\/\//,"").replace(/^www\./,"");return a=a.split("/")[0],/^[a-z0-9.-]+\.[a-z]{2,}$/i.test(a)?Object.keys(j).find(w=>{const v=w.replace(/^www\./,"");return w===a||v===a||w===`www.${a}`})??a:null},S=t.useCallback(()=>{const e=y.trim().toLowerCase();if(!e)return;const a=B(e);if(!a)return m("Please enter valid url");if(g.includes(a))return m(`Url ${a} is already on your allow list`);U("auto_capture_add_domain_clicked",{location:"extension",auto_capture_domains_added:[a,...g]}),L(a),i(""),m(null)},[y,g,L]),M=t.useCallback(e=>{N(e)},[N]),O=e=>{e.key==="Enter"&&(e.preventDefault(),S())},T=e=>{u&&m(null),i(e.target.value)};return t.useEffect(()=>{g.filter(e=>!j[e]&&!_.current.has(e)).forEach(e=>{const a=E(e,32),w=new Image;w.onload=()=>C(v=>({...v,[e]:!0})),w.onerror=()=>C(v=>({...v,[e]:!1})),w.src=a,_.current.add(e)})},[g]),$?d.jsx("div",{className:b("flex flex-col gap-3 w-full",p),children:d.jsx("div",{className:"text-sm text-slate-500",children:"Loading domains..."})}):d.jsxs("div",{className:b("flex flex-col gap-3 w-full",p),children:[d.jsxs("div",{className:b("flex w-full items-center gap-2",{relative:o==="icon"}),children:[d.jsx(G,{id:"allowed-domain-input",placeholder:"Add domain (e.g. google.com)",value:y,onChange:T,onKeyDown:O,error:!!u,className:b("flex-grow",o==="icon"&&"pr-9","px-2 py-2")}),o==="icon"?d.jsx(R,{type:"button",variant:"ghost",size:"small",icon:I,className:"shrink-0 absolute right-2 top-1/2 -translate-y-1/2",onClick:S,"aria-label":"Add domain"}):d.jsx(R,{type:"button",variant:"secondary",size:"default",onClick:S,className:"shrink-0 px-3 py-2.5",children:"Add"})]}),u&&d.jsx("p",{className:"m-0 font-sans text-sm leading-4 text-red-600 dark:text-red-300",children:u}),d.jsx("div",{className:"overflow-y-auto p-1",style:c?{maxHeight:c}:void 0,children:g.length>0&&d.jsx("div",{className:`flex flex-wrap gap-3 ${c?"pb-3":""}`,children:g.map(e=>{const a=z[e];return d.jsx(J,{label:e.replace(/^www\./,""),img:a?{src:E(e,32),alt:`${e} favicon`}:void 0,icon:a?void 0:H,onRemove:()=>M(e)},e)})})})]})});export{W as A};

var po=Object.defineProperty;var go=(e,t,n)=>t in e?po(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var Oe=(e,t,n)=>(go(e,typeof t!="symbol"?t+"":t,n),n);var co;import{ax as cn,ay as ho,az as Rr,aA as ln,aB as x,aC as We,aD as ie,aE as mo,aF as se,aG as Dr,aH as dn,aI as fo,aJ as xr,aK as He,aL as un,aM as pn,aN as Je,aO as Ar,aP as yo,aQ as _o,aR as bo,aS as vo,aT as B,aU as wo,aV as Pr,aW as Lr,aX as gn,aY as Nr,aZ as So,a_ as Eo,a$ as To,b0 as Io,b1 as hn,b2 as Fr,b3 as ko,b4 as Ur,b5 as Ne,b6 as Ct,b7 as mn,b8 as Se,b9 as Co,ba as Oo,bb as fn,bc as Ot,x as $,bd as yn,be as Mr,bf as Ro,bg as Do,bh as _n,bi as xo,bj as Ao,bk as Po,bl as I,bm as Lo,bn as No,bo as $r,bp as jr,bq as Fo,br as Uo,bs as qr,bt as Wr,s as l,bu as Z,R as he,a0 as at,E as ae,bv as V,ac as ot,bw as Br,bx as Gr,by as Fe,w as Mo,bz as $o,bA as jo,bB as D,bC as qo,ad as zr,bD as Wo,bE as Bo,bF as Go,bG as zo,G as Vo,bH as Ho,bI as Jo,bJ as Ee,bK as it,U as G,bL as Vr,bM as Ko,bN as bn,bO as ct,bP as Yo,a5 as vn,bQ as Hr,bR as Jr,t as z,bS as Xo,a as Qo,bT as H,S as Rt,bU as wn,bV as Zo,C as j,ab as lt,bW as Dt,bX as Ke,bY as ei,bZ as ti,b_ as ni,b$ as ri,c0 as Kr,c1 as si,c2 as ai,c3 as Sn,c4 as oi,L as ii,v as Re,c5 as En,c6 as Yr,ao as oe,c7 as Ae,c8 as Tn,c9 as Xr,ca as Qr,cb as dt,a9 as ee,cc as In,cd as Zr,ce as Te,cf as kn,cg as ci,ch as li,ci as es,cj as di,ck as ui,cl as xt,cm as pi,cn as gi,D as hi,co as ts,cp as mi,a2 as fi,cq as yi,cr as Cn,cs as ns,ct as _i,e as rs,W as Be,T as _e,k as q,o as ye,cu as ss,cv as ut,cw as as,cx as os,cy as bi,cz as On,cA as vi,cB as wi,cC as Si,cD as Ei,cE as Ti,cF as Ii,aj as ki,cG as is,cH as cs,cI as Ye,cJ as Rn,cK as Xe,q as pt,cL as Ci,cM as ls,m as ds,i as Oi,cN as Ri,cO as Dn,cP as us,cQ as xn,cR as Di,cS as xi,cT as Ai,cU as Pi,F as ps,cV as Li,cW as Ni,cX as Fi,cY as gs,cZ as hs,c_ as Ui,am as Mi,c$ as ms,d0 as $i,d1 as At,a7 as ji,d2 as An,d3 as Pn,d4 as Pt,O as Lt,d5 as Ln,d6 as Nn,d7 as gt,d8 as Fn,d9 as qi,da as Wi,db as Bi,dc as Gi,dd as zi,de as Vi,df as Hi,dg as Ji,dh as fs,di as Ki,dj as Nt,dk as Yi,dl as Xi,dm as Qi,dn as Zi,dp as ys,dq as ec,Z as _s,dr as bs,ds as tc,dt as nc,du as rc,dv as sc,dw as ac,dx as vs,y as oc,dy as ic,dz as cc,dA as lc,dB as dc,dC as uc,dD as ws,dE as pc,dF as Ss,dG as Es}from"./store-fcbe2a1f.js";import{a as Ts}from"./browserContext-8e292c38.js";import{p as gc,t as Is,m as hc,e as mc}from"./index-f7a5862e.js";import{E as Ft}from"./entry-point-enums-c196ff5e.js";import{g as fc,h as Ut,j as Mt,k as yc,l as _c,m as bc,n as vc,o as wc,q as Sc}from"./scribeLiveUtils-cf601fda.js";import{M as ks,i as Ec}from"./userHelpers-16bc7dd8.js";import{c as $t,g as Tc}from"./_commonjsHelpers-de833af9.js";import{v as Ue}from"./v4-c70744d4.js";import{g as Ic,a as Cs,s as Un,b as kc}from"./options-0d513709.js";import{V as jt}from"./messages-bcaa89f6.js";import{g as Os,s as Cc}from"./allowedDomainsDB-2da60848.js";import{o as Mn,D as Oc,a as Rc,A as me,b as Dc,c as xc,C as Ac,d as Pc,h as $n,e as Lc,f as Rs,u as Nc,s as Fc,i as Uc,j as Mc,k as Ds,l as $c}from"./longRunningRecorder-5bbcc7ac.js";import{u as jc}from"./domUtils-6bdec28b.js";import"./index-8b3efc3f.js";import{g as qc}from"./scribeSuggestions-6bff5e43.js";import"./domCopyAnnotate-a2b92afc.js";import"./getTargetElementAttributes-3f1109f1.js";function Wc(e,t,n=250,r,s,a,c){if(!a.exception||!a.exception.values||!c||!cn(c.originalException,Error))return;const i=a.exception.values.length>0?a.exception.values[a.exception.values.length-1]:void 0;i&&(a.exception.values=Bc(jn(e,t,s,c.originalException,r,a.exception.values,i,0),n))}function jn(e,t,n,r,s,a,c,i){if(a.length>=n+1)return a;let d=[...a];if(cn(r[s],Error)){xs(c,i);const u=e(t,r[s]),h=d.length;As(u,s,h,i),d=jn(e,t,n,r[s],s,[u,...d],u,h)}return Array.isArray(r.errors)&&r.errors.forEach((u,h)=>{if(cn(u,Error)){xs(c,i);const _=e(t,u),b=d.length;As(_,`errors[${h}]`,b,i),d=jn(e,t,n,u,s,[_,...d],_,b)}}),d}function xs(e,t){e.mechanism=e.mechanism||{type:"generic",handled:!0},e.mechanism={...e.mechanism,...e.type==="AggregateError"&&{is_exception_group:!0},exception_id:t}}function As(e,t,n,r){e.mechanism=e.mechanism||{type:"generic",handled:!0},e.mechanism={...e.mechanism,type:"chained",source:t,exception_id:n,parent_id:r}}function Bc(e,t){return e.map(n=>(n.value&&(n.value=ho(n.value,t)),n))}const Gc=/^(?:(\w+):)\/\/(?:(\w+)(?::(\w+)?)?@)([\w.-]+)(?::(\d+))?\/(.+)/;function zc(e){return e==="http"||e==="https"}function ht(e,t=!1){const{host:n,path:r,pass:s,port:a,projectId:c,protocol:i,publicKey:d}=e;return`${i}://${d}${t&&s?`:${s}`:""}@${n}${a?`:${a}`:""}/${r&&`${r}/`}${c}`}function Vc(e){const t=Gc.exec(e);if(!t){Rr(()=>{console.error(`Invalid Sentry Dsn: ${e}`)});return}const[n,r,s="",a,c="",i]=t.slice(1);let d="",u=i;const h=u.split("/");if(h.length>1&&(d=h.slice(0,-1).join("/"),u=h.pop()),u){const _=u.match(/^\d+/);_&&(u=_[0])}return Ps({host:a,pass:s,path:d,projectId:u,port:c,protocol:n,publicKey:r})}function Ps(e){return{protocol:e.protocol,publicKey:e.publicKey||"",pass:e.pass||"",host:e.host,port:e.port||"",path:e.path||"",projectId:e.projectId}}function Hc(e){if(!ln)return!0;const{port:t,projectId:n,protocol:r}=e;return["protocol","publicKey","host","projectId"].find(s=>e[s]?!1:(x.error(`Invalid Sentry Dsn: ${s} missing`),!0))?!1:n.match(/^\d+$/)?zc(r)?t&&isNaN(parseInt(t,10))?(x.error(`Invalid Sentry Dsn: Invalid port ${t}`),!1):!0:(x.error(`Invalid Sentry Dsn: Invalid protocol ${r}`),!1):(x.error(`Invalid Sentry Dsn: Invalid projectId ${n}`),!1)}function Jc(e){const t=typeof e=="string"?Vc(e):Ps(e);if(!(!t||!Hc(t)))return t}class De extends Error{constructor(t,n="warn"){super(t),this.message=t,this.name=new.target.prototype.constructor.name,Object.setPrototypeOf(this,new.target.prototype),this.logLevel=n}}const qt={},Ls={};function Ge(e,t){qt[e]=qt[e]||[],qt[e].push(t)}function ze(e,t){Ls[e]||(t(),Ls[e]=!0)}function Ie(e,t){const n=e&&qt[e];if(n)for(const r of n)try{r(t)}catch(s){ln&&x.error(`Error while triggering instrumentation handler.
Type: ${e}
Name: ${We(r)}
Error:`,s)}}function Kc(e){const t="console";Ge(t,e),ze(t,Yc)}function Yc(){"console"in ie&&mo.forEach(function(e){e in ie.console&&se(ie.console,e,function(t){return Dr[e]=t,function(...n){Ie("console",{args:n,level:e});const r=Dr[e];r&&r.apply(ie.console,n)}})})}const Qe=ie,Xc=1e3;let Ns,qn,Wn;function Qc(e){const t="dom";Ge(t,e),ze(t,Zc)}function Zc(){if(!Qe.document)return;const e=Ie.bind(null,"dom"),t=Fs(e,!0);Qe.document.addEventListener("click",t,!1),Qe.document.addEventListener("keypress",t,!1),["EventTarget","Node"].forEach(n=>{const r=Qe[n]&&Qe[n].prototype;!r||!r.hasOwnProperty||!r.hasOwnProperty("addEventListener")||(se(r,"addEventListener",function(s){return function(a,c,i){if(a==="click"||a=="keypress")try{const d=this,u=d.__sentry_instrumentation_handlers__=d.__sentry_instrumentation_handlers__||{},h=u[a]=u[a]||{refCount:0};if(!h.handler){const _=Fs(e);h.handler=_,s.call(this,a,_,i)}h.refCount++}catch{}return s.call(this,a,c,i)}}),se(r,"removeEventListener",function(s){return function(a,c,i){if(a==="click"||a=="keypress")try{const d=this,u=d.__sentry_instrumentation_handlers__||{},h=u[a];h&&(h.refCount--,h.refCount<=0&&(s.call(this,a,h.handler,i),h.handler=void 0,delete u[a]),Object.keys(u).length===0&&delete d.__sentry_instrumentation_handlers__)}catch{}return s.call(this,a,c,i)}}))})}function el(e){if(e.type!==qn)return!1;try{if(!e.target||e.target._sentryId!==Wn)return!1}catch{}return!0}function tl(e,t){return e!=="keypress"?!1:!t||!t.tagName?!0:!(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.isContentEditable)}function Fs(e,t=!1){return n=>{if(!n||n._sentryCaptured)return;const r=nl(n);if(tl(n.type,r))return;dn(n,"_sentryCaptured",!0),r&&!r._sentryId&&dn(r,"_sentryId",fo());const s=n.type==="keypress"?"input":n.type;el(n)||(e({event:n,name:s,global:t}),qn=n.type,Wn=r?r._sentryId:void 0),clearTimeout(Ns),Ns=Qe.setTimeout(()=>{Wn=void 0,qn=void 0},Xc)}}function nl(e){try{return e.target}catch{return null}}const Bn=xr();function Us(){if(!("fetch"in Bn))return!1;try{return new Headers,new Request("http://www.example.com"),new Response,!0}catch{return!1}}function Gn(e){return e&&/^function fetch\(\)\s+\{\s+\[native code\]\s+\}$/.test(e.toString())}function rl(){if(typeof EdgeRuntime=="string")return!0;if(!Us())return!1;if(Gn(Bn.fetch))return!0;let e=!1;const t=Bn.document;if(t&&typeof t.createElement=="function")try{const n=t.createElement("iframe");n.hidden=!0,t.head.appendChild(n),n.contentWindow&&n.contentWindow.fetch&&(e=Gn(n.contentWindow.fetch)),t.head.removeChild(n)}catch(n){ln&&x.warn("Could not create sandbox iframe for pure fetch check, bailing to window.fetch: ",n)}return e}function sl(e){const t="fetch";Ge(t,e),ze(t,al)}function al(){rl()&&se(ie,"fetch",function(e){return function(...t){const{method:n,url:r}=ol(t),s={args:t,fetchData:{method:n,url:r},startTimestamp:Date.now()};return Ie("fetch",{...s}),e.apply(ie,t).then(a=>{const c={...s,endTimestamp:Date.now(),response:a};return Ie("fetch",c),a},a=>{const c={...s,endTimestamp:Date.now(),error:a};throw Ie("fetch",c),a})}})}function zn(e,t){return!!e&&typeof e=="object"&&!!e[t]}function Ms(e){return typeof e=="string"?e:e?zn(e,"url")?e.url:e.toString?e.toString():"":""}function ol(e){if(e.length===0)return{method:"GET",url:""};if(e.length===2){const[n,r]=e;return{url:Ms(n),method:zn(r,"method")?String(r.method).toUpperCase():"GET"}}const t=e[0];return{url:Ms(t),method:zn(t,"method")?String(t.method).toUpperCase():"GET"}}let Wt=null;function il(e){const t="error";Ge(t,e),ze(t,cl)}function cl(){Wt=ie.onerror,ie.onerror=function(e,t,n,r,s){return Ie("error",{column:r,error:s,line:n,msg:e,url:t}),Wt&&!Wt.__SENTRY_LOADER__?Wt.apply(this,arguments):!1},ie.onerror.__SENTRY_INSTRUMENTED__=!0}let Bt=null;function ll(e){const t="unhandledrejection";Ge(t,e),ze(t,dl)}function dl(){Bt=ie.onunhandledrejection,ie.onunhandledrejection=function(e){return Ie("unhandledrejection",e),Bt&&!Bt.__SENTRY_LOADER__?Bt.apply(this,arguments):!0},ie.onunhandledrejection.__SENTRY_INSTRUMENTED__=!0}const Gt=xr();function ul(){const e=Gt.chrome,t=e&&e.app&&e.app.runtime,n="history"in Gt&&!!Gt.history.pushState&&!!Gt.history.replaceState;return!t&&n}const mt=ie;let zt;function $s(e){const t="history";Ge(t,e),ze(t,pl)}function pl(){if(!ul())return;const e=mt.onpopstate;mt.onpopstate=function(...n){const r=mt.location.href,s=zt;if(zt=r,Ie("history",{from:s,to:r}),e)try{return e.apply(this,n)}catch{}};function t(n){return function(...r){const s=r.length>2?r[2]:void 0;if(s){const a=zt,c=String(s);zt=c,Ie("history",{from:a,to:c})}return n.apply(this,r)}}se(mt.history,"pushState",t),se(mt.history,"replaceState",t)}const gl=ie,ft="__sentry_xhr_v3__";function hl(e){const t="xhr";Ge(t,e),ze(t,ml)}function ml(){if(!gl.XMLHttpRequest)return;const e=XMLHttpRequest.prototype;se(e,"open",function(t){return function(...n){const r=Date.now(),s=He(n[0])?n[0].toUpperCase():void 0,a=fl(n[1]);if(!s||!a)return t.apply(this,n);this[ft]={method:s,url:a,request_headers:{}},s==="POST"&&a.match(/sentry_key/)&&(this.__sentry_own_request__=!0);const c=()=>{const i=this[ft];if(i&&this.readyState===4){try{i.status_code=this.status}catch{}const d={args:[s,a],endTimestamp:Date.now(),startTimestamp:r,xhr:this};Ie("xhr",d)}};return"onreadystatechange"in this&&typeof this.onreadystatechange=="function"?se(this,"onreadystatechange",function(i){return function(...d){return c(),i.apply(this,d)}}):this.addEventListener("readystatechange",c),se(this,"setRequestHeader",function(i){return function(...d){const[u,h]=d,_=this[ft];return _&&He(u)&&He(h)&&(_.request_headers[u.toLowerCase()]=h),i.apply(this,d)}}),t.apply(this,n)}}),se(e,"send",function(t){return function(...n){const r=this[ft];if(!r)return t.apply(this,n);n[0]!==void 0&&(r.body=n[0]);const s={args:[r.method,r.url],startTimestamp:Date.now(),xhr:this};return Ie("xhr",s),t.apply(this,n)}})}function fl(e){if(He(e))return e;try{return e.toString()}catch{}}function yl(){return"npm"}function _l(e){const t=[];function n(){return e===void 0||t.length<e}function r(c){return t.splice(t.indexOf(c),1)[0]}function s(c){if(!n())return un(new De("Not adding Promise because buffer limit was reached."));const i=c();return t.indexOf(i)===-1&&t.push(i),i.then(()=>r(i)).then(null,()=>r(i).then(null,()=>{})),i}function a(c){return new pn((i,d)=>{let u=t.length;if(!u)return i(!0);const h=setTimeout(()=>{c&&c>0&&i(!1)},c);t.forEach(_=>{Je(_).then(()=>{--u||(clearTimeout(h),i(!0))},d)})})}return{$:t,add:s,drain:a}}function Vn(e){if(!e)return{};const t=e.match(/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?$/);if(!t)return{};const n=t[6]||"",r=t[8]||"";return{host:t[4],path:t[5],protocol:t[2],search:n,hash:r,relative:t[5]+n+r}}const bl=["fatal","error","warning","log","info","debug"];function vl(e){return e==="warn"?"warning":bl.includes(e)?e:"log"}function Ze(e,t=[]){return[e,t]}function wl(e,t){const[n,r]=e;return[n,[...r,t]]}function js(e,t){const n=e[1];for(const r of n){const s=r[0].type;if(t(r,s))return!0}return!1}function Hn(e,t){return(t||new TextEncoder).encode(e)}function Sl(e,t){const[n,r]=e;let s=JSON.stringify(n);function a(c){typeof s=="string"?s=typeof c=="string"?s+c:[Hn(s,t),c]:s.push(typeof c=="string"?Hn(c,t):c)}for(const c of r){const[i,d]=c;if(a(`
${JSON.stringify(i)}
`),typeof d=="string"||d instanceof Uint8Array)a(d);else{let u;try{u=JSON.stringify(d)}catch{u=JSON.stringify(yo(d))}a(u)}}return typeof s=="string"?s:El(s)}function El(e){const t=e.reduce((s,a)=>s+a.length,0),n=new Uint8Array(t);let r=0;for(const s of e)n.set(s,r),r+=s.length;return n}function Tl(e,t){const n=typeof e.data=="string"?Hn(e.data,t):e.data;return[Ar({type:"attachment",length:n.length,filename:e.filename,content_type:e.contentType,attachment_type:e.attachmentType}),n]}const Il={session:"session",sessions:"session",attachment:"attachment",transaction:"transaction",event:"error",client_report:"internal",user_report:"default",profile:"profile",replay_event:"replay",replay_recording:"replay",check_in:"monitor",feedback:"feedback",span:"span",statsd:"metric_bucket"};function qs(e){return Il[e]}function Ws(e){if(!e||!e.sdk)return;const{name:t,version:n}=e.sdk;return{name:t,version:n}}function kl(e,t,n,r){const s=e.sdkProcessingMetadata&&e.sdkProcessingMetadata.dynamicSamplingContext;return{event_id:e.event_id,sent_at:new Date().toISOString(),...t&&{sdk:t},...!!n&&r&&{dsn:ht(r)},...s&&{trace:Ar({...s})}}}function Cl(e,t,n){const r=[{type:"client_report"},{timestamp:n||_o(),discarded_events:e}];return Ze(t?{dsn:t}:{},[r])}const Ol=60*1e3;function Rl(e,t=Date.now()){const n=parseInt(`${e}`,10);if(!isNaN(n))return n*1e3;const r=Date.parse(`${e}`);return isNaN(r)?Ol:r-t}function Dl(e,t){return e[t]||e.all||0}function xl(e,t,n=Date.now()){return Dl(e,t)>n}function Al(e,{statusCode:t,headers:n},r=Date.now()){const s={...e},a=n&&n["x-sentry-rate-limits"],c=n&&n["retry-after"];if(a)for(const i of a.trim().split(",")){const[d,u,,,h]=i.split(":",5),_=parseInt(d,10),b=(isNaN(_)?60:_)*1e3;if(!u)s.all=r+b;else for(const E of u.split(";"))E==="metric_bucket"?(!h||h.split(";").includes("custom"))&&(s[E]=r+b):s[E]=r+b}else c?s.all=r+Rl(c,r):t===429&&(s.all=r+60*1e3);return s}function Pl(e,t){return t&&(e.sdk=e.sdk||{},e.sdk.name=e.sdk.name||t.name,e.sdk.version=e.sdk.version||t.version,e.sdk.integrations=[...e.sdk.integrations||[],...t.integrations||[]],e.sdk.packages=[...e.sdk.packages||[],...t.packages||[]]),e}function Ll(e,t,n,r){const s=Ws(n),a={sent_at:new Date().toISOString(),...s&&{sdk:s},...!!r&&t&&{dsn:ht(t)}},c="aggregates"in e?[{type:"sessions"},e]:[{type:"session"},e.toJSON()];return Ze(a,[c])}function Nl(e,t,n,r){const s=Ws(n),a=e.type&&e.type!=="replay_event"?e.type:"event";Pl(e,n&&n.sdk);const c=kl(e,s,r,t);return delete e.sdkProcessingMetadata,Ze(c,[[{type:a},e]])}const Fl="7";function Ul(e){const t=e.protocol?`${e.protocol}:`:"",n=e.port?`:${e.port}`:"";return`${t}//${e.host}${n}${e.path?`/${e.path}`:""}/api/`}function Ml(e){return`${Ul(e)}${e.projectId}/envelope/`}function $l(e,t){return bo({sentry_key:e.publicKey,sentry_version:Fl,...t&&{sentry_client:`${t.name}/${t.version}`}})}function jl(e,t={}){const n=typeof t=="string"?t:t.tunnel,r=typeof t=="string"||!t._metadata?void 0:t._metadata.sdk;return n||`${Ml(e)}?${$l(e,r)}`}const Bs=[];function ql(e){const t={};return e.forEach(n=>{const{name:r}=n,s=t[r];s&&!s.isDefaultInstance&&n.isDefaultInstance||(t[r]=n)}),Object.keys(t).map(n=>t[n])}function Wl(e){const t=e.defaultIntegrations||[],n=e.integrations;t.forEach(c=>{c.isDefaultInstance=!0});let r;Array.isArray(n)?r=[...t,...n]:typeof n=="function"?r=vo(n(t)):r=t;const s=ql(r),a=Gl(s,c=>c.name==="Debug");if(a!==-1){const[c]=s.splice(a,1);s.push(c)}return s}function Bl(e,t){const n={};return t.forEach(r=>{r&&zs(e,r,n)}),n}function Gs(e,t){for(const n of t)n&&n.afterAllSetup&&n.afterAllSetup(e)}function zs(e,t,n){if(n[t.name]){B&&x.log(`Integration skipped because it was already installed: ${t.name}`);return}if(n[t.name]=t,Bs.indexOf(t.name)===-1&&(t.setupOnce(wo,Pr),Bs.push(t.name)),t.setup&&typeof t.setup=="function"&&t.setup(e),e.on&&typeof t.preprocessEvent=="function"){const r=t.preprocessEvent.bind(t);e.on("preprocessEvent",(s,a)=>r(s,a,e))}if(e.addEventProcessor&&typeof t.processEvent=="function"){const r=t.processEvent.bind(t),s=Object.assign((a,c)=>r(a,c,e),{id:t.name});e.addEventProcessor(s)}B&&x.log(`Integration installed: ${t.name}`)}function Gl(e,t){for(let n=0;n<e.length;n++)if(t(e[n])===!0)return n;return-1}function Me(e,t){return Object.assign(function(...n){return t(...n)},{id:e})}function zl(e){let t="";for(const n of e){const r=Object.entries(n.tags),s=r.length>0?`|#${r.map(([a,c])=>`${a}:${c}`).join(",")}`:"";t+=`${n.name}@${n.unit}:${n.metric}|${n.metricType}${s}|T${n.timestamp}
`}return t}function Vl(e,t,n,r){const s={sent_at:new Date().toISOString()};n&&n.sdk&&(s.sdk={name:n.sdk.name,version:n.sdk.version}),r&&t&&(s.dsn=ht(t));const a=Hl(e);return Ze(s,[a])}function Hl(e){const t=zl(e);return[{type:"statsd",length:t.length},t]}const Vs="Not capturing exception because it's already been captured.";class Jl{constructor(t){if(this._options=t,this._integrations={},this._integrationsInitialized=!1,this._numProcessing=0,this._outcomes={},this._hooks={},this._eventProcessors=[],t.dsn?this._dsn=Jc(t.dsn):B&&x.warn("No DSN provided, client will not send events."),this._dsn){const n=jl(this._dsn,t);this._transport=t.transport({tunnel:this._options.tunnel,recordDroppedEvent:this.recordDroppedEvent.bind(this),...t.transportOptions,url:n})}}captureException(t,n,r){if(Lr(t)){B&&x.log(Vs);return}let s=n&&n.event_id;return this._process(this.eventFromException(t,n).then(a=>this._captureEvent(a,n,r)).then(a=>{s=a})),s}captureMessage(t,n,r,s){let a=r&&r.event_id;const c=Fr(t)?t:String(t),i=gn(t)?this.eventFromMessage(c,n,r):this.eventFromException(t,r);return this._process(i.then(d=>this._captureEvent(d,r,s)).then(d=>{a=d})),a}captureEvent(t,n,r){if(n&&n.originalException&&Lr(n.originalException)){B&&x.log(Vs);return}let s=n&&n.event_id;const a=(t.sdkProcessingMetadata||{}).capturedSpanScope;return this._process(this._captureEvent(t,n,a||r).then(c=>{s=c})),s}captureSession(t){typeof t.release!="string"?B&&x.warn("Discarded session because of missing or non-string release"):(this.sendSession(t),Nr(t,{init:!1}))}getDsn(){return this._dsn}getOptions(){return this._options}getSdkMetadata(){return this._options._metadata}getTransport(){return this._transport}flush(t){const n=this._transport;return n?(this.metricsAggregator&&this.metricsAggregator.flush(),this._isClientDoneProcessing(t).then(r=>n.flush(t).then(s=>r&&s))):Je(!0)}close(t){return this.flush(t).then(n=>(this.getOptions().enabled=!1,this.metricsAggregator&&this.metricsAggregator.close(),n))}getEventProcessors(){return this._eventProcessors}addEventProcessor(t){this._eventProcessors.push(t)}setupIntegrations(t){(t&&!this._integrationsInitialized||this._isEnabled()&&!this._integrationsInitialized)&&this._setupIntegrations()}init(){this._isEnabled()&&this._setupIntegrations()}getIntegrationById(t){return this.getIntegrationByName(t)}getIntegrationByName(t){return this._integrations[t]}getIntegration(t){try{return this._integrations[t.id]||null}catch{return B&&x.warn(`Cannot retrieve integration ${t.id} from the current Client`),null}}addIntegration(t){const n=this._integrations[t.name];zs(this,t,this._integrations),n||Gs(this,[t])}sendEvent(t,n={}){this.emit("beforeSendEvent",t,n);let r=Nl(t,this._dsn,this._options._metadata,this._options.tunnel);for(const a of n.attachments||[])r=wl(r,Tl(a,this._options.transportOptions&&this._options.transportOptions.textEncoder));const s=this._sendEnvelope(r);s&&s.then(a=>this.emit("afterSendEvent",t,a),null)}sendSession(t){const n=Ll(t,this._dsn,this._options._metadata,this._options.tunnel);this._sendEnvelope(n)}recordDroppedEvent(t,n,r){if(this._options.sendClientReports){const s=typeof r=="number"?r:1,a=`${t}:${n}`;B&&x.log(`Recording outcome: "${a}"${s>1?` (${s} times)`:""}`),this._outcomes[a]=(this._outcomes[a]||0)+s}}captureAggregateMetrics(t){B&&x.log(`Flushing aggregated metrics, number of metrics: ${t.length}`);const n=Vl(t,this._dsn,this._options._metadata,this._options.tunnel);this._sendEnvelope(n)}on(t,n){this._hooks[t]||(this._hooks[t]=[]),this._hooks[t].push(n)}emit(t,...n){this._hooks[t]&&this._hooks[t].forEach(r=>r(...n))}_setupIntegrations(){const{integrations:t}=this._options;this._integrations=Bl(this,t),Gs(this,t),this._integrationsInitialized=!0}_updateSessionFromEvent(t,n){let r=!1,s=!1;const a=n.exception&&n.exception.values;if(a){s=!0;for(const i of a){const d=i.mechanism;if(d&&d.handled===!1){r=!0;break}}}const c=t.status==="ok";(c&&t.errors===0||c&&r)&&(Nr(t,{...r&&{status:"crashed"},errors:t.errors||Number(s||r)}),this.captureSession(t))}_isClientDoneProcessing(t){return new pn(n=>{let r=0;const s=1,a=setInterval(()=>{this._numProcessing==0?(clearInterval(a),n(!0)):(r+=s,t&&r>=t&&(clearInterval(a),n(!1)))},s)})}_isEnabled(){return this.getOptions().enabled!==!1&&this._transport!==void 0}_prepareEvent(t,n,r,s=To()){const a=this.getOptions(),c=Object.keys(this._integrations);return!n.integrations&&c.length>0&&(n.integrations=c),this.emit("preprocessEvent",t,n),So(a,t,n,r,this,s).then(i=>{if(i===null)return i;const d={...s.getPropagationContext(),...r?r.getPropagationContext():void 0};if(!(i.contexts&&i.contexts.trace)&&d){const{traceId:u,spanId:h,parentSpanId:_,dsc:b}=d;i.contexts={trace:{trace_id:u,span_id:h,parent_span_id:_},...i.contexts};const E=b||Eo(u,this,r);i.sdkProcessingMetadata={dynamicSamplingContext:E,...i.sdkProcessingMetadata}}return i})}_captureEvent(t,n={},r){return this._processEvent(t,n,r).then(s=>s.event_id,s=>{if(B){const a=s;a.logLevel==="log"?x.log(a.message):x.warn(a)}})}_processEvent(t,n,r){const s=this.getOptions(),{sampleRate:a}=s,c=Js(t),i=Hs(t),d=t.type||"error",u=`before send for type \`${d}\``;if(i&&typeof a=="number"&&Math.random()>a)return this.recordDroppedEvent("sample_rate","error",t),un(new De(`Discarding event because it's not included in the random sample (sampling rate = ${a})`,"log"));const h=d==="replay_event"?"replay":d,_=(t.sdkProcessingMetadata||{}).capturedSpanIsolationScope;return this._prepareEvent(t,n,r,_).then(b=>{if(b===null)throw this.recordDroppedEvent("event_processor",h,t),new De("An event processor returned `null`, will not send event.","log");if(n.data&&n.data.__sentry__===!0)return b;const E=Yl(s,b,n);return Kl(E,u)}).then(b=>{if(b===null){if(this.recordDroppedEvent("before_send",h,t),c){const T=1+(t.spans||[]).length;this.recordDroppedEvent("before_send","span",T)}throw new De(`${u} returned \`null\`, will not send event.`,"log")}const E=r&&r.getSession();if(!c&&E&&this._updateSessionFromEvent(E,b),c){const T=b.sdkProcessingMetadata&&b.sdkProcessingMetadata.spanCountBeforeProcessing||0,R=b.spans?b.spans.length:0,P=T-R;P>0&&this.recordDroppedEvent("before_send","span",P)}const O=b.transaction_info;if(c&&O&&b.transaction!==t.transaction){const T="custom";b.transaction_info={...O,source:T}}return this.sendEvent(b,n),b}).then(null,b=>{throw b instanceof De?b:(this.captureException(b,{data:{__sentry__:!0},originalException:b}),new De(`Event processing pipeline threw an error, original event will not be sent. Details have been sent as a new event.
Reason: ${b}`))})}_process(t){this._numProcessing++,t.then(n=>(this._numProcessing--,n),n=>(this._numProcessing--,n))}_sendEnvelope(t){if(this.emit("beforeEnvelope",t),this._isEnabled()&&this._transport)return this._transport.send(t).then(null,n=>{B&&x.error("Error while sending event:",n)});B&&x.error("Transport disabled")}_clearOutcomes(){const t=this._outcomes;return this._outcomes={},Object.keys(t).map(n=>{const[r,s]=n.split(":");return{reason:r,category:s,quantity:t[n]}})}}function Kl(e,t){const n=`${t} must return \`null\` or a valid event.`;if(Io(e))return e.then(r=>{if(!hn(r)&&r!==null)throw new De(n);return r},r=>{throw new De(`${t} rejected with ${r}`)});if(!hn(e)&&e!==null)throw new De(n);return e}function Yl(e,t,n){const{beforeSend:r,beforeSendTransaction:s}=e;if(Hs(t)&&r)return r(t,n);if(Js(t)&&s){if(t.spans){const a=t.spans.length;t.sdkProcessingMetadata={...t.sdkProcessingMetadata,spanCountBeforeProcessing:a}}return s(t,n)}return t}function Hs(e){return e.type===void 0}function Js(e){return e.type==="transaction"}function Xl(e,t){t.debug===!0&&(B?x.enable():Rr(()=>{console.warn("[Sentry] Cannot initialize SDK with `debug` option using a non-debug bundle.")})),ko().update(t.initialScope);const n=new e(t);Ql(n),Zl(n)}function Ql(e){const t=Pr().getStackTop();t.client=e,t.scope.setClient(e)}function Zl(e){e.init?e.init():e.setupIntegrations&&e.setupIntegrations()}const ed=30;function Ks(e,t,n=_l(e.bufferSize||ed)){let r={};const s=c=>n.drain(c);function a(c){const i=[];if(js(c,(_,b)=>{const E=qs(b);if(xl(r,E)){const O=Ys(_,b);e.recordDroppedEvent("ratelimit_backoff",E,O)}else i.push(_)}),i.length===0)return Je();const d=Ze(c[0],i),u=_=>{js(d,(b,E)=>{const O=Ys(b,E);e.recordDroppedEvent(_,qs(E),O)})},h=()=>t({body:Sl(d,e.textEncoder)}).then(_=>(_.statusCode!==void 0&&(_.statusCode<200||_.statusCode>=300)&&B&&x.warn(`Sentry responded with status code ${_.statusCode} to sent event.`),r=Al(r,_),_),_=>{throw u("network_error"),_});return n.add(h).then(_=>_,_=>{if(_ instanceof De)return B&&x.error("Skipped sending event because buffer is full."),u("queue_overflow"),Je();throw _})}return a.__sentry__baseTransport__=!0,{send:a,flush:s}}function Ys(e,t){if(!(t!=="event"&&t!=="transaction"))return Array.isArray(e)?e[1]:void 0}function td(e,t,n=[t],r="npm"){const s=e._metadata||{};s.sdk||(s.sdk={name:`sentry.javascript.${t}`,packages:n.map(a=>({name:`${r}:@sentry/${a}`,version:Ur})),version:Ur}),e._metadata=s}const nd=[/^Script error\.?$/,/^Javascript error: Script error\.? on line 0$/,/^ResizeObserver loop completed with undelivered notifications.$/,/^Cannot redefine property: googletag$/],rd=[/^.*\/healthcheck$/,/^.*\/healthy$/,/^.*\/live$/,/^.*\/ready$/,/^.*\/heartbeat$/,/^.*\/health$/,/^.*\/healthz$/],Xs="InboundFilters",sd=(e={})=>({name:Xs,setupOnce(){},processEvent(t,n,r){const s=r.getOptions(),a=ad(e,s);return od(t,a)?null:t}}),Qs=sd;Me(Xs,Qs);function ad(e={},t={}){return{allowUrls:[...e.allowUrls||[],...t.allowUrls||[]],denyUrls:[...e.denyUrls||[],...t.denyUrls||[]],ignoreErrors:[...e.ignoreErrors||[],...t.ignoreErrors||[],...e.disableErrorDefaults?[]:nd],ignoreTransactions:[...e.ignoreTransactions||[],...t.ignoreTransactions||[],...e.disableTransactionDefaults?[]:rd],ignoreInternal:e.ignoreInternal!==void 0?e.ignoreInternal:!0}}function od(e,t){return t.ignoreInternal&&pd(e)?(B&&x.warn(`Event dropped due to being internal Sentry Error.
Event: ${Ne(e)}`),!0):id(e,t.ignoreErrors)?(B&&x.warn(`Event dropped due to being matched by \`ignoreErrors\` option.
Event: ${Ne(e)}`),!0):cd(e,t.ignoreTransactions)?(B&&x.warn(`Event dropped due to being matched by \`ignoreTransactions\` option.
Event: ${Ne(e)}`),!0):ld(e,t.denyUrls)?(B&&x.warn(`Event dropped due to being matched by \`denyUrls\` option.
Event: ${Ne(e)}.
Url: ${Vt(e)}`),!0):dd(e,t.allowUrls)?!1:(B&&x.warn(`Event dropped due to not being matched by \`allowUrls\` option.
Event: ${Ne(e)}.
Url: ${Vt(e)}`),!0)}function id(e,t){return e.type||!t||!t.length?!1:ud(e).some(n=>Ct(n,t))}function cd(e,t){if(e.type!=="transaction"||!t||!t.length)return!1;const n=e.transaction;return n?Ct(n,t):!1}function ld(e,t){if(!t||!t.length)return!1;const n=Vt(e);return n?Ct(n,t):!1}function dd(e,t){if(!t||!t.length)return!0;const n=Vt(e);return n?Ct(n,t):!0}function ud(e){const t=[];e.message&&t.push(e.message);let n;try{n=e.exception.values[e.exception.values.length-1]}catch{}return n&&n.value&&(t.push(n.value),n.type&&t.push(`${n.type}: ${n.value}`)),B&&t.length===0&&x.error(`Could not extract message for event ${Ne(e)}`),t}function pd(e){try{return e.exception.values[0].type==="SentryError"}catch{}return!1}function gd(e=[]){for(let t=e.length-1;t>=0;t--){const n=e[t];if(n&&n.filename!=="<anonymous>"&&n.filename!=="[native code]")return n.filename||null}return null}function Vt(e){try{let t;try{t=e.exception.values[0].stacktrace.frames}catch{}return t?gd(t):null}catch{return B&&x.error(`Cannot extract url for event ${Ne(e)}`),null}}let Zs;const ea="FunctionToString",ta=new WeakMap,hd=()=>({name:ea,setupOnce(){Zs=Function.prototype.toString;try{Function.prototype.toString=function(...e){const t=mn(this),n=ta.has(Se())&&t!==void 0?t:this;return Zs.apply(n,e)}}catch{}},setup(e){ta.set(e,!0)}}),na=hd;Me(ea,na);const N=ie;let Jn=0;function ra(){return Jn>0}function md(){Jn++,setTimeout(()=>{Jn--})}function et(e,t={},n){if(typeof e!="function")return e;try{const s=e.__sentry_wrapped__;if(s)return typeof s=="function"?s:e;if(mn(e))return e}catch{return e}const r=function(){const s=Array.prototype.slice.call(arguments);try{n&&typeof n=="function"&&n.apply(this,arguments);const a=s.map(c=>et(c,t));return e.apply(this,a)}catch(a){throw md(),Oo(c=>{c.addEventProcessor(i=>(t.mechanism&&(fn(i,void 0,void 0),Ot(i,t.mechanism)),i.extra={...i.extra,arguments:s},i)),$(a)}),a}};try{for(const s in e)Object.prototype.hasOwnProperty.call(e,s)&&(r[s]=e[s])}catch{}Co(r,e),dn(e,"__sentry_wrapped__",r);try{Object.getOwnPropertyDescriptor(r,"name").configurable&&Object.defineProperty(r,"name",{get(){return e.name}})}catch{}return r}const Pe=typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__;function sa(e,t){const n=Yn(e,t),r={type:t&&t.name,value:bd(t)};return n.length&&(r.stacktrace={frames:n}),r.type===void 0&&r.value===""&&(r.value="Unrecoverable error caught"),r}function fd(e,t,n,r){const s=Se(),a=s&&s.getOptions().normalizeDepth,c={exception:{values:[{type:_n(t)?t.constructor.name:r?"UnhandledRejection":"Error",value:Sd(t,{isUnhandledRejection:r})}]},extra:{__serialized__:xo(t,a)}};if(n){const i=Yn(e,n);i.length&&(c.exception.values[0].stacktrace={frames:i})}return c}function Kn(e,t){return{exception:{values:[sa(e,t)]}}}function Yn(e,t){const n=t.stacktrace||t.stack||"",r=_d(t);try{return e(n,r)}catch{}return[]}const yd=/Minified React error #\d+;/i;function _d(e){if(e){if(typeof e.framesToPop=="number")return e.framesToPop;if(yd.test(e.message))return 1}return 0}function bd(e){const t=e&&e.message;return t?t.error&&typeof t.error.message=="string"?t.error.message:t:"No error message"}function vd(e,t,n,r){const s=n&&n.syntheticException||void 0,a=Xn(e,t,s,r);return Ot(a),a.level="error",n&&n.event_id&&(a.event_id=n.event_id),Je(a)}function wd(e,t,n="info",r,s){const a=r&&r.syntheticException||void 0,c=Qn(e,t,a,s);return c.level=n,r&&r.event_id&&(c.event_id=r.event_id),Je(c)}function Xn(e,t,n,r,s){let a;if(yn(t)&&t.error)return Kn(e,t.error);if(Mr(t)||Ro(t)){const c=t;if("stack"in t)a=Kn(e,t);else{const i=c.name||(Mr(c)?"DOMError":"DOMException"),d=c.message?`${i}: ${c.message}`:i;a=Qn(e,d,n,r),fn(a,d)}return"code"in c&&(a.tags={...a.tags,"DOMException.code":`${c.code}`}),a}return Do(t)?Kn(e,t):hn(t)||_n(t)?(a=fd(e,t,n,s),Ot(a,{synthetic:!0}),a):(a=Qn(e,t,n,r),fn(a,`${t}`,void 0),Ot(a,{synthetic:!0}),a)}function Qn(e,t,n,r){const s={};if(r&&n){const a=Yn(e,n);a.length&&(s.exception={values:[{value:t,stacktrace:{frames:a}}]})}if(Fr(t)){const{__sentry_template_string__:a,__sentry_template_values__:c}=t;return s.logentry={message:a,params:c},s}return s.message=t,s}function Sd(e,{isUnhandledRejection:t}){const n=Ao(e),r=t?"promise rejection":"exception";return yn(e)?`Event \`ErrorEvent\` captured as ${r} with message \`${e.message}\``:_n(e)?`Event \`${Ed(e)}\` (type=${e.type}) captured as ${r}`:`Object captured as ${r} with keys: ${n}`}function Ed(e){try{const t=Object.getPrototypeOf(e);return t?t.constructor.name:void 0}catch{}}function Td(e,{metadata:t,tunnel:n,dsn:r}){const s={event_id:e.event_id,sent_at:new Date().toISOString(),...t&&t.sdk&&{sdk:{name:t.sdk.name,version:t.sdk.version}},...!!n&&!!r&&{dsn:ht(r)}},a=Id(e);return Ze(s,[a])}function Id(e){return[{type:"user_report"},e]}class kd extends Jl{constructor(t){const n=N.SENTRY_SDK_SOURCE||yl();td(t,"browser",["browser"],n),super(t),t.sendClientReports&&N.document&&N.document.addEventListener("visibilitychange",()=>{N.document.visibilityState==="hidden"&&this._flushOutcomes()})}eventFromException(t,n){return vd(this._options.stackParser,t,n,this._options.attachStacktrace)}eventFromMessage(t,n="info",r){return wd(this._options.stackParser,t,n,r,this._options.attachStacktrace)}captureUserFeedback(t){if(!this._isEnabled()){Pe&&x.warn("SDK not enabled, will not capture user feedback.");return}const n=Td(t,{metadata:this.getSdkMetadata(),dsn:this.getDsn(),tunnel:this.getOptions().tunnel});this._sendEnvelope(n)}_prepareEvent(t,n,r){return t.platform=t.platform||"javascript",super._prepareEvent(t,n,r)}_flushOutcomes(){const t=this._clearOutcomes();if(t.length===0){Pe&&x.log("No outcomes to send");return}if(!this._dsn){Pe&&x.log("No dsn provided, will not send outcomes");return}Pe&&x.log("Sending outcomes:",t);const n=Cl(t,this._options.tunnel&&ht(this._dsn));this._sendEnvelope(n)}}let yt;function Cd(){if(yt)return yt;if(Gn(N.fetch))return yt=N.fetch.bind(N);const e=N.document;let t=N.fetch;if(e&&typeof e.createElement=="function")try{const n=e.createElement("iframe");n.hidden=!0,e.head.appendChild(n);const r=n.contentWindow;r&&r.fetch&&(t=r.fetch),e.head.removeChild(n)}catch(n){Pe&&x.warn("Could not create sandbox iframe for pure fetch check, bailing to window.fetch: ",n)}return yt=t.bind(N)}function Od(){yt=void 0}function Rd(e,t=Cd()){let n=0,r=0;function s(a){const c=a.body.length;n+=c,r++;const i={body:a.body,method:"POST",referrerPolicy:"origin",headers:e.headers,keepalive:n<=6e4&&r<15,...e.fetchOptions};try{return t(e.url,i).then(d=>(n-=c,r--,{statusCode:d.status,headers:{"x-sentry-rate-limits":d.headers.get("X-Sentry-Rate-Limits"),"retry-after":d.headers.get("Retry-After")}}))}catch(d){return Od(),n-=c,r--,un(d)}}return Ks(e,s)}const Dd=4;function xd(e){function t(n){return new pn((r,s)=>{const a=new XMLHttpRequest;a.onerror=s,a.onreadystatechange=()=>{a.readyState===Dd&&r({statusCode:a.status,headers:{"x-sentry-rate-limits":a.getResponseHeader("X-Sentry-Rate-Limits"),"retry-after":a.getResponseHeader("Retry-After")}})},a.open("POST",e.url);for(const c in e.headers)Object.prototype.hasOwnProperty.call(e.headers,c)&&a.setRequestHeader(c,e.headers[c]);a.send(n.body)})}return Ks(e,t)}const Ht="?",Ad=30,Pd=40,Ld=50;function Zn(e,t,n,r){const s={filename:e,function:t,in_app:!0};return n!==void 0&&(s.lineno=n),r!==void 0&&(s.colno=r),s}const Nd=/^\s*at (?:(.+?\)(?: \[.+\])?|.*?) ?\((?:address at )?)?(?:async )?((?:<anonymous>|[-a-z]+:|.*bundle|\/)?.*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,Fd=/\((\S*)(?::(\d+))(?::(\d+))\)/,Ud=e=>{const t=Nd.exec(e);if(t){if(t[2]&&t[2].indexOf("eval")===0){const s=Fd.exec(t[2]);s&&(t[2]=s[1],t[3]=s[2],t[4]=s[3])}const[n,r]=aa(t[1]||Ht,t[2]);return Zn(r,n,t[3]?+t[3]:void 0,t[4]?+t[4]:void 0)}},Md=[Ad,Ud],$d=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)?((?:[-a-z]+)?:\/.*?|\[native code\]|[^@]*(?:bundle|\d+\.js)|\/[\w\-. /=]+)(?::(\d+))?(?::(\d+))?\s*$/i,jd=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i,qd=e=>{const t=$d.exec(e);if(t){if(t[3]&&t[3].indexOf(" > eval")>-1){const s=jd.exec(t[3]);s&&(t[1]=t[1]||"eval",t[3]=s[1],t[4]=s[2],t[5]="")}let n=t[3],r=t[1]||Ht;return[r,n]=aa(r,n),Zn(n,r,t[4]?+t[4]:void 0,t[5]?+t[5]:void 0)}},Wd=[Ld,qd],Bd=/^\s*at (?:((?:\[object object\])?.+) )?\(?((?:[-a-z]+):.*?):(\d+)(?::(\d+))?\)?\s*$/i,Gd=e=>{const t=Bd.exec(e);return t?Zn(t[2],t[1]||Ht,+t[3],t[4]?+t[4]:void 0):void 0},zd=[Pd,Gd],Vd=[Md,Wd,zd],Hd=Po(...Vd),aa=(e,t)=>{const n=e.indexOf("safari-extension")!==-1,r=e.indexOf("safari-web-extension")!==-1;return n||r?[e.indexOf("@")!==-1?e.split("@")[0]:Ht,n?`safari-extension:${t}`:`safari-web-extension:${t}`]:[e,t]},Jt=1024,oa="Breadcrumbs",Jd=(e={})=>{const t={console:!0,dom:!0,fetch:!0,history:!0,sentry:!0,xhr:!0,...e};return{name:oa,setupOnce(){},setup(n){t.console&&Kc(Xd(n)),t.dom&&Qc(Yd(n,t.dom)),t.xhr&&hl(Qd(n)),t.fetch&&sl(Zd(n)),t.history&&$s(eu(n)),t.sentry&&n.on&&n.on("beforeSendEvent",Kd(n))}}},ia=Jd;Me(oa,ia);function Kd(e){return function(t){Se()===e&&I({category:`sentry.${t.type==="transaction"?"transaction":"event"}`,event_id:t.event_id,level:t.level,message:Ne(t)},{event:t})}}function Yd(e,t){return function(n){if(Se()!==e)return;let r,s,a=typeof t=="object"?t.serializeAttribute:void 0,c=typeof t=="object"&&typeof t.maxStringLength=="number"?t.maxStringLength:void 0;c&&c>Jt&&(Pe&&x.warn(`\`dom.maxStringLength\` cannot exceed ${Jt}, but a value of ${c} was configured. Sentry will use ${Jt} instead.`),c=Jt),typeof a=="string"&&(a=[a]);try{const d=n.event,u=tu(d)?d.target:d;r=Lo(u,{keyAttrs:a,maxStringLength:c}),s=No(u)}catch{r="<unknown>"}if(r.length===0)return;const i={category:`ui.${n.name}`,message:r};s&&(i.data={"ui.component_name":s}),I(i,{event:n.event,name:n.name,global:n.global})}}function Xd(e){return function(t){if(Se()!==e)return;const n={category:"console",data:{arguments:t.args,logger:"console"},level:vl(t.level),message:$r(t.args," ")};if(t.level==="assert")if(t.args[0]===!1)n.message=`Assertion failed: ${$r(t.args.slice(1)," ")||"console.assert"}`,n.data.arguments=t.args.slice(1);else return;I(n,{input:t.args,level:t.level})}}function Qd(e){return function(t){if(Se()!==e)return;const{startTimestamp:n,endTimestamp:r}=t,s=t.xhr[ft];if(!n||!r||!s)return;const{method:a,url:c,status_code:i,body:d}=s,u={method:a,url:c,status_code:i},h={xhr:t.xhr,input:d,startTimestamp:n,endTimestamp:r};I({category:"xhr",data:u,type:"http"},h)}}function Zd(e){return function(t){if(Se()!==e)return;const{startTimestamp:n,endTimestamp:r}=t;if(r&&!(t.fetchData.url.match(/sentry_key/)&&t.fetchData.method==="POST"))if(t.error){const s=t.fetchData,a={data:t.error,input:t.args,startTimestamp:n,endTimestamp:r};I({category:"fetch",data:s,level:"error",type:"http"},a)}else{const s=t.response,a={...t.fetchData,status_code:s&&s.status},c={input:t.args,response:s,startTimestamp:n,endTimestamp:r};I({category:"fetch",data:a,type:"http"},c)}}}function eu(e){return function(t){if(Se()!==e)return;let n=t.from,r=t.to;const s=Vn(N.location.href);let a=n?Vn(n):void 0;const c=Vn(r);(!a||!a.path)&&(a=s),s.protocol===c.protocol&&s.host===c.host&&(r=c.relative),s.protocol===a.protocol&&s.host===a.host&&(n=a.relative),I({category:"navigation",data:{from:n,to:r}})}}function tu(e){return!!e&&!!e.target}const ca="Dedupe",nu=()=>{let e;return{name:ca,setupOnce(){},processEvent(t){if(t.type)return t;try{if(ru(t,e))return Pe&&x.warn("Event dropped due to being a duplicate of previously captured event."),null}catch{}return e=t}}},la=nu;Me(ca,la);function ru(e,t){return t?!!(su(e,t)||au(e,t)):!1}function su(e,t){const n=e.message,r=t.message;return!(!n&&!r||n&&!r||!n&&r||n!==r||!ua(e,t)||!da(e,t))}function au(e,t){const n=pa(t),r=pa(e);return!(!n||!r||n.type!==r.type||n.value!==r.value||!ua(e,t)||!da(e,t))}function da(e,t){let n=ga(e),r=ga(t);if(!n&&!r)return!0;if(n&&!r||!n&&r||(n=n,r=r,r.length!==n.length))return!1;for(let s=0;s<r.length;s++){const a=r[s],c=n[s];if(a.filename!==c.filename||a.lineno!==c.lineno||a.colno!==c.colno||a.function!==c.function)return!1}return!0}function ua(e,t){let n=e.fingerprint,r=t.fingerprint;if(!n&&!r)return!0;if(n&&!r||!n&&r)return!1;n=n,r=r;try{return n.join("")===r.join("")}catch{return!1}}function pa(e){return e.exception&&e.exception.values&&e.exception.values[0]}function ga(e){const t=e.exception;if(t)try{return t.values[0].stacktrace.frames}catch{return}}const ha="GlobalHandlers",ou=(e={})=>{const t={onerror:!0,onunhandledrejection:!0,...e};return{name:ha,setupOnce(){Error.stackTraceLimit=50},setup(n){t.onerror&&(iu(n),ya("onerror")),t.onunhandledrejection&&(cu(n),ya("onunhandledrejection"))}}},ma=ou;Me(ha,ma);function iu(e){il(t=>{const{stackParser:n,attachStacktrace:r}=_a();if(Se()!==e||ra())return;const{msg:s,url:a,line:c,column:i,error:d}=t,u=d===void 0&&He(s)?uu(s,a,c,i):fa(Xn(n,d||s,void 0,r,!1),a,c,i);u.level="error",jr(u,{originalException:d,mechanism:{handled:!1,type:"onerror"}})})}function cu(e){ll(t=>{const{stackParser:n,attachStacktrace:r}=_a();if(Se()!==e||ra())return;const s=lu(t),a=gn(s)?du(s):Xn(n,s,void 0,r,!0);a.level="error",jr(a,{originalException:s,mechanism:{handled:!1,type:"onunhandledrejection"}})})}function lu(e){if(gn(e))return e;const t=e;try{if("reason"in t)return t.reason;if("detail"in t&&"reason"in t.detail)return t.detail.reason}catch{}return e}function du(e){return{exception:{values:[{type:"UnhandledRejection",value:`Non-Error promise rejection captured with value: ${String(e)}`}]}}}function uu(e,t,n,r){const s=/^(?:[Uu]ncaught (?:exception: )?)?(?:((?:Eval|Internal|Range|Reference|Syntax|Type|URI|)Error): )?(.*)$/i;let a=yn(e)?e.message:e,c="Error";const i=a.match(s);return i&&(c=i[1],a=i[2]),fa({exception:{values:[{type:c,value:a}]}},t,n,r)}function fa(e,t,n,r){const s=e.exception=e.exception||{},a=s.values=s.values||[],c=a[0]=a[0]||{},i=c.stacktrace=c.stacktrace||{},d=i.frames=i.frames||[],u=isNaN(parseInt(r,10))?void 0:r,h=isNaN(parseInt(n,10))?void 0:n,_=He(t)&&t.length>0?t:Fo();return d.length===0&&d.push({colno:u,filename:_,function:"?",in_app:!0,lineno:h}),e}function ya(e){Pe&&x.log(`Global Handler attached: ${e}`)}function _a(){const e=Se();return e&&e.getOptions()||{stackParser:()=>[],attachStacktrace:!1}}const ba="HttpContext",pu=()=>({name:ba,setupOnce(){},preprocessEvent(e){if(!N.navigator&&!N.location&&!N.document)return;const t=e.request&&e.request.url||N.location&&N.location.href,{referrer:n}=N.document||{},{userAgent:r}=N.navigator||{},s={...e.request&&e.request.headers,...n&&{Referer:n},...r&&{"User-Agent":r}},a={...e.request,...t&&{url:t},headers:s};e.request=a}}),va=pu;Me(ba,va);const gu="cause",hu=5,wa="LinkedErrors",mu=(e={})=>{const t=e.limit||hu,n=e.key||gu;return{name:wa,setupOnce(){},preprocessEvent(r,s,a){const c=a.getOptions();Wc(sa,c.stackParser,c.maxValueLength,n,t,r,s)}}},Sa=mu;Me(wa,Sa);const fu=["EventTarget","Window","Node","ApplicationCache","AudioTrackList","BroadcastChannel","ChannelMergerNode","CryptoOperation","EventSource","FileReader","HTMLUnknownElement","IDBDatabase","IDBRequest","IDBTransaction","KeyOperation","MediaController","MessagePort","ModalWindow","Notification","SVGElementInstance","Screen","SharedWorker","TextTrack","TextTrackCue","TextTrackList","WebSocket","WebSocketWorker","Worker","XMLHttpRequest","XMLHttpRequestEventTarget","XMLHttpRequestUpload"],Ea="TryCatch",yu=(e={})=>{const t={XMLHttpRequest:!0,eventTarget:!0,requestAnimationFrame:!0,setInterval:!0,setTimeout:!0,...e};return{name:Ea,setupOnce(){t.setTimeout&&se(N,"setTimeout",Ia),t.setInterval&&se(N,"setInterval",Ia),t.requestAnimationFrame&&se(N,"requestAnimationFrame",_u),t.XMLHttpRequest&&"XMLHttpRequest"in N&&se(XMLHttpRequest.prototype,"send",bu);const n=t.eventTarget;n&&(Array.isArray(n)?n:fu).forEach(vu)}}},Ta=yu;Me(Ea,Ta);function Ia(e){return function(...t){const n=t[0];return t[0]=et(n,{mechanism:{data:{function:We(e)},handled:!1,type:"instrument"}}),e.apply(this,t)}}function _u(e){return function(t){return e.apply(this,[et(t,{mechanism:{data:{function:"requestAnimationFrame",handler:We(e)},handled:!1,type:"instrument"}})])}}function bu(e){return function(...t){const n=this;return["onload","onerror","onprogress","onreadystatechange"].forEach(r=>{r in n&&typeof n[r]=="function"&&se(n,r,function(s){const a={mechanism:{data:{function:r,handler:We(s)},handled:!1,type:"instrument"}},c=mn(s);return c&&(a.mechanism.data.handler=We(c)),et(s,a)})}),e.apply(this,t)}}function vu(e){const t=N,n=t[e]&&t[e].prototype;!n||!n.hasOwnProperty||!n.hasOwnProperty("addEventListener")||(se(n,"addEventListener",function(r){return function(s,a,c){try{typeof a.handleEvent=="function"&&(a.handleEvent=et(a.handleEvent,{mechanism:{data:{function:"handleEvent",handler:We(a),target:e},handled:!1,type:"instrument"}}))}catch{}return r.apply(this,[s,et(a,{mechanism:{data:{function:"addEventListener",handler:We(a),target:e},handled:!1,type:"instrument"}}),c])}}),se(n,"removeEventListener",function(r){return function(s,a,c){const i=a;try{const d=i&&i.__sentry_wrapped__;d&&r.call(this,s,d,c)}catch{}return r.call(this,s,i,c)}}))}const wu=[Qs(),na(),Ta(),ia(),ma(),Sa(),la(),va()];function Su(e){return[...wu]}function Eu(e={}){e.defaultIntegrations===void 0&&(e.defaultIntegrations=Su()),e.release===void 0&&(typeof __SENTRY_RELEASE__=="string"&&(e.release=__SENTRY_RELEASE__),N.SENTRY_RELEASE&&N.SENTRY_RELEASE.id&&(e.release=N.SENTRY_RELEASE.id)),e.autoSessionTracking===void 0&&(e.autoSessionTracking=!0),e.sendClientReports===void 0&&(e.sendClientReports=!0);const t={...e,stackParser:Uo(e.stackParser||Hd),integrations:Wl(e),transport:e.transport||(Us()?Rd:xd)};Xl(kd,t),e.autoSessionTracking&&Tu()}function Tu(){if(typeof N.document>"u"){Pe&&x.warn("Session tracking in non-browser environment with @sentry/browser is not supported.");return}qr({ignoreDuration:!0}),Wr(),$s(({from:e,to:t})=>{e!==void 0&&e!==t&&(qr({ignoreDuration:!0}),Wr())})}function ka(e,t,n=!1){const r=e.handlers,s=(a,c,i)=>{if(a&&typeof a=="object"&&"type"in a&&r[a.type]){const d=r[a.type];try{const u=b=>{i(b)},h=b=>{const E=b instanceof Error?b.message:b;i({error:E})},_=a.payload;return d(_,c,u,h)!==!1}catch(u){console.error(`Error in typed message handler for ${a.type}:`,u);const h=u instanceof Error?u.message:String(u);return i({error:h}),!1}}return t(a,c,i)};n?chrome.runtime.onMessageExternal.addListener(s):chrome.runtime.onMessage.addListener(s)}function Iu(e,t){ka(e,t,!1)}function ku(e,t){ka(e,t,!0)}const er=(e,t)=>{let n=e.getState();const r=()=>{const a=e.getState();a!==n&&(t(n,a),n=a)},s=e.subscribe(r);return r(),s},Ca=e=>{Z(e,{messageType:"replaceStore",store:l.getState()})},Cu=()=>{chrome.runtime.sendMessage({messageType:"replaceStore",store:l.getState()})},Ou=()=>{chrome.tabs.query({active:!0}).then(e=>{e.forEach(t=>{Ca(t)})}),Cu()},Ru=async()=>{er(l,Ou),chrome.tabs.onActivated.addListener(e=>Ca(e))};Ru();const ce=128,be=128,Du=new OffscreenCanvas(ce,be),xe={iconContext:Du.getContext("2d",{willReadFrequently:!0}),recordingInterval:null,loadingInterval:null,startingTime:new Date,redOn:!0},xu=ce/6,Au=ce/2-2,Pu="#3730a3",Lu="#f87171",Nu="#1f2937",Fu="#9ca3af",_t=2500,Uu=60,Mu=e=>{const t=ce/2-1,n=be-2,r=e.createLinearGradient(0,0,0,ce);r.addColorStop(0,"#3730a3"),r.addColorStop(1,"#4f46e5");const s=e.createLinearGradient(0,0,0,ce);s.addColorStop(0,"#818cf8"),s.addColorStop(1,"#4f46e5");const a=2;e.lineWidth=16,e.save(),e.translate(ce/2,be/2),e.rotate(Math.PI*2*(new Date().getTime()%_t/_t)),e.translate(-ce/2+4,-be/2+4),e.beginPath(),e.rect(-a,-a,t+a,n+a*2),e.clip(),e.strokeStyle=r,e.beginPath(),e.arc(t-6,t-6,t-6,0,Math.PI*2,!1),e.stroke(),e.restore(),e.save(),e.translate(ce/2,be/2),e.rotate(Math.PI*2*(new Date().getTime()%_t/_t)),e.translate(-ce/2+4,-be/2+4),e.beginPath(),e.rect(t,-a,t+a,n+a*2),e.clip(),e.strokeStyle=s,e.beginPath(),e.arc(t-6,t-6,t-6,0,Math.PI*2,!1),e.stroke(),e.restore()},$u=()=>({16:"/public/logo-128.png",48:"/public/logo-128.png",128:"/public/logo-128.png"}),ju=(e,t)=>{e.beginPath(),e.arc(ce/2,be/2,Au,0,2*Math.PI,!1),e.fillStyle=t,e.strokeStyle=t,e.fill(),e.lineWidth=2,e.stroke()},Oa=(e,t,n,r,s=xu)=>(e.save(),e.fillStyle=n,e.strokeStyle=n,ju(e,t),e.beginPath(),e.arc(ce/2,be/2,s,0,2*Math.PI,!1),e.fillStyle=r?n:t,e.strokeStyle=r?n:t,e.fill(),e.lineWidth=2,e.stroke(),e.restore(),e.getImageData(0,0,ce,be)),qu=e=>(e.save(),e.clearRect(0,0,ce,be),Mu(e),e.restore(),e.getImageData(0,0,ce,be)),Wu=()=>{xe.recordingInterval=setInterval(()=>{const e=new Date().getTime()%1500;chrome.action.setIcon({imageData:Oa(xe.iconContext,Pu,Lu,e<=1e3)})},500)},Bu=()=>{xe.loadingInterval=setInterval(()=>{chrome.action.setIcon({imageData:qu(xe.iconContext)})},_t/Uu)},Gu=()=>{chrome.action.setIcon({imageData:Oa(xe.iconContext,Nu,Fu,!0)})},zu=()=>{chrome.action.setIcon({path:$u()})},Vu=()=>{clearInterval(xe.loadingInterval),clearInterval(xe.recordingInterval),xe.loadingInterval=null,xe.recordingInterval=null},Hu=e=>{if(Vu(),xe.iconContext.clearRect(0,0,ce,be),!at(l.getState()))switch(e){case ae.RECORDING:case ae.STARTING_RECORDING:Wu();break;case ae.PAUSED_RECORDING:Gu();break;case ae.ENDING_RECORDING:Bu();break;case ae.IDLE:default:zu();break}},Ju=(e,t)=>{const n=he(e).status,r=he(t).status;n!==r&&Hu(r)};er(l,Ju);const Ku=V("preFlightChecks/setNetworkError"),tr=V("preFlightChecks/setS3ConnectionError"),nr=V("preFlightChecks/setAssemblyAIConnectionError"),Ra=V("preFlightChecks/setBackendConnectionError"),bt=V("preFlightChecks/setIsRecordingStartedFromBrowser"),Yu=async({tabId:e,windowId:t})=>{const n=await chrome.tabs.get(e),r=await chrome.windows.get(t),{networkError:s,s3ConnectionError:a,backendConnectionError:c,isRecordingStartedFromBrowser:i}=ot(l.getState()),d=(await chrome.tabs.query({})).length;l.dispatch(Ts(d));const{lastUsableContentWindowId:u}=he(l.getState()),h=r.type==="normal"||r.type==="popup";r.focused&&h&&u!==t&&r.id&&l.dispatch(Br(r.id)),n.id&&r.focused&&(l.dispatch(Gr(n.id)),i&&(s||a||c)&&(l.dispatch(Fe(!0)),l.dispatch(bt(!1)))),Z(n,{messageType:"browserContextNeeded",browserContext:{tab:n,window:r}})},rr=async()=>{const{lastUsableContentWindowId:e}=he(l.getState()),{currentFocusedActiveTabId:t}=he(l.getState()),n=await chrome.tabs.query({active:!0}),r=(await chrome.tabs.query({})).length;l.dispatch(Ts(r)),n.forEach(s=>{chrome.windows.get(s.windowId).then(a=>{s.id!==void 0&&(t===s.id&&e===a.id||(a.focused&&(a.type==="normal"||a.type==="popup")&&a.id&&l.dispatch(Br(a.id)),a.focused&&s.active&&l.dispatch(Gr(s.id)),Z(s,{messageType:"browserContextChanged",tab:s,window:a})))})})};chrome.tabs.onActivated.addListener(Yu),chrome.windows.onCreated.addListener(rr),chrome.windows.onFocusChanged.addListener(rr),chrome.runtime.onInstalled.addListener(rr);const Xu=!1;Eu({debug:Xu,dsn:"https://7f832b1e318847f49f65d4d716db714a@o385127.ingest.sentry.io/6071844",environment:"production",includeLocalVariables:!0,ignoreErrors:["Could not establish connection. Receiving end does not exist.","The message port closed before a response was received.","No host permissions for cookies at url","ResizeObserver loop limit exceeded","No tab with id"],beforeSend:function(e,t){const n=t.originalException;return n instanceof $o&&(e.fingerprint=["extension-api-screenshot-error"]),n instanceof jo&&(e.fingerprint=["backup-screenshot-error"]),e}}),Mo("version",chrome.runtime.getManifest().version.toString());const Qu=V("globalVariables/setLastSentNotification"),Da=V("globalVariables/setDomains"),Zu=V("globalVariables/setLastFetched"),xa=V("globalVariables/setCurrentRecommendedScribeCount"),ep=V("globalVariables/setDefaultName"),tp=V("globalVariables/setOs"),np=V("globalVariables/updateLinkMap"),rp=V("globalVariables/setIpAddress"),sp=V("globalVariables/setBenchmark"),ap=V("permissions/setMissingPermissions");V("pins/setIsDroppingPin");const sr=V("pins/setPins"),op=V("pins/setHoveredPinId"),ip=V("pins/setPinsDocuments"),Kt="https://api.assemblyai.com";async function Aa(e,t={}){try{const n=await fetch(e,{cache:"no-cache",headers:t});if(n.ok)return D("server_reachable",{url:e}),n;throw D("server_unreachable",{url:e,status:n.status}),new Error(`Server is not reachable. Status: ${n.status}`)}catch(n){throw console.error("Error:",n),D("server_error",{url:e,error:n.message}),n}}async function cp(){return Aa("https://scribe-api.scribehow.com/health_check/",{"X-Product":"extension","X-Product-Version":qo.version}).then(()=>{l.dispatch(Ra(!1))}).catch(e=>{throw l.dispatch(Ra(!0)),e})}async function lp(){try{const e=await fetch(Kt,{cache:"no-cache"});if(e.status===404||e.status<400)return D("server_reachable",{url:Kt}),l.dispatch(nr(!1)),!0;throw D("assemblyai_unreachable",{url:Kt,status:e.status}),l.dispatch(nr(!0)),new Error(`AssemblyAI returned unexpected status: ${e.status}`)}catch(e){throw l.dispatch(nr(!0)),console.error("AssemblyAI connection error:",e),D("assemblyai_unreachable",{url:Kt,error:e.message}),e}}async function dp(){try{await Aa("https://colony-recorder.s3-accelerate.amazonaws.com/connection-check.txt")}catch(t){throw l.dispatch(tr(!0)),t}const e="https://colony-labs-public.s3.us-east-2.amazonaws.com/test.json";try{const t=await fetch(e,{method:"HEAD"});if(!t.ok)throw new Error(`S3 bucket returned unexpected status: ${t.status}`);console.log("\u2705 AWS server is reachable. Successfully connected to S3 bucket"),l.dispatch(tr(!1)),D("s3_put_reachable",{url:e})}catch(t){throw console.error("Error:",t),$(t),D("s3_put_unreachable",{url:e,error:t.message}),l.dispatch(tr(!0)),t}}async function tt(){return l.dispatch(Ku(!1)),Promise.all([cp(),dp(),lp()]).then(()=>!0).catch(e=>(D("no_internet_connection"),console.log("Can't reach server or logo image. Please check your internet connection",e),!1))}const Yt=e=>{const t=`http://${e}`;let n;try{if(n=Is(t),n.domain){const r=`.${n.tld}`;n.domainWithoutSuffix=n.domain.replace(r,"")}}catch{n={domain:new URL(t).host}}return n},up=e=>Yt(e).domain,pp=e=>Yt(e).domainWithoutSuffix||e,gp=e=>Yt(e).tld,hp=e=>{const t=gc(e),n=t.hostname||"";let[r,s]=(t.path||"").split("/",3);s&&([s]=s.split("#"),[s]=s.split("?"));const a=r+(s?`/${s}`:"");return n+a};class mp{constructor(t){Oe(this,"pattern");Oe(this,"rootDomain");this.pattern=hp(t),this.rootDomain=up(this.pattern)}get domainNamespace(){return`${pp(this.rootDomain)}.*`}get tldNamespace(){return`*.${gp(this.rootDomain)}`}}const fp=e=>{if(e.includes("/"))return[e.split("/")[0],!0];const t=Yt(e);let n;return t.sub?n=[e.split(".").slice(1).join("."),!0]:t.domain&&t.domain!==e?n=[t.domain,!0]:n=[t.domainWithoutSuffix||"",!1],n},yp=(e,t)=>{let n=null;if(t.hasOwnProperty(e.rootDomain)){const r=t[e.rootDomain];let{pattern:s}=e,a=!0;for(;s&&!n&&a;)n=r[s],[s,a]=fp(s)}if(!n){const r=t.null||{};n=r[e.domainNamespace]||r[e.tldNamespace]}return n},Pa=(e,t)=>yp(new mp(e),t),_p=(e,t)=>{const n=zr(JSON.stringify(e??{}))||{};return Object.keys(t).forEach(r=>{n[r]?Object.keys(t[r]).forEach(s=>{n[r][s]?n[r][s]+=t[r][s]:n[r][s]=t[r][s]}):n[r]=t[r]}),n};class La{constructor(t){Oe(this,"delay");Oe(this,"timeout",null);Oe(this,"queue",[]);this.delay=t}invoke(t){this.queue.push(t),this.timeout===null?(this.callLatest(),this.timeout=setTimeout(()=>{this.callLatest(),this.timeout=null},this.delay)):this.queue.push(t)}callLatest(){var t;(t=this.queue.pop())==null||t(),this.queue=[]}}var ar={exports:{}};(function(e,t){(function(n,r){r(t)})($t,function(n){var r={getItemSync:function(m){try{return localStorage.getItem(m)||null}catch{return null}},getItem:function(m,p){var o=this;return new Promise(function(f,y){try{var v=o.getItemSync(m);p==null||p(null,v),f(v)}catch(w){p&&p(w,null),y(w)}})},setItem:function(m,p,o){return new Promise(function(f,y){try{localStorage.setItem(m,p),o&&o(null,p),f(p)}catch(v){o&&o(v,null),y(v)}})}},s=function(){return s=Object.assign||function(m){for(var p,o=1,f=arguments.length;o<f;o++)for(var y in p=arguments[o])Object.prototype.hasOwnProperty.call(p,y)&&(m[y]=p[y]);return m},s.apply(this,arguments)};function a(m,p,o){if(o||arguments.length===2)for(var f,y=0,v=p.length;y<v;y++)!f&&y in p||(f||(f=Array.prototype.slice.call(p,0,y)),f[y]=p[y]);return m.concat(f||Array.prototype.slice.call(p))}var c,i,d=function m(p,o){if(p===o)return!0;if(p&&o&&typeof p=="object"&&typeof o=="object"){if(p.constructor!==o.constructor)return!1;var f,y,v;if(Array.isArray(p)){if((f=p.length)!=o.length)return!1;for(y=f;y--!=0;)if(!m(p[y],o[y]))return!1;return!0}if(p.constructor===RegExp)return p.source===o.source&&p.flags===o.flags;if(p.valueOf!==Object.prototype.valueOf)return p.valueOf()===o.valueOf();if(p.toString!==Object.prototype.toString)return p.toString()===o.toString();if((f=(v=Object.keys(p)).length)!==Object.keys(o).length)return!1;for(y=f;y--!=0;)if(!Object.prototype.hasOwnProperty.call(o,v[y]))return!1;for(y=f;y--!=0;){var w=v[y];if(!m(p[w],o[w]))return!1}return!0}return p!=p&&o!=o};(function(m){m.NONE="NONE",m.DEFAULT_FLAGS="DEFAULT_FLAGS",m.CACHE="CACHE",m.SERVER="SERVER"})(c||(c={}));var u,h=null,_="BULLET_TRAIN_DB",b="BULLET_TRAIN_EVENT",E="https://edge.api.flagsmith.com/api/v1/",O=function(m){return"Attempted to "+m+" a user before calling flagsmith.init. Call flagsmith.init first, if you wish to prevent it sending a request for flags, call init with preventFetch:true."},T="flagsmith_value_",R="flagsmith_enabled_",P="flagsmith_trait_",J=function(){function m(p){var o=this;this._trigger=null,this._triggerLoadingState=null,this.timestamp=null,this.isLoading=!1,this.eventSource=null,this.getJSON=function(f,y,v){var w=o,A=w.environmentID,L=w.headers,te={method:y||"GET",body:v,cache:"no-cache",headers:{"x-environment-key":"".concat(A)}};y&&y!=="GET"&&(te.headers["Content-Type"]="application/json; charset=utf-8"),L&&Object.assign(te.headers,L),i||console.error("Flagsmith: fetch is undefined, please specify a fetch implementation into flagsmith.init to support SSR.");var Y="".concat(o.identity);return i(f,te).then(function(k){var X,de="".concat(o.identity);if(Y===de){var C=(X=k.headers)===null||X===void 0?void 0:X.get("x-flagsmith-document-updated-at");if(C)try{var M=parseFloat(C);if(isNaN(M))throw"Failed to parse x-flagsmith-document-updated-at";o.timestamp=M}catch(W){o.log(W,"Failed to parse x-flagsmith-document-updated-at",C)}return o.log("Fetch response: "+k.status+" "+(y||"GET")+0+f),k.text().then(function(W){var Q=W;try{Q=JSON.parse(W)}catch{}return k.status&&k.status>=200&&k.status<300?Q:Promise.reject(Q)})}o.log("Received response with identity miss-match, ignoring response. Requested: ".concat(Y,", Current: ").concat(de))}).catch(function(k){throw console.error("Flagsmith: Fetch error: "+k),new Error("Flagsmith: Fetch error:"+k)})},this._onChange=function(f,y,v){o.setLoadingState(v),o.onChange&&o.onChange(f,y,o.loadingState),o._trigger&&(o.log("trigger called"),o._trigger())},this.getFlags=function(f,y){var v=o;v.onChange;var w=v.onError,A=v.identity,L=v.api,te=!1;o.log("Get Flags"),o.isLoading=!0,o.loadingState.isFetching||o.setLoadingState(s(s({},o.loadingState),{isFetching:!0}));var Y=function(k){var X=k.flags,de=k.traits;o.isLoading=!1,A&&(o.withTraits=null);var C={},M={};de=de||[],(X=X||[]).forEach(function(F){C[F.feature.name.toLowerCase().replace(/ /g,"_")]={id:F.feature.id,enabled:F.enabled,value:F.feature_state_value}}),de.forEach(function(F){M[F.trait_key.toLowerCase().replace(/ /g,"_")]=F.trait_value}),o.oldFlags=s({},o.flags);var W=d(o.flags,C),Q=d(o.traits,M);if(o.flags=C,o.traits=M,o.updateStorage(),o.datadogRum)try{if(o.datadogRum.trackTraits){var ke={};Object.keys(o.traits).map(function(F){ke[P+F]=o.getTrait(F)});var Et=s(s(s({},o.datadogRum.client.getUser()),{id:o.datadogRum.client.getUser().id||o.identity}),ke);o.log("Setting Datadog user",Et),o.datadogRum.client.setUser(Et)}}catch(F){console.error(F)}if(o.dtrum)try{var ue={javaDouble:{},date:{},shortString:{},javaLongOrObject:{}};Object.keys(o.flags).map(function(F){U(ue,T+F,o.getValue(F,{},!0)),U(ue,R+F,o.hasFeature(F,!0))}),Object.keys(o.traits).map(function(F){U(ue,P+F,o.getTrait(F))}),o.log("Sending javaLongOrObject traits to dynatrace",ue.javaLongOrObject),o.log("Sending date traits to dynatrace",ue.date),o.log("Sending shortString traits to dynatrace",ue.shortString),o.log("Sending javaDouble to dynatrace",ue.javaDouble),o.dtrum.sendSessionProperties(ue.javaLongOrObject,ue.date,ue.shortString,ue.javaDouble)}catch(F){console.error(F)}o._onChange(o.oldFlags,{isFromServer:!0,flagsChanged:!W,traitsChanged:!Q},o._loadedState(null,c.SERVER))};return A?Promise.all([o.withTraits?o.getJSON(L+"identities/","POST",JSON.stringify({identifier:A,traits:Object.keys(o.withTraits).map(function(k){return{trait_key:k,trait_value:o.withTraits[k]}}).filter(function(k){return k.trait_value!==void 0||(o.log("Warning - attempted to set an undefined trait value for key",k.trait_key),!1)})})):o.getJSON(L+"identities/?identifier="+encodeURIComponent(A))]).then(function(k){o.withTraits=null,Y(k[0]),f&&!te&&(te=!0,f())}).catch(function(k){var X=k.message;w&&w(new Error(X))}):Promise.all([o.getJSON(L+"flags/")]).then(function(k){Y({flags:k[0],traits:void 0}),f&&!te&&(te=!0,f())}).catch(function(k){y&&!te&&(te=!0,y(k)),w&&w(k)})},this.analyticsFlags=function(){var f=o.api;if(o.evaluationEvent&&o.evaluationEvent[o.environmentID])return o.evaluationEvent&&Object.getOwnPropertyNames(o.evaluationEvent).length!==0&&Object.getOwnPropertyNames(o.evaluationEvent[o.environmentID]).length!==0?o.getJSON(f+"analytics/flags/","POST",JSON.stringify(o.evaluationEvent[o.environmentID])).then(function(y){var v=o.getState();o.evaluationEvent||(o.evaluationEvent={}),o.evaluationEvent[o.environmentID]={},o.setState(s(s({},v),{evaluationEvent:o.evaluationEvent})),o.updateEventStorage()}).catch(function(y){o.log("Exception fetching evaluationEvent",y)}):void 0},this.datadogRum=null,this.loadingState={isLoading:!0,isFetching:!0,error:null,source:c.NONE},this.canUseStorage=!1,this.analyticsInterval=null,this.api=null,this.cacheFlags=!1,this.ts=null,this.enableAnalytics=!1,this.enableLogs=!1,this.environmentID="",this.evaluationEvent=null,this.flags=null,this.getFlagInterval=null,this.headers=null,this.initialised=!1,this.oldFlags=null,this.onChange=null,this.onError=null,this.identity=null,this.ticks=null,this.timer=null,this.traits=null,this.dtrum=null,this.withTraits=null,this.cacheOptions={ttl:0,skipAPI:!1},this.evaluateFlag=function(f,y){if(o.datadogRum&&(o.datadogRum.client.addFeatureFlagEvaluation?y==="VALUE"?o.datadogRum.client.addFeatureFlagEvaluation(T+f,o.getValue(f,{},!0)):o.datadogRum.client.addFeatureFlagEvaluation(R+f,o.hasFeature(f,!0)):console.error("Flagsmith: Your datadog RUM client does not support the function addFeatureFlagEvaluation, please update it.")),o.enableAnalytics){if(!o.evaluationEvent)return;o.evaluationEvent[o.environmentID]||(o.evaluationEvent[o.environmentID]={}),o.evaluationEvent[o.environmentID][f]===void 0&&(o.evaluationEvent[o.environmentID][f]=0),o.evaluationEvent[o.environmentID][f]+=1}o.updateEventStorage()},this.getValue=function(f,y,v){var w=o.flags&&o.flags[f.toLowerCase().replace(/ /g,"_")],A=null;if(w&&(A=w.value),v||o.evaluateFlag(f,"VALUE"),A===null&&(y==null?void 0:y.fallback)!==void 0)return y.fallback;if(y!=null&&y.json)try{return A===null?(o.log("Tried to parse null flag as JSON: "+f),null):JSON.parse(A)}catch{return y.fallback}return A},this.getTrait=function(f){return o.traits&&o.traits[f.toLowerCase().replace(/ /g,"_")]},this.getAllTraits=function(){return o.traits},this.setTrait=function(f,y){if(o.api){var v={};return v[f]=y,o.setTraits(v)}console.error(O("setTrait"))},this.setTraits=function(f){if(o.api){if(f&&typeof f=="object"||console.error("Expected object for flagsmith.setTraits"),o.withTraits=s(s({},o.withTraits||{}),f),o.identity)return o.initialised?o.getFlags():void 0;o.log("Set traits prior to identifying",o.withTraits)}else console.error(O("setTraits"))},this.hasFeature=function(f,y){var v=o.flags&&o.flags[f.toLowerCase().replace(/ /g,"_")],w=!1;return v&&v.enabled&&(w=!0),y||o.evaluateFlag(f,"ENABLED"),w},i=p.fetch?p.fetch:typeof fetch<"u"?fetch:$t===null||$t===void 0?void 0:$t.fetch,this.canUseStorage=typeof window<"u"||!!p.browserlessStorage,this.log("Constructing flagsmith instance "+p),p.eventSource&&(u=p.eventSource),p.AsyncStorage&&(h=p.AsyncStorage)}return m.prototype.init=function(p){var o=this,f=p.environmentID,y=p.api,v=y===void 0?E:y,w=p.headers,A=p.onChange,L=p.cacheFlags,te=p.datadogRum,Y=p.onError,k=p.defaultFlags,X=p.fetch,de=p.preventFetch,C=p.enableLogs,M=p.enableDynatrace,W=p.enableAnalytics,Q=p.realtime,ke=p.eventSourceUrl,Et=ke===void 0?"https://realtime.flagsmith.com/":ke,ue=p.AsyncStorage,F=p.identity,rn=p.traits,Tt=p.state,sn=p.cacheOptions,It=p.angularHttpClient,Er=p._trigger,lo=p._triggerLoadingState;return new Promise(function(Ce,kt){var an,on;o.environmentID=f,o.api=v,o.headers=w,o.getFlagInterval=null,o.analyticsInterval=null,o.onChange=A;var Tr="Wrong Flagsmith Configuration: preventFetch is true and no defaulFlags provided";if(o._trigger=Er||o._trigger,o._triggerLoadingState=lo||o._triggerLoadingState,o.onError=function(ne){o.setLoadingState(s(s({},o.loadingState),{isFetching:!1,isLoading:!1,error:ne})),Y&&(ne instanceof Error?Y(ne):Y(new Error(ne)))},o.identity=F,o.withTraits=rn,o.enableLogs=C||!1,o.cacheOptions=sn?{skipAPI:!!sn.skipAPI,ttl:sn.ttl||0}:o.cacheOptions,!o.cacheOptions.ttl&&o.cacheOptions.skipAPI&&console.warn("Flagsmith: you have set a cache ttl of 0 and are skipping API calls, this means the API will not be hit unless you clear local storage."),X&&(i=X),o.enableAnalytics=W||!1,o.flags=Object.assign({},k)||{},o.traits=Object.assign({},rn)||{},o.initialised=!0,o.ticks=1e4,Object.keys(o.flags).length&&(o.loadingState=s(s({},o.loadingState),{isLoading:!1,source:c.DEFAULT_FLAGS})),Q&&typeof window<"u"){var Ir=Et+"sse/environments/"+f+"/stream";u?o.eventSource||(o.log("Creating event source with url "+Ir),o.eventSource=new u(Ir),o.eventSource.addEventListener("environment_updated",function(ne){var pe;try{pe=JSON.parse(ne.data).updated_at}catch(we){o.log("Could not parse sse event",we)}pe?!o.timestamp||pe>o.timestamp?o.isLoading?o.log("updated_at is new, but flags are loading",ne.data,o.timestamp):(o.log("updated_at is new, fetching flags",ne.data,o.timestamp),o.getFlags()):o.log("updated_at is outdated, skipping get flags",ne.data,o.timestamp):o.log("No updated_at received, fetching flags",ne)})):o.log("Error, EventSource is undefined")}if(o.log("Initialising with properties",{environmentID:f,api:v,headers:w,onChange:A,cacheFlags:L,onError:Y,defaultFlags:k,preventFetch:de,enableLogs:C,enableAnalytics:W,AsyncStorage:h,identity:F,traits:rn,_trigger:Er,state:Tt,angularHttpClient:It},o),o.timer=o.enableLogs?new Date().valueOf():null,ue&&(h=ue),o.cacheFlags=h!==void 0&&!!L,o.setState(Tt),!f)throw kt("Please specify a environment id"),"Please specify a environment id";if(te&&(o.datadogRum=te),M&&(typeof dtrum>"u"?console.error("You have attempted to enable dynatrace but dtrum is undefined, please check you have the Dynatrace RUM JavaScript API installed."):o.dtrum=dtrum),It&&(i=function(ne,pe){var we=pe.headers,st=pe.method,ge=pe.body;return new Promise(function(je){switch(st){case"GET":return It.get(ne,{headers:we}).subscribe(function(qe){je({ok:!0,text:function(){return Promise.resolve(qe)}})});case"POST":case"PUT":return It.post(ne,ge,{headers:we}).subscribe(function(qe){je({ok:!0,text:function(){return Promise.resolve(qe)}})})}})}),h&&o.canUseStorage&&h.getItem(b).then(function(ne){if(ne)try{o.evaluationEvent=JSON.parse(ne)}catch{o.evaluationEvent={}}else o.evaluationEvent={};return o.analyticsInterval=setInterval(o.analyticsFlags,o.ticks),!0}),o.enableAnalytics&&(o.analyticsInterval&&clearInterval(o.analyticsInterval),h&&o.canUseStorage&&h.getItem(b,function(ne,pe){if(pe){var we=JSON.parse(pe);we[o.environmentID]&&(Tt=o.getState(),o.log("Retrieved events from cache",pe),o.setState(s(s({},Tt),{evaluationEvent:we[o.environmentID]})))}return!0})),L){if(h&&o.canUseStorage){var kr=function(ne,pe){var we,st;if(pe)try{var ge=JSON.parse(pe),je=!1;if(ge&&ge.api===o.api&&ge.environmentID===o.environmentID){var qe=!0;o.identity&&ge.identity!==o.identity&&(o.log("Ignoring cache,  identity has changed from "+ge.identity+" to "+o.identity),qe=!1),o.cacheOptions.ttl&&(!ge.ts||new Date().valueOf()-ge.ts>o.cacheOptions.ttl)&&ge.ts&&(o.log("Ignoring cache, timestamp is too old ts:"+ge.ts+" ttl: "+o.cacheOptions.ttl+" time elapsed since cache: "+(new Date().valueOf()-ge.ts)+"ms"),qe=!1),qe&&(je=!0,o.setState(ge),o.log("Retrieved flags from cache",ge))}if(je){var Or=!(de||o.cacheOptions.skipAPI&&je);o._onChange(null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!o.traits&&!!Object.keys(o.traits).length},o._loadedState(null,c.CACHE,Or)),o.oldFlags=o.flags,Ce(!0),o.cacheOptions.skipAPI&&je&&o.log("Skipping API, using cache"),Or&&o.getFlags()}else de?Ce(!0):o.getFlags(Ce,kt)}catch(uo){o.log("Exception fetching cached logs",uo)}else de?(k?o._onChange(null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!o.traits&&!!Object.keys(o.traits).length},o._loadedState(null,c.DEFAULT_FLAGS)):o.flags?(we=o._onChange)===null||we===void 0||we.call(o,null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!o.traits&&!!Object.keys(o.traits).length},o._loadedState(null,c.DEFAULT_FLAGS)):(st=o.onError)===null||st===void 0||st.call(o,new Error(Tr)),Ce(!0)):o.getFlags(Ce,kt);return!0};if(h.getItemSync)try{kr(0,h.getItemSync(_))}catch{}else h.getItem(_,kr)}}else if(de){if(k)(an=o._onChange)===null||an===void 0||an.call(o,null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!o.traits&&!!Object.keys(o.traits).length},o._loadedState(null,c.DEFAULT_FLAGS));else if(o.flags){var Cr=null;Object.keys(o.flags).length===0&&(Cr=Tr),(on=o._onChange)===null||on===void 0||on.call(o,null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!o.traits&&!!Object.keys(o.traits).length},o._loadedState(Cr,c.DEFAULT_FLAGS))}Ce(!0)}else o.getFlags(Ce,kt)}).catch(function(Ce){o.log("Error during initialisation ",Ce),Y&&Y(Ce)})},m.prototype._loadedState=function(p,o,f){return p===void 0&&(p=null),f===void 0&&(f=!1),{error:p,isFetching:f,isLoading:!1,source:o}},m.prototype.getAllFlags=function(){return this.flags},m.prototype.identify=function(p,o){return this.identity=p,this.log("Identify: "+this.identity),o&&(this.withTraits=s(s({},this.withTraits||{}),o)),this.initialised?this.getFlags():Promise.resolve()},m.prototype.getState=function(){return{api:this.api,environmentID:this.environmentID,flags:this.flags,identity:this.identity,ts:this.ts,traits:this.traits,evaluationEvent:this.evaluationEvent}},m.prototype.setState=function(p){p&&(this.initialised=!0,this.api=p.api||this.api||E,this.environmentID=p.environmentID||this.environmentID,this.flags=p.flags||this.flags,this.identity=p.identity||this.identity,this.traits=p.traits||this.traits,this.withTraits=s(s({},this.withTraits||{}),this.traits),this.evaluationEvent=p.evaluationEvent||this.evaluationEvent,this.log("setState called",this))},m.prototype.log=function(){for(var p=[],o=0;o<arguments.length;o++)p[o]=arguments[o];this.enableLogs&&console.log.apply(this,a(["FLAGSMITH:",new Date().valueOf()-(this.timer||0),"ms"],p,!0))},m.prototype.updateStorage=function(){if(this.cacheFlags){this.ts=new Date().valueOf();var p=JSON.stringify(this.getState());this.log("Setting storage",p),h.setItem(_,p)}},m.prototype.updateEventStorage=function(){if(this.enableAnalytics){var p=JSON.stringify(this.getState().evaluationEvent);h.setItem(b,p)}},m.prototype.setLoadingState=function(p){var o;d(p,this.loadingState)||(this.loadingState=s({},p),this.log("Loading state changed",p),(o=this._triggerLoadingState)===null||o===void 0||o.call(this))},m.prototype.logout=function(){return this.identity=null,this.traits={},this.initialised?this.getFlags():Promise.resolve()},m.prototype.startListening=function(p){p===void 0&&(p=1e3),this.getFlagInterval&&clearInterval(this.getFlagInterval),this.getFlagInterval=setInterval(this.getFlags,p)},m.prototype.stopListening=function(){this.getFlagInterval&&(clearInterval(this.getFlagInterval),this.getFlagInterval=null)},m.prototype.getSegments=function(){},m}();function re(m){var p=m.fetch,o=m.AsyncStorage,f=m.eventSource;return new J({fetch:p,AsyncStorage:o,eventSource:f})}var S,U=function(m,p,o){var f="shortString",y=!0;typeof o=="number"&&(f="javaDouble",y=!1),m[f]=m[f]||{},m[f][p]=y?o+"":o},le=(S=function(m,p){return S=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,f){o.__proto__=f}||function(o,f){for(var y in f)Object.prototype.hasOwnProperty.call(f,y)&&(o[y]=f[y])},S(m,p)},function(m,p){if(typeof p!="function"&&p!==null)throw new TypeError("Class extends value "+String(p)+" is not a constructor or null");function o(){this.constructor=m}S(m,p),m.prototype=p===null?Object.create(p):(o.prototype=p.prototype,new o)}),fe=function(m){var p=typeof Symbol=="function"&&Symbol.iterator,o=p&&m[p],f=0;if(o)return o.call(m);if(m&&typeof m.length=="number")return{next:function(){return m&&f>=m.length&&(m=void 0),{value:m&&m[f++],done:!m}}};throw new TypeError(p?"Object is not iterable.":"Symbol.iterator is not defined.")},K=function(m,p){var o=typeof Symbol=="function"&&m[Symbol.iterator];if(!o)return m;var f,y,v=o.call(m),w=[];try{for(;(p===void 0||p-- >0)&&!(f=v.next()).done;)w.push(f.value)}catch(A){y={error:A}}finally{try{f&&!f.done&&(o=v.return)&&o.call(v)}finally{if(y)throw y.error}}return w},ve=function(m,p,o){if(o||arguments.length===2)for(var f,y=0,v=p.length;y<v;y++)!f&&y in p||(f||(f=Array.prototype.slice.call(p,0,y)),f[y]=p[y]);return m.concat(f||Array.prototype.slice.call(p))},Le=function(m){function p(){return m.call(this,`EventSource not available.
Consider loading an EventSource polyfill and making it available globally as EventSource, or passing one in as eventSourceClass to the ReconnectingEventSource constructor.`)||this}return le(p,m),p}(Error),$e=function(){function m(p,o){var f=this;if(this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this._configuration=o!=null?Object.assign({},o):void 0,this.withCredentials=!1,this._eventSource=null,this._lastEventId=null,this._timer=null,this._listeners={open:[],error:[],message:[]},this.url=p.toString(),this.readyState=this.CONNECTING,this.max_retry_time=3e3,this.eventSourceClass=globalThis.FlagsmithEventSource,this._configuration!=null&&(this._configuration.lastEventId&&(this._lastEventId=this._configuration.lastEventId,delete this._configuration.lastEventId),this._configuration.max_retry_time&&(this.max_retry_time=this._configuration.max_retry_time,delete this._configuration.max_retry_time),this._configuration.eventSourceClass&&(this.eventSourceClass=this._configuration.eventSourceClass,delete this._configuration.eventSourceClass)),this.eventSourceClass==null||typeof this.eventSourceClass!="function")throw new Le;this._onevent_wrapped=function(y){f._onevent(y)},this._start()}return m.prototype.dispatchEvent=function(p){throw new Error("Method not implemented.")},m.prototype._start=function(){var p,o,f=this,y=this.url;this._lastEventId&&(y.indexOf("?")===-1?y+="?":y+="&",y+="lastEventId="+encodeURIComponent(this._lastEventId)),this._eventSource=new this.eventSourceClass(y,this._configuration),this._eventSource.onopen=function(L){f._onopen(L)},this._eventSource.onerror=function(L){f._onerror(L)},this._eventSource.onmessage=function(L){f.onmessage(L)};try{for(var v=fe(Object.keys(this._listeners)),w=v.next();!w.done;w=v.next()){var A=w.value;this._eventSource.addEventListener(A,this._onevent_wrapped)}}catch(L){p={error:L}}finally{try{w&&!w.done&&(o=v.return)&&o.call(v)}finally{if(p)throw p.error}}},m.prototype._onopen=function(p){this.readyState===0&&(this.readyState=1,this.onopen(p))},m.prototype._onerror=function(p){var o=this;if(this.readyState===1&&(this.readyState=0,this.onerror(p)),this._eventSource){this._eventSource.close(),this._eventSource=null;var f=Math.round(this.max_retry_time*Math.random());this._timer=setTimeout(function(){return o._start()},f)}},m.prototype._onevent=function(p){var o,f;p&&p.lastEventId&&(this._lastEventId=p.lastEventId);var y=this._listeners[p.type];if(y!=null)try{for(var v=fe(ve([],K(y),!1)),w=v.next();!w.done;w=v.next())w.value.call(this,p)}catch(A){o={error:A}}finally{try{w&&!w.done&&(f=v.return)&&f.call(v)}finally{if(o)throw o.error}}p.type==="message"&&this.onmessage(p)},m.prototype.onopen=function(p){},m.prototype.onerror=function(p){},m.prototype.onmessage=function(p){},m.prototype.close=function(){this._timer&&(clearTimeout(this._timer),this._timer=null),this._eventSource&&(this._eventSource.close(),this._eventSource=null),this.readyState=2},m.prototype.addEventListener=function(p,o,f){this._listeners[p]==null&&(this._listeners[p]=[],this._eventSource!=null&&this._eventSource.addEventListener(p,this._onevent_wrapped));var y=this._listeners[p];y.includes(o)||(this._listeners[p]=ve(ve([],K(y),!1),[o],!1))},m.prototype.removeEventListener=function(p,o,f){var y=this._listeners[p];this._listeners[p]=y.filter(function(v){return v!==o})},m}();globalThis.FlagsmithEventSource=typeof EventSource<"u"?EventSource:null;var rt=function(m,p){return p=p||{},new Promise(function(o,f){var y=new XMLHttpRequest,v=[],w=[],A={},L=function(){return{ok:(y.status/100|0)==2,statusText:y.statusText,status:y.status,url:y.responseURL,text:function(){return Promise.resolve(y.responseText)},json:function(){return Promise.resolve(y.responseText).then(JSON.parse)},blob:function(){return Promise.resolve(new Blob([y.response]))},clone:L,headers:{keys:function(){return v},entries:function(){return w},get:function(Y){return A[Y.toLowerCase()]},has:function(Y){return Y.toLowerCase()in A}}}};for(var te in y.open(p.method||"get",m,!0),y.onload=function(){y.getAllResponseHeaders().replace(/^(.*?):[^\S\n]*([\s\S]*?)$/gm,function(Y,k,X){v.push(k=k.toLowerCase()),w.push([k,X]),A[k]=A[k]?A[k]+","+X:X}),o(L())},y.onerror=f,y.withCredentials=p.credentials=="include",p.headers)y.setRequestHeader(te,p.headers[te]);y.send(p.body||null)})},g=re({AsyncStorage:r,fetch:rt,eventSource:$e});typeof window<"u"&&(window.flagsmith=g),n.createFlagsmithInstance=function(){return re({AsyncStorage:r,fetch:rt,eventSource:$e})},n.default=g,Object.defineProperty(n,"__esModule",{value:!0})})})(ar,ar.exports);var bp=ar.exports;const or=Tc(bp),vp=e=>e.replace(/_./g,t=>t[1].toUpperCase()).replace(/-./g,t=>t[1].toUpperCase()),wp=e=>{const t={...e};for(const[n,r]of Object.entries(t)){const s=vp(n);delete t[n],t[s]=r}return t},Sp=e=>{for(const[t,n]of Object.entries(e))n.enabled?e[t]=n.value:delete e[t];return e},Ep=async e=>(e==null?void 0:e.email)||await Go(zo,Ue()),Tp=e=>{var s,a,c,i,d,u,h,_,b;const t=e!=null&&e.date_joined?new Date(e.date_joined).valueOf():void 0,n=(a=(s=e==null?void 0:e.active_organization)==null?void 0:s.super_organization)==null?void 0:a.created,r=n?new Date(n).valueOf():t;return e?{super_organization_id:(i=(c=e.active_organization)==null?void 0:c.super_organization)==null?void 0:i.id,organization_id:(d=e.active_organization)==null?void 0:d.id,email_address:e.email,first_name:e.first_name,last_name:e.last_name,date_joined:e.date_joined,date_joined_timestamp:t,super_organization_created_date:n,super_organization_created_date_timestamp:r,plan_name:(_=(h=(u=e.active_organization)==null?void 0:u.super_organization)==null?void 0:h.plan)==null?void 0:_.name,signup_method:e.signup_method,browser:Vo(),extension_version:chrome.runtime.getManifest().version,signup_source:e.signup_source,sps_enabled:!!((b=e.active_organization)!=null&&b.smart_privacy_screen_enabled)}:null},Ip=async e=>{const t=await Ep(e),n=Tp(e);t!==null&&or.identify(t,n).then(r=>or.getAllFlags()).then(r=>{const s=Sp(wp(r));l.dispatch(Wo(s))})},kp=async()=>{or.init({environmentID:Bo,fetch,preventFetch:!0})};kp().catch(e=>{console.error(e)});const Xt=async()=>{const e=await Ic();l.dispatch(Ho(e));const t=await Cs("recordingControlsPosition");l.dispatch(Jo(t))},Cp=async(e,t)=>{await Un(e,t),Xt()},Na="/assets/index.tsx-loader.js",Fa="/assets/index.js-loader.js",Op=async e=>{!e.id||!(e!=null&&e.url)||Ee(e.url)||await chrome.scripting.executeScript({target:{tabId:e.id,allFrames:!0},files:[Na,Fa]})},ir=async({tabId:e})=>{const t=await chrome.tabs.get(e);try{Z(t,{messageType:"pingContentScript"},n=>{n||Op(t)})}catch(n){D("error_in_refreshContentScriptIfStale",{error:n})}},Rp=async()=>{(await chrome.tabs.query({active:!0})).forEach(e=>{e.id!==void 0&&ir({tabId:e.id})})};chrome.tabs.onActivated.addListener(ir),chrome.windows.onFocusChanged.addListener(Rp);const Dp=async({api:e,documentId:t,context:n})=>await it(e,`views/?id=${t}`,"post",{context:n}),xp={create:Dp};function Ua(e,t,n){xp.create({api:e,documentId:t,context:n})}const cr=V("sidebar/initializeSidebar"),lr=460;async function Ap(e,t){function n(r){r.id===e&&(chrome.windows.update(e,t),chrome.windows.onBoundsChanged.removeListener(n))}chrome.windows.onBoundsChanged.addListener(n),await chrome.windows.update(e,{state:"normal"})}async function Pp(e,t,n){if(e.left===void 0||e.width===void 0)throw new Error("Current window does not have a valid left or width. Is the window a closed window from the sessions API?");if((t==null?void 0:t.id)===void 0)throw new Error(`Current tab not passed ${t==null?void 0:t.url} ${t==null?void 0:t.status}`);let r=e.height,s=e.width-lr,a=e.top,c=e.left;if(e.state==="fullscreen"||e.state==="maximized"&&Vr()!==Ko.MacOS){const i=await chrome.tabs.sendMessage(t.id,{messageType:"getScreenDimensions"});a=i.screenTop,c=i.screenLeft,r=i.height,s=i.width-lr,await Ap(t.windowId,{left:c,top:a,width:s,height:r})}else await chrome.windows.update(t.windowId,{width:s});return await chrome.windows.create({url:n,type:"popup",left:c+s,top:a,width:lr,height:r})}async function Lp(e,t){const n=await chrome.tabs.query({windowId:e});if(n.length>0){const r=n[0].id;if(n[0].pendingUrl===t||n[0].url===t)return;await chrome.tabs.update(r,{url:t});return}throw new Error("No tabs found in window")}async function Np(){var t;const{sidebar:e}=l.getState();if(e.sidebarWindowId){const n=await chrome.tabs.query({windowId:e.sidebarWindowId});if(n.length>0)return(!n[0].pendingUrl||!n[0].pendingUrl.includes("sidebar/assistant"))&&((t=n[0].url)!=null&&t.includes("sidebar/assistant"))?0:1}}const Qt=async e=>{const{sidebar:t}=l.getState();if(t.sidebarWindowId)try{return await Lp(t.sidebarWindowId,e),t.sidebarWindowId}catch{l.dispatch(cr({sidebarWindowId:void 0,contentWindowId:void 0,originalContentWindowWidth:void 0}))}const[n]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});if(n.windowId){const r=await chrome.windows.get(n.windowId),s=r.width;if(r.left!==void 0&&r.width!==void 0){const a=await Pp(r,n,e);l.dispatch(cr({sidebarWindowId:a.id,contentWindowId:r.id,originalContentWindowWidth:s}));const c=async i=>{const{sidebar:d}=l.getState();if(d.sidebarWindowId&&i===d.sidebarWindowId){const u=d.originalContentWindowWidth;await chrome.windows.update(n.windowId,{width:u}),l.dispatch(cr({sidebarWindowId:void 0,contentWindowId:void 0,originalContentWindowWidth:void 0}))}chrome.windows.onRemoved.removeListener(c)};return chrome.windows.onRemoved.addListener(c),a.id}}},Ma=async e=>{await Np()===0&&await Qt(`${G.FRONTEND_URL}/sidebar/assistant?url=${e}`)},Fp=(e,t,n)=>{const r=vn(e,t,!1,"","scribe",`${G.FRONTEND_URL}/`);return r?Hr(r,{name:"startingUrl",value:n??""}):null},$a=(e,t,n,r)=>{const s=vn(e,t,!1,"","scribe",`${G.FRONTEND_URL}/`);return s?Hr(s,{name:"sidepanel",value:"true"},{name:"startingUrl",value:encodeURI(n)},{name:"startGuiding",value:"true"},{name:"actionIndex",value:r}).split(G.FRONTEND_URL)[1]:null},Up=(e,t)=>{const n=l.getState(),{contentWindowId:r}=Jr(n),s=e.url,a=$a(e.id,e.name,s,e.actionIndex);s&&chrome.tabs.create({url:s,windowId:r}),z("scribe_viewer_started",{startingUrl:s,viewerUrl:a,id:e.id,name:e.name,location:e.location}),Ua(t,e.id,"sidekick")},ja=(e,t)=>{const n=bn(l.getState()),{scribe:r}=n||{};if(!r){console.error("Scribe is undefined");return}const{id:s,name:a,url:c,location:i,actionIndex:d}=r,u=$a(s,a,c,d);e.targetWindowId&&ct(e.targetWindowId,Yo(u)??"",{frontendUrl:G.FRONTEND_URL}),chrome.action.setPopup({popup:""}),chrome.runtime.sendMessage({messageType:"removePopup"}),Up({id:s,name:a,url:c,location:i,actionIndex:d},t)},Mp=async(e,t,n)=>{const r=l.getState(),{contentWindowId:s}=Jr(r);z("scribe_viewer_started",{startingUrl:e.startingUrl,id:e.scribe.id,name:e.scribe.name,location:e.location}),Ua(t,e.scribe.id,"in-context-viewer");const a=`${Fp(e.scribe.id,e.scribe.name,e.startingUrl)}`;await Qt(a),e.startingUrl&&chrome.tabs.create({url:e.startingUrl,windowId:s})};function qa(e=null){chrome.tabs.query({active:!0,currentWindow:!0},function(t){t&&t[0]&&t[0].id&&chrome.tabs.sendMessage(t[0].id,{messageType:"getCurrentDom",sessionId:e})})}function $p({dom:e,url:t,sessionId:n}){chrome.runtime.sendMessage({messageType:"send-dom-to-sidepanel",data:{dom:e,url:t,sessionId:n}})}const jp=(e,t,n,r)=>{var s,a;if(e.messageType===jt.ON_MEDIA_PERMISSIONS_TAB_INITALIZED&&Xo(t.tab,e.microphonePermission),e.messageType===jt.MEDIA_PERMISSION_CHANGED&&e.microphonePermission===Qo.GRANTED){const c=(a=(s=H(r.getState()))==null?void 0:s.recordedTabs)==null?void 0:a[0];chrome.tabs.update(c,{active:!0})}},qp=async()=>{try{const{data:e}=await j.get("/transcript_token/");return e.token}catch(e){throw $({title:"Failed to fetch AssemblyAI auth token",error:e.message}),new Error("Failed to fetch AssemblyAI auth token",e.message)}},Wp=(e,t)=>{var s,a;const n=((s=e.words[0])==null?void 0:s.start)||0,r=((a=e.words[e.words.length-1])==null?void 0:a.end)||0;return{...e,audio_start_timestamp:n+t,audio_end_timestamp:r+t,relative_audio_start:t}},Bp=async(e,t)=>{var n;switch(e){case Rt.GET_AUTH_TOKEN:try{return{token:await qp()}}catch(r){throw console.error("Failed to fetch auth token:",r),l.dispatch(wn(!1)),r}case Rt.TRANSCRIPT:(n=t.transcript)!=null&&n.words.length&&l.dispatch(Zo(Wp(t.transcript,t.startTimestamp||Date.now().valueOf())));break;case Rt.ERROR:$({title:t.title,error:t.error}),l.dispatch(wn(!1));break;case Rt.ON_READY:l.dispatch(wn(!0));break}},Gp=e=>e.domSettlement||{captures:{}},Zt=lt(Gp,e=>e.captures);lt(Zt,e=>{const t=Date.now(),n=[];return Object.entries(e).forEach(([r,s])=>{s.ttl&&s.ttl<t&&n.push(r)}),n}),lt(Zt,e=>{const t={};return Object.entries(e).forEach(([n,r])=>{r.scribeId||(t[n]=r)}),t}),lt(Zt,e=>Object.keys(e).length),lt(Zt,e=>{const t={};return Object.entries(e).forEach(([n,r])=>{r.scribeId&&!r.ttl&&(t[n]=r)}),t});class zp{constructor(t){Oe(this,"isEnabled");Oe(this,"lastDomainByTab");Oe(this,"capturedDomains");Oe(this,"config");this.config=t,this.isEnabled=!0,this.lastDomainByTab=new Map,this.capturedDomains=new Set}async handleStageCapture(t,n,r){if(this.isEnabled&&!(n!=="networkIdle"&&n!=="fullySettled"))try{const s=await this.getTab(t);if(!s||!s.url||!this.shouldMonitorUrl(s.url))return;const a=this.getDomainFromUrl(s.url);if(!a)return;const c=`${t}-${a}-${n}`;if(this.capturedDomains.has(c))return;const i=await Dt();if(!i||!i.base64Image)return;const d=await Ke.saveScreenshot(i.base64Image,t,a,s.url,n);l.dispatch(ei({tabId:t,domain:a,screenshotId:d})),this.capturedDomains.add(c),this.lastDomainByTab.set(t,a)}catch(s){console.error("[DOM Settlement] Failed to capture screenshot:",s)}}async handleDomainChange(t,n){var a,c;if(!this.isEnabled)return;const r=this.getDomainFromUrl(n),s=this.lastDomainByTab.get(t);if(s&&r&&s!==r){const i=l.getState(),d=`${t}-${s}`,u=(c=(a=i.domSettlement)==null?void 0:a.captures)==null?void 0:c[d];u!=null&&u.screenshotId&&await Ke.deleteScreenshot(u.screenshotId),l.dispatch(ti({tabId:t,domain:s})),this.lastDomainByTab.set(t,r);const h=[];this.capturedDomains.forEach(_=>{_.startsWith(`${t}-`)&&h.push(_)}),h.forEach(_=>this.capturedDomains.delete(_))}}associateCapturesWithScribe(t,n){var r;try{const s=((r=l.getState().domSettlement)==null?void 0:r.captures)||{};Object.entries(s).forEach(([a,c])=>{if(a.startsWith(`${t}-`)){const{domain:i}=c;l.dispatch(ni({tabId:t,domain:i,scribeId:n}))}})}catch(s){console.error("[DOM Settlement] Error associating captures:",s)}}async getCapturesForScribe(t){var a;const n=((a=l.getState().domSettlement)==null?void 0:a.captures)||{},r=[],s=Object.entries(n).filter(([c,i])=>i.scribeId===t&&i.screenshotId);for(const[c,i]of s){const d=await Ke.getScreenshotWithMetadata(i.screenshotId);d&&r.push({tabId:i.tabId,domain:i.domain,screenshot:d.base64Data,captureTime:i.captureTime,stage:d.stage,url:d.href,s3DownloadUrl:d.s3DownloadUrl,s3InternalUrl:d.s3InternalUrl})}return r}async clearScribeCaptures(t){var s;const n=((s=l.getState().domSettlement)==null?void 0:s.captures)||{},r=[];Object.entries(n).forEach(([a,c])=>{c.scribeId===t&&c.screenshotId&&r.push(c.screenshotId)}),r.length>0&&await Ke.deleteScreenshots(r),l.dispatch(ri(t))}async uploadInitialScreenshotToS3(t,n){var r,s;try{const a=l.getState(),c=this.lastDomainByTab.get(t);if(!c)return null;const i=`${t}-${c}`,d=(s=(r=a.domSettlement)==null?void 0:r.captures)==null?void 0:s[i];if(!(d!=null&&d.screenshotId)||d.scribeId!==n)return null;const u=await Ke.getScreenshot(d.screenshotId);if(!u)return null;const h=await j.post("/signed_urls/",{name:"dom_settlement_screenshot",file_type:"jpeg"}),{internal_url:_,upload_url:b,download_url:E}=h.data;let O=u;O.includes(",")&&(O=O.split(",")[1]);const T=atob(O),R=new Uint8Array(T.length);for(let J=0;J<T.length;J++)R[J]=T.charCodeAt(J);const P=new Blob([R],{type:"image/jpeg"});return await Kr(b,P,"image/jpeg",{timeout:6e4}),console.log("[DOM Settlement] Successfully uploaded screenshot to S3 for",c),await Ke.updateS3Urls(d.screenshotId,_,E,b),{internalUrl:_,downloadUrl:E}}catch(a){return console.error("[DOM Settlement] Failed to upload screenshot to S3:",a),$(a),null}}setEnabled(t){this.isEnabled=t}getDomainFromUrl(t){try{return new URL(t).hostname}catch{return null}}shouldMonitorUrl(t){return!(t.startsWith("chrome://")||t.startsWith("chrome-extension://")||t.startsWith("about:")||t.startsWith("file://"))}async getTab(t){return new Promise(n=>{chrome.tabs.get(t,r=>{chrome.runtime.lastError?n(null):n(r)})})}downloadScreenshot(t,n){let r=t;r.startsWith("data:")||(r=`data:image/png;base64,${t}`),chrome.downloads.download({url:r,filename:n,saveAs:!1},s=>{chrome.runtime.lastError&&console.error(`[DOM Settlement] Failed to download screenshot: ${chrome.runtime.lastError.message}`)})}downloadJson(t,n){const r=JSON.stringify(t,null,2),s=new TextEncoder().encode(r),a=`data:application/json;base64,${btoa(String.fromCharCode(...s))}`;chrome.downloads.download({url:a,filename:n,saveAs:!1},c=>{chrome.runtime.lastError&&console.error(`[DOM Settlement] Failed to download JSON: ${chrome.runtime.lastError.message}`)})}}const Vp=()=>{let e=Sn();return e||(e=new zp({}),oi(e),setInterval(()=>{l.dispatch(si())},30*1e3)),e},Hp=()=>{chrome.tabs.onRemoved.addListener(e=>{l.dispatch(ai(e))}),chrome.tabs.onUpdated.addListener((e,t,n)=>{if(t.url&&n.url){const r=Sn();r&&r.handleDomainChange(e,n.url)}})};let Wa=null;const Ba=/^(chrome-extension:\/\/[^/]+\/|chrome:\/\/|extension:\/\/|edge:\/\/|opera:\/\/settings|arc:\/\/extensions\/|[^:]+:\/\/extensions\/).*/,dr=async(e,t,n="click",r)=>{var i,d,u,h,_,b,E,O,T,R,P,J,re;let s,a,c=null;try{t?s=t:s=await Dt(),a=(()=>{const{base64Image:S,...U}=s;return U})(),c=(s==null?void 0:s.base64Image)??null,n==="click"&&(Wa=c)}catch(S){const U=await Tn(),le={timestamp:e.timestamp,scribeId:U.scribeId,privacyScreen:U.privacyScreen};(i=S==null?void 0:S.message)!=null&&i.includes("This request exceeds the MAX_CAPTURE_VISIBLE_TAB_CALLS_PER_SECOND quota.")?(c=Wa,D("fallback_screenshot_taken")):(z("screenshot_upload_failed",{errorMessage:S==null?void 0:S.message}),D("screenshot_upload_failed",{reason:"chrome_failed_screenshot_capture",errorName:(d=S==null?void 0:S.metadata)==null?void 0:d.errorName,errorMessage:S==null?void 0:S.message,errorStack:S==null?void 0:S.stack,screenshot_data:le,actionUrl:e.url,fallbackMethodCaptureUrl:(u=S==null?void 0:S.metadata)==null?void 0:u.fallbackMethodCaptureUrl,x:(h=e==null?void 0:e.position)==null?void 0:h.x,y:(_=e==null?void 0:e.position)==null?void 0:_.y,selector:e==null?void 0:e.target_selector,screenshotAttemptId:(s==null?void 0:s.attemptId)??((b=S==null?void 0:S.metadata)==null?void 0:b.screenshotAttemptId)??null,captureDuration:((E=S==null?void 0:S.metadata)==null?void 0:E.captureDuration)||null,failDuration:((O=S==null?void 0:S.metadata)==null?void 0:O.failDuration)||null,wasEarlyScreenshot:(s==null?void 0:s.wasEarlyScreenshot)??!1,wasFallback:(s==null?void 0:s.wasFallback)??((T=S==null?void 0:S.metadata)==null?void 0:T.wasFallback)??null,didNotAttemptFallback:(R=S==null?void 0:S.metadata)==null?void 0:R.didNotAttemptFallback,was_in_iframe:(e==null?void 0:e.was_in_iframe)??null}),l.dispatch(Qr({tempId:e.tempId,partialAction:{failed_ss:!0,screenshot_upload_status:oe.UPLOAD_STATUS.ERROR}})))}if(c){const S=c==null?void 0:c.split(",")[1],{scribeId:U,privacyScreen:le}=await Tn(),{domUpload:fe}=r||Re(l.getState());if(n==="click"&&e.domString&&fe){const K=((re=(J=(P=l.getState())==null?void 0:P.auth)==null?void 0:J.userData)==null?void 0:re.email)||null;jc(j,U,e.tempId,e.domString,e.timestamp,0,null,le,K).catch(ve=>{const Le={...ve},$e={scribeId:U,timestamp:e.timestamp};D("dom_upload_queued_for_retry",{dom_data:$e,error:ve.message}),z("dom_upload_queued_for_retry",Le)})}Xr(U,le,e.tempId,S,e.timestamp,0,a).catch(K=>{const ve={...K},Le={scribeId:U,timestamp:e.timestamp,privacyScreen:le};D("screenshot_upload_queued_for_retry",{screenshot_data:Le,error:K.message}),z("screenshot_upload_queued_for_retry",ve)})}},Ga=(e,t,n)=>{var _;const r=["domString","action.key"],s=ii.omit({...e},r),a=H(l.getState());D("action_captured",s);const c=l.getState(),{status:i}=he(c),d=Re(c);if(i===ae.PAUSED_RECORDING||i===ae.ENDING_RECORDING||i===ae.IDLE){n();return}const u={...e.action,favIconUrl:t.tab&&t.tab.favIconUrl,tabId:t.tab&&t.tab.id,tempId:Ue()},{domString:h}=u;if(delete u.domString,a.actionsQueue.length===0&&u.url&&!((_=En(c))!=null&&_.scribeId)&&(Ba.test(u.url)||Yr(u)),u.kind===oe.MOUSE_ACTIONS.START_DRAG)Ae(u);else if(u.kind===oe.MOUSE_ACTIONS.END_DRAG)Ae({...u,screenshot_url:null,dom_url:null,screenshot_upload_status:oe.UPLOAD_STATUS.WAITING}),(async()=>{const b=await Dt(),E=(()=>{const{base64Image:T,...R}=b;return R})(),O=(b==null?void 0:b.base64Image)??null;if(O){const T=O==null?void 0:O.split(",")[1],{scribeId:R,privacyScreen:P}=await Tn();Xr(R,P,u.tempId,T,u.timestamp,0,E).catch(J=>{const re={...J},S={scribeId:R,timestamp:u.timestamp,privacyScreen:P};D("screenshot_upload_queued_for_retry",{screenshot_data:S,error:J.message}),z("screenshot_upload_queued_for_retry",re)})}})();else if(u.kind===oe.MOUSE_ACTIONS.CANCEL_DRAG)Ae(u);else if(u.kind===oe.MOUSE_ACTIONS.CLICK)Ae({...u,screenshot_url:null,dom_url:null,screenshot_upload_status:oe.UPLOAD_STATUS.WAITING}),(async()=>{let b;if(u!=null&&u.earlyScreenshotTimestamp){const E=`early-screenshot-${u.earlyScreenshotTimestamp}`,O=await new Promise(async T=>{let R=0;for(;R<5;){const P=(await chrome.storage.session.get(E))[E];if(P){chrome.storage.session.remove(E),T(P);break}R++,await new Promise(J=>{setTimeout(J,200)})}});O&&(b={base64Image:O,attemptId:Math.random().toString(),successDuration:0,wasEarlyScreenshot:!0,wasFallback:!1,didNotAttemptFallback:!0})}u.domString=h,await dr(u,b,"click",d)})();else if(u.kind===oe.KEYBOARD_ACTIONS.PRESS){const{modifiers:b={}}=u,{shiftKey:E=!1,altKey:O=!1,ctrlKey:T=!1,metaKey:R=!1}=b,P=[E,O,T,R].filter(Boolean).length;(P>1||P>0&&!E)&&d.screenshotWithKeyboardCombo===!0?(Ae({...u,screenshot_url:null,dom_url:null,screenshot_upload_status:oe.UPLOAD_STATUS.WAITING}),(async()=>await dr(u,null,"keyboard_combo",d))()):Ae(u)}else u.kind===oe.INPUT_BLUR?(Ae({...u,screenshot_url:null,dom_url:null,screenshot_upload_status:oe.UPLOAD_STATUS.WAITING}),(async()=>await dr(u,null,"click",d))()):Ae(u)},Jp=(e,t,n)=>{const r=l.getState(),s=H(r),a=En(r),c=dt(r)&&Re(r).audioLiveTranscription,i=d=>{const u=dt(d)&&Re(d).audioLiveTranscription;return In(H(d).actionsQueue,Te(d).os,Zr(d),!!u)};return((d,u)=>{if(u)return!1;switch(d){case kn.AUDIO_ONLY:return c&&s.actionsQueue.length===0;case kn.ALWAYS:return s.actionsQueue.length===0;case kn.NEVER:return!1;default:return!1}})(e.setFirstAction,!!(a!=null&&a.scribeId))?(ee().then(d=>{d&&!Ba.test((d==null?void 0:d.url)||"")&&Yr({url:d.url??"",tabId:d.id??0}),n({actions:i(l.getState()),deletedActionIds:H(l.getState()).deletedActionIds||[]})}),!0):(n({actions:i(l.getState()),deletedActionIds:H(l.getState()).deletedActionIds||[]}),!1)},Kp=e=>Iu(hc,e),Yp=e=>ku(mc,e);function za(e,t){const{extensionSidepanel2024q1:n}=Re(l.getState()),r=ci()||0;if(n||r>128){const s={url:e.startingUrl||"",id:e.scribe.id,name:e.scribe.name,location:e.location,actionIndex:e.scribe.actionIndex||""};l.dispatch(li(s)),e.isOnPages?(chrome.action.setPopup({popup:"src/scripts/confirm-guide-me/index.html"}),chrome.action.openPopup(),chrome.action.setPopup({popup:""})):chrome.windows.getLastFocused({populate:!1},a=>{a.id&&(e.targetWindowId=a.id,ja(e,j))})}else Mp(e,j)}const Va=async()=>{const{suggestedScribesPollingTime:e}=await chrome.storage.local.get("suggestedScribesPollingTime");return e},Xp=async(e=!1)=>{const{lrr2025:t}=Re(l.getState()),n=zr(t),r=await qc();if(!n||!r)return;const s=await Va(),a=n.recommendation_refresh_hours_interval*60*60*1e3,c=Math.floor(Math.random()*60*60*1e3),i=a+c;!e&&s&&s>Date.now()||chrome.storage.local.set({suggestedScribesPollingTime:Date.now()+i})},Qp=5*60*1e3,Zp=async()=>{setInterval(async()=>{await Va()},Qp)};Zp();var eg=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};eg.SENTRY_RELEASE={id:"c7e5656e859d02ad6b0b543cae8f4abd4f8ff10c"};const tg=()=>{const e=performance.now();let t=0;for(let r=1;r<6e6;r++)t+=Math.sqrt(r)*Math.sin(r%360)*Math.cos(Math.random()*r)/(Math.log(r+1)+1);const n=performance.now();return globalThis.cpuResult=t,Math.floor(n-e)},ur=async()=>{var n,r;On(),await chrome.storage.local.remove("persist:localStorage"),l.dispatch({type:"PURGE_REDUX"});const e=await vi();l.dispatch(rp(e)),await Xt(),fg(),await Mn(),await Ve(),chrome.runtime.getPlatformInfo(s=>{s&&l.dispatch(tp(s.os))});const t=tg();l.dispatch(sp({bench:t,cores:(navigator==null?void 0:navigator.hardwareConcurrency)??null,rtt:((n=navigator==null?void 0:navigator.connection)==null?void 0:n.rtt)??null,downlink:((r=navigator==null?void 0:navigator.connection)==null?void 0:r.downlink)??null})),(await kc()).isSupported||(Un("recordingControlsPreference","floating-button"),chrome.runtime.sendMessage({messageType:"optionsChanged"})),Os().then(s=>{Array.isArray(s)||Cc([])})};chrome.runtime.onStartup.addListener(async()=>{await ur(),nt({callSource:"onStartup listener"}).then(e=>{e&&to()}),tt(),await es.flush(),chrome.runtime.reload()}),chrome.runtime.onInstalled.addListener(async e=>{e.reason===chrome.runtime.OnInstalledReason.INSTALL?(ur(),z("installed_extension"),D("extension_installed"),chrome.runtime.setUninstallURL(di)):e.reason===chrome.runtime.OnInstalledReason.UPDATE&&ur(),nt({callSource:"onInstalled listener"}).then(t=>{t&&to(),e.reason===chrome.runtime.OnInstalledReason.INSTALL&&sg(t)})});const pr=async()=>{const{permissions:e,origins:t}=await chrome.permissions.getAll(),n=t.includes("<all_urls>");return n||D("permissions_missing",t,e),l.dispatch(ap(!n)),n},ng=e=>{chrome.action.getUserSettings().then(t=>{(e==null?void 0:e.extension_currently_pinned)!==t.isOnToolbar&&(j.patch("/users/growth_state/",{extension_currently_pinned:t.isOnToolbar}),z(t.isOnToolbar?"extension_pinned":"extension_unpinned"))})},nt=async e=>{var t;try{await ui();const[n,r,s]=await Promise.all([j.get("/users/"),j.get("/users/growth_state/"),j.get("/users/user_settings/")]);return n&&n.status===200?(Ip(n.data),l.dispatch(xt(n.data)),l.dispatch(pi(s==null?void 0:s.data)),n.data&&(D("user_logged_in",{email:n.data.email,...e}),gi({email:n.data.email}),hi(n.data,r==null?void 0:r.data),(t=r==null?void 0:r.data)!=null&&t.installed_extension?l.dispatch(ts(r==null?void 0:r.data)):(j.patch("/users/growth_state/",{installed_extension:!0}),l.dispatch(ts({...r==null?void 0:r.data,installed_extension:!0}))),l.dispatch(mi({api:j})),ng(r==null?void 0:r.data),Vp()),n.data):(l.dispatch(xt(null)),null)}catch(n){if(await tt())return l.dispatch(xt(null)),null;$({title:"Error fetching user",err:n}),console.error("Error fetching user",n)}return null},rg=async()=>{var t;let e=!1;try{(t=await chrome.storage.managed.get())!=null&&t.SuppressWelcomeTab&&(e=!0)}catch(n){console.error("Error checking managed storage for SuppressWelcomeTab:",n),$({title:"Error checking managed storage for SuppressWelcomeTab",error:n})}return e},sg=async e=>{if(!fi){if(await rg()){D("suppress_welcome_tab_managed_policy_set");return}e?chrome.tabs.query({currentWindow:!0}).then(t=>{t=t.filter(n=>n.url.includes(Cn())),t.length>0?chrome.tabs.update(t[0].id,{highlighted:!0,url:ns()}):chrome.tabs.create({url:ns()})}):chrome.tabs.create({url:yi()})}},Ha=(e,t,n)=>{var d;l.dispatch(An());const{networkError:r,s3ConnectionError:s,backendConnectionError:a,networkOrServerError:c}=ot(l.getState());e.targetTaskId&&l.dispatch(xn(e.targetTaskId));const i=u=>{D("browser_start_recording",e),l.dispatch(Pn(e.source)),vt(u,void 0,e.entryPoint),n({isRecording:!0})};if(!_e(l.getState())){if(e.startRecordingFromNewTab||e.startRecordingFromUrl){const u=e.startRecordingFromUrl&&e.url?e.url:bs;chrome.tabs.create({url:u}).then(h=>{if(r||s||a){l.dispatch(bt(!0)),l.dispatch(Fe(!0)),D("create_new_tab_error",c);return}h.status==="complete"?i(h):Rg(h,i)})}else e.targetTabId&&chrome.tabs.query({}).then(u=>{u=u.filter(h=>h.id===e.targetTabId),chrome.extension.isAllowedFileSchemeAccess().then(h=>{if(u.length>0&&!Ee(u[0].url,h)){if(chrome.tabs.update(u[0].id,{active:!0}),chrome.windows.update(u[0].windowId,{focused:!0}),r||s||a){D("browser_initiated_recording_failed",{networkOrServerError:c}),l.dispatch(bt(!0));return}i(u[0])}else n({isRecording:!1,isAllowedFileSchemeAccess:h})})});if(Xe()){const u=e.targetTabId||((d=t==null?void 0:t.tab)==null?void 0:d.id);e.targetWindowId?ct(e.targetWindowId,q.Recorder,{frontendUrl:G.FRONTEND_URL}):u?ye(u,q.Recorder,{frontendUrl:G.FRONTEND_URL}):D("side_panel_not_opened",{reason:"No target tab nor window ID provided",request:e,sender:t,function:"browserStartRecording"})}return chrome.action.setPopup({popup:""}),!0}},gr=(e,t,n,r=!1)=>{var u;const{networkError:s,s3ConnectionError:a,backendConnectionError:c,networkOrServerError:i}=ot(l.getState()),d=h=>{D("edit_recording_for",e),z("edited_file_add_recording",{platform:_s(),capture_type:"extension",file_id:e.scribeId});const _=r?"recapture":void 0;vt(h,e.scribeId,_),n({status:"success"})};if(!_e(l.getState())){if(ee().then(h=>{l.dispatch(tc(h==null?void 0:h.id))}),!e.startRecordingFromNewTab&&e.targetTabId)Xe()&&!r&&ye(e.targetTabId||((u=t.tab)==null?void 0:u.id),q.Recorder,{frontendUrl:G.FRONTEND_URL}),chrome.tabs.query({}).then(h=>{h=h.filter(_=>_.id===e.targetTabId),chrome.extension.isAllowedFileSchemeAccess().then(_=>{if(h.length>0&&!Ee(h[0].url,_)){if(chrome.tabs.update(h[0].id,{active:!0}),chrome.windows.update(h[0].windowId,{focused:!0}),s||a||c){D("browser_initiated_recording_failed",{networkOrServerError:i}),l.dispatch(bt(!0));return}d(h[0])}else n({isRecording:!1,isAllowedFileSchemeAccess:_})})});else{e.targetWindowId&&Xe()&&!r&&ct(e.targetWindowId,q.Recorder,{frontendUrl:G.FRONTEND_URL});const h=bs;chrome.tabs.create({url:h}).then(_=>{if(s||a||c){l.dispatch(bt(!0)),l.dispatch(Fe(!0)),D("create_new_tab_error",{networkOrServerError:i});return}d(_)})}return!0}n({status:"error",details:"Already recording."})},hr=e=>{e.scribeId&&l.dispatch(Dn(e)),e.entryPoint&&l.dispatch(us(e.entryPoint)),e.taskId?l.dispatch(xn(e.taskId)):l.dispatch(xn("")),l.dispatch(Di(!!e.isScribeEditMode)),chrome.action.setPopup({popup:"src/scripts/tab-selector/index.html"}),chrome.action.openPopup(),chrome.action.setPopup({popup:""})};async function Ja(e){l.dispatch(nc(e))}const ag=(e,t,n)=>{var s,a,c;if(e.messageType==="selectMicrophone"&&e.microphoneId&&(Ja(e.microphoneId),n({status:"success"})),e.messageType==="getAuthToken")return rc().then(i=>{n(i)}),!0;if((e==null?void 0:e.messageType)==="startCopilot"){l.dispatch(At(!0));const i={};e!=null&&e.copilotPrompt&&(i.copilotPrompt=e.copilotPrompt),e!=null&&e.copilotSuggestionsTitle&&(i.copilotSuggestionsTitle=e.copilotSuggestionsTitle),e!=null&&e.copilotSuggestionsSubtitle&&(i.copilotSuggestionsSubtitle=e.copilotSuggestionsSubtitle),e!=null&&e.copilotSuggestedPrompts&&(i.copilotSuggestedPrompts=e.copilotSuggestedPrompts),e!=null&&e.copilotSearch&&(i.copilotSearch=e.copilotSearch),ye((s=t.tab)==null?void 0:s.id,q.Copilot,{queryParams:i})}if(e.messageType==="submitCopilotPrompt"&&(qa(e.sessionId),l.dispatch(An),!_e(l.getState())))return ee().then(i=>{l.dispatch(Pn(e.source)),chrome.extension.isAllowedFileSchemeAccess().then(d=>{i&&!Ee(i.url,d)?(vt(i,null,Ft.EXTENSION),n({isRecording:!0})):n({isRecording:!1,isAllowedFileSchemeAccess:d})})}),!0;if(e.messageType==="getDomForCopilot"&&qa(),e.messageType==="toggleDropdownExtension"){const i=sc(l.getState());l.dispatch(Fe(!i));return}if(e.messageType==="currentVisibleAction"&&(Ut(!0),vc(e.action)),e.messageType==="guideMeStepForward"){ee().then(i=>{chrome.tabs.sendMessage(i.id,{messageType:"guideMeStepForward"})});return}if(e.messageType==="setIsAutopilot"){ee().then(i=>{chrome.tabs.sendMessage(i.id,{messageType:"setIsAutopilot",isAutopilot:e.isAutopilot})});return}if(e.messageType==="navigateActiveTabToActionUrl"){const i=(a=e==null?void 0:e.action)==null?void 0:a.url;i&&chrome.tabs.query({active:!0,lastFocusedWindow:!0},d=>{try{chrome.tabs.update(d[0].id,{url:i})}catch(u){console.error("Error updating tab with url",u)}})}if(e.messageType==="checkForLocalStorageScribes")return On().then(i=>{n({localScribeDetected:i})}),!0;if(e.messageType==="discardLocalStorageScribes"&&(Ye(),n({message:"discarded"})),e.messageType==="getGuideMeSessionId")return wc().then(i=>{n({sessionId:i})}),!0;e.messageType==="setIsGuiding"&&(Ut(e.isGuiding),e.isGuiding===!1&&Mt()),e.messageType==="removeLiveOverlay"&&Mt(),e.messageType==="launchRecommendedScribes"&&Qt(e.url);const r=_e(l.getState());if(e.messageType&&e.messageType!=="editRecordingFor")if(e.messageType==="browserStartRecording")Ha(e,t,n);else if(e.messageType==="browserStopRecording")chrome.tabs.create({url:"https://scribehow.com/billing"}),en();else if(e.messageType==="browserDeleteRecording")en(e.isCopilot);else if(e.messageType==="browserCompleteCapture")D("browser_complete_capture",{...e,isRecording:r,recordingControls:(c=Be(l.getState()))==null?void 0:c.recordingControlsPreference}),r&&ut({isCopilot:e.isCopilot,copilotPrompt:e.copilotPrompt,isLocalScribe:e.isLocalScribe,isLocalImageRetry:e.isLocalImageRetry,deletedActionIds:e.deletedActionIds});else if(e.messageType==="browserPauseCapture")r&&no();else if(e.messageType==="browserBlurCapture")chrome.tabs.query({active:!0,currentWindow:!0}).then(i=>{chrome.tabs.sendMessage(i[0].id,{messageType:"toggleBlurControls"})});else if(e.messageType==="action"){Ga(e,t,n);return}else e.messageType==="updateSidepanelContentUrl"&&ee().then(i=>{var h,_;const d=(_=(h=e.url)==null?void 0:h.match(/\?url=(.*)/))==null?void 0:_[1],u=(i==null?void 0:i.url)||d;ac(e==null?void 0:e.url),u&&(e!=null&&e.url.includes(q.Assistant))&&(e.copilotEntry||ye(i==null?void 0:i.id,q.Assistant,{queryParams:{url:u},frontendUrl:G.FRONTEND_URL}))});if(e.messageType==="openPopup"&&hr(e),e.messageType==="recaptureStep"&&ee().then(i=>{if(i){const d={...e,isStepRecapture:!0,targetTabId:i.id,targetWindowId:i==null?void 0:i.windowId,stepRecaptureDescription:e.description};l.dispatch(Dn(d)),gr(d,t,n,!0)}}),e.messageType==="openScribeViewer"&&za(e),e.messageType==="cleanupDomFromCopilot"&&chrome.tabs.query({},i=>{i.forEach(d=>{chrome.scripting.executeScript({target:{tabId:d.id},func:()=>{var u;(u=document==null?void 0:document.querySelectorAll("[_i_d]"))==null||u.forEach(h=>h==null?void 0:h.removeAttribute("_i_d"))}})})}),e.messageType==="openSidePanel"&&ye(t.tab.id,e.route,{frontendUrl:G.FRONTEND_URL}),e.messageType==="setSidePanelRoute"&&(at(l.getState())&&l.dispatch(At(!1)),e.entryPoint&&e.entryPoint===Ft.VIEWER_INTRO_PAGE&&chrome.tabs.query({},i=>{const[d]=i.filter(u=>u.url&&u.url.includes("/intro-viewer"));d&&chrome.tabs.update(d.id,{url:vs()},()=>{chrome.runtime.lastError&&console.error("Error updating tab:",chrome.runtime.lastError)})}),oc(e.route)),e==="version"){n(chrome.runtime.getManifest().version);return}if(e==="options"){n(Be(l.getState()));return}if(e==="checkPermissions")return nt({callSource:"checkPermissions message handler"}).then(i=>{i?n(!0):pr().then(d=>{n(d),l.dispatch(Fe(!d))})}),!0;if(e.messageType==="checkServerAvailability")return tt().then(i=>{n(i)}),!0;if(e==="startRecording"){if(!r)return chrome.tabs.query({active:!0,currentWindow:!0}).then(i=>{vt(i[0]),n({status:"success"})}),!0;n({status:"error",details:"Already recording."});return}if(e.messageType==="editRecordingFor"&&(l.dispatch(Dn(e)),gr(e,t,n)),e==="stopRecording"){r&&ut();return}if(e.messageType==="openUrl"&&chrome.tabs.create({url:e.url}),e.messageType==="highlightElementWithId"){l.dispatch(ic(e.elementId)),chrome.tabs.query({active:!0,currentWindow:!0},function(i){var d;i&&((d=i[0])!=null&&d.id)&&chrome.tabs.sendMessage(i[0].id,{messageType:"highlightElementWithId",elementId:e.elementId,url:e.url,hasScreenshot:e.hasScreenshot,modalInstruction:e.modalInstruction,sessionId:e.sessionId,requestId:e.requestId})});return}if(e.messageType==="highlightAIFallbackElement"){ee().then(i=>{chrome.tabs.sendMessage(i.id,{messageType:"highlightAIFallbackElement",elementId:e.elementId})});return}if(e.messageType==="userEditPermission"){ee().then(i=>{chrome.tabs.sendMessage(i.id,{messageType:"userEditPermission",canEdit:e.canEdit}),Sc(e.canEdit)});return}if(e.messageType==="removeCopilotClickTarget"&&(e.targetTabId?chrome.tabs.sendMessage(e.targetTabId,{messageType:"removeCopilotClickTarget"}):ee().then(i=>{chrome.tabs.sendMessage(i.id,{messageType:"removeCopilotClickTarget"})})),e.messageType==="startCopilotGenerating"&&ee().then(i=>{chrome.tabs.sendMessage(i.id,{messageType:"startCopilotGenerating"})}),e.messageType==="stopCopilotGenerating"&&ee().then(i=>{chrome.tabs.sendMessage(i.id,{messageType:"stopCopilotGenerating"})}),e==="enableExtensionNotifications")return chrome.permissions.contains({permissions:["notifications"]},function(i){i?n({status:"enabled"}):chrome.permissions.request({permissions:["notifications"]},function(d){n(d?{status:"enabled"}:{status:"disabled"})})}),!0;if(e==="isRecording"){n(r);return}if(e==="getTabs")return ps().then(i=>n(i)),!0;if(e.messageType==="getLastFocusedWindow")return chrome.windows.getLastFocused({populate:!1},i=>{n(i)}),!0;if(e==="getRecordingState")return n(H(l.getState())),!0;if(e.messageType==="openTabSelector")return chrome.tabs.create({url:"src/scripts/tab-selector/index.html"}),!0;if(e.messageType==="initializeRecordingPreview")return Jp(e,t,n);if(e.messageType==="updateAction"&&l.dispatch(cc(e.action)),e==="getExtensionState"){const{status:i}=he(l.getState()),d=Be(l.getState());n({installed:!0,options:d,status:i,version:chrome.runtime.getManifest().version});return}n({unsupportedMessage:!0})};Yp(function(e,t,n){return ag(e,t,n)});const og=new La(2e3),ig=async({removed:e,cookie:t,cause:n})=>{wi(t.domain)&&(t.name===Si||t.name===Ei)&&t.path===Ti&&n!=="overwrite"&&(e&&await Ii(t)?(l.dispatch(xt(null)),chrome.tabs.query({}).then(r=>{const s={messageType:"loggedOut"};r.forEach(a=>Z(a,s))}),l.dispatch(ki()),is(q.Home),G.FRONTEND_URL=cs.FRONTEND_URL,G.BACKEND_BASE_URL=cs.BACKEND_BASE_URL):og.invoke(()=>{nt({callSource:"cookieChangedListener",cause:n})}))};chrome.cookies.onChanged.addListener(ig),chrome.cookies.onChanged.addListener(_i);const cg=async()=>{if(chrome!=null&&chrome.notifications){const e=await j.get("/notifications/get/");if(e.status===200&&e.data.hasOwnProperty("description")){const t=Ue();l.dispatch(np({notifId:t,res:e.data.url})),chrome.notifications.create(t,{type:"basic",iconUrl:"https://colony-labs-public.s3.us-east-2.amazonaws.com/images/logo/extension.svg",title:e.data.title,message:e.data.description})}}};(co=chrome==null?void 0:chrome.notifications)==null||co.onClicked.addListener(function(e){const{linkMap:t}=Te(l.getState());e in t&&(chrome.tabs.create({url:t[e]}),delete t[e])});const lg=()=>{chrome.tabs.query({}).then(e=>{e.forEach(t=>{chrome.action.setBadgeText({text:"",tabId:t.id})})})},dg=()=>{chrome.tabs.create({url:Cn()})},ug=()=>{chrome.tabs.create({url:vs()})},pg=()=>{chrome.tabs.create({url:lc}),Ye()},mr=()=>!_e(l.getState()),Ka=e=>{var t,n,r,s;return e?((t=e.pendingUrl)==null?void 0:t.startsWith("chrome://newtab/"))||((n=e.url)==null?void 0:n.startsWith("chrome://newtab/"))||((r=e.pendingUrl)==null?void 0:r.startsWith("edge://newtab/"))||((s=e.url)==null?void 0:s.startsWith("edge://newtab/")):!1},gg=async e=>{var a;const t=dc(l.getState()),n=H(l.getState());if(!t)return Promise.resolve(e);let r=null,s=null;try{r=await chrome.tabs.get(e)}catch(c){s=c}if(!r)return Promise.reject(`No tab was found with an id ${e}: ${s}`);if(!r.pendingUrl&&!r.url)return Promise.reject(`Tab has no valid URLs ${r}`);if(n.actionsQueue.length!==0){if((r.pendingUrl&&Ee(r.pendingUrl)||r.url&&Ee(r.url))&&!Ka(r)||((a=n.currentTab)==null?void 0:a.id)===e||!r.title&&!r.url)return Promise.resolve(e);Ae({kind:"instruction",description:Ka(r)?"Open a new tab":`${oe.SPECIAL_INDICATORS.SWITCH_TO_TAB_PREFIX}${r.title}"`,tabId:e,tempId:Ue()})}return!n.recordedTabs.find(c=>c===e)&&r.title&&Xa(r).then(()=>{l.dispatch(Ln({tab:r,host:Nt(r==null?void 0:r.url),url:r==null?void 0:r.url}))}),Promise.resolve(e)},hg=new La(150),mg=(e,t)=>{const{currentFocusedActiveTabId:n}=he(e),{currentFocusedActiveTabId:r}=he(t),s=H(t);n!==r&&gg(r).catch(console.error),t.recordingState.scribeId&&hg.invoke(()=>{var i,d;const a=dt(t)&&Re(t).audioLiveTranscription,c=In(H(t).actionsQueue,Te(t).os,Zr(t),a);chrome.runtime.sendMessage({messageType:"extensionStateUpdate",data:{actions:c,scribeId:t.recordingState.scribeId,audioRecordingEnabled:a,audioError:s.audioError,isTranscriberReady:s.isTranscriberReady,availableMicrophones:((i=t.microphones)==null?void 0:i.availableMicrophones)??[],selectedMicrophoneId:((d=t.microphones)==null?void 0:d.selectedMicrophoneId)??null,deletedActionIds:t.recordingState.deletedActionIds||[]}})})};er(l,mg);const fg=()=>{chrome.tabs.query({}).then(async e=>{e.forEach(async t=>{if(t!=null&&t.url&&!Ee(t.url))try{await Ya(t.id)}catch{}})})},Ya=async e=>{await chrome.scripting.executeScript({target:{tabId:e,allFrames:!0},files:[Na]}),await chrome.scripting.executeScript({target:{tabId:e},files:[Fa]})},Xa=async e=>{const{areaSelectorRecording:t}=Re(l.getState()),{liveBlurEnabled:n,liveBlurSettings:r}=Lt(l.getState()),s=Nt(e==null?void 0:e.url),a=dt(l.getState()),c={host:null,href:null,retried:!1},i=e.url?e.url:e.pendingUrl,d=Xe(),u=uc();if(Ee(i))return c;await nt({callSource:"startRecordingOnTab"}),l.dispatch(Nn(e.id));try{return await Z(e,{messageType:"startRecording",areaSelectorRecording:t,liveBlurEnabled:n,liveBlurSettings:r,liveTranscriptions:d,audioRecordingEnabled:a}),u&&ws(),D("recording_started_on_tab",{...e,voiceTranscriptionEnabled:a}),{host:s,href:e==null?void 0:e.url,retried:!1}}catch(h){D("recording_started_on_tab_failed",{tab:e,voiceTranscriptionEnabled:a,error:h,errorMessage:h==null?void 0:h.message}),console.warn("first start recording on tab attempt failed",h)}try{return await Ya(e.id),await Z(e,{messageType:"startRecording",omitStart:!0,areaSelectorRecording:t,liveBlurEnabled:n,liveBlurSettings:r,liveTranscriptions:d,audioRecordingEnabled:a}),u&&ws(),D("recording_started_on_tab_second_attempt",e),{host:s,href:e==null?void 0:e.url,retried:!0}}catch(h){D("recording_started_on_tab_failed",{tab:e,error:h,errorMessage:h==null?void 0:h.message}),console.warn("second start recording on tab attempt failed",h)}return z("start_recording",{recorder:"extension",url:e.url}),{...c,retried:!0}},vt=async(e,t,n)=>{var d;Ye();const r=at(l.getState()),s=Nt(e==null?void 0:e.url);os(),as();const{networkOrServerError:a}=ot(l.getState());D("recording_started",{...e,networkOrServerError:a,recordingControls:(d=Be(l.getState()))==null?void 0:d.recordingControlsPreference}),l.dispatch(pc({currentTab:e,startTimestamp:Date.now()})),t?(l.dispatch(Ss(t)),l.dispatch(Es(!1))):(l.dispatch(Ss(Ue())),l.dispatch(Es(!0))),await Xa(e);try{const u=Sn();if(u&&(e!=null&&e.id)){const h=H(l.getState()).scribeId;u.associateCapturesWithScribe(e.id,h),u.uploadInitialScreenshotToS3(e.id,h).then(_=>{_&&console.log("[DOM Settlement] Initial screenshot uploaded:",_)}).catch(_=>{console.error("[DOM Settlement] Failed to upload initial screenshot:",_)})}}catch(u){console.error("[DOM Settlement] Error in DOM settlement upload:",u)}n&&l.dispatch(us(n));let c=e.title;(!c||c==="New Tab"||c.indexOf("Scribe |")===0)&&(c="Untitled"),l.dispatch(ep(c)),l.dispatch(Ln({tab:e,host:s,url:e==null?void 0:e.url})),l.dispatch(ys(ae.RECORDING)),r||l.dispatch(fs(!0)),lg();const i=dt(l.getState());if(n==="recapture"){z("recapture_started",{recorder:"extension",url:e.url});return}chrome.runtime.sendMessage({messageType:"startRecording",target:"sidepanel",data:{liveTranscriptions:Xe(),frontendUrl:G.FRONTEND_URL,audioRecordingEnabled:i,inCopilotMode:r}})},en=(e=!1)=>{const t=H(l.getState());D("recording_deleted",t),Ye(),Rn({isCopilot:e})},yg=async e=>{try{const t=await j.post("/extension_injection/",{page_url:e});if(t.status===200)return t.data.should_inject}catch(t){console.error("Error fetching extension injection",t)}return!1},_g=1e3;setInterval(()=>{var e,t;(t=(e=chrome.runtime.sendMessage({messageType:rs.GetSidepanelActive}))==null?void 0:e.catch)==null||t.call(e,n=>{n.message.includes("Could not establish connection. Receiving end does not exist")?chrome.storage.local.set({sidepanelActive:!1}):console.error("error getting sidepanel state",n)})},_g),chrome.storage.local.onChanged.addListener(e=>{const t=e==null?void 0:e.sidepanelActive;if(t){if(!t.oldValue&&t.newValue){const{showSidepanelFob:r}=Be(l.getState());r&&chrome.tabs.query({},s=>{s.forEach(a=>{Z(a,{messageType:"sidepanelOpened"})})})}if(t.oldValue&&!t.newValue){const r=at(l.getState()),s=_e(l.getState());r&&s&&en(),fc().then(a=>{a&&(Ut(!1),en()),Mt(),chrome.tabs.query({},c=>{c.forEach(i=>{chrome.scripting.executeScript({target:{tabId:i.id},func:()=>{var d;(d=document==null?void 0:document.querySelectorAll("[_i_d]"))==null||d.forEach(u=>u==null?void 0:u.removeAttribute("_i_d"))}}),Z(i,{messageType:rs.SetSidepanelClosed}),Z(i,{messageType:"removeCopilotClickTarget"}),Z(i,{messageType:"stopCopilotGenerating"}),Z(i,{messageType:"stopDropPin"})})})})}}const n=e==null?void 0:e.hiddenFobDomains;n&&(chrome.tabs.query({},r=>{r.forEach(s=>{Z(s,{messageType:"hiddenFobDomainsUpdated",hiddenDomains:n.newValue})})}),chrome.runtime.sendMessage({messageType:"hiddenFobDomainsUpdated",hiddenDomains:n.newValue}))}),chrome.runtime.onConnect.addListener(e=>{e.onMessage.addListener(async(t,n)=>{var r,s,a,c,i,d,u,h,_,b,E,O;if(t.messageType==="openSidePanel"){if(t.route===q.Assistant&&!((a=(s=(r=n.sender)==null?void 0:r.url)==null?void 0:s.startsWith)!=null&&a.call(s,"http"))){const T=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});await ye((i=(c=n.sender)==null?void 0:c.tab)==null?void 0:i.id,t.route,{queryParams:{url:(d=T==null?void 0:T[0])==null?void 0:d.url,searchEntry:t.clickedFromSearch},frontendUrl:G.FRONTEND_URL})}else{const T=_e(l.getState())?q.Recorder:t!=null&&t.route?t.route:q.Home;(h=(u=n==null?void 0:n.sender)==null?void 0:u.url)!=null&&h.includes("chrome-extension://")?await ct((b=(_=n==null?void 0:n.sender)==null?void 0:_.tab)==null?void 0:b.windowId,T):await ye((O=(E=n.sender)==null?void 0:E.tab)==null?void 0:O.id,t.route,{queryParams:t.route===q.Assistant?{url:n.sender.url}:null,frontendUrl:G.FRONTEND_URL})}if(t.route===q.Assistant){let T="extension_dropdown_open_recommended_clicked";t.clickedFromSearch&&(T="extension_dropdown_open_search"),z(T,null,j)}else t.route===q.Recorder&&z("extension_dropdown_open_recorder_clicked",null,j)}})}),Kp((e,t,n)=>{var r,s;if(e.messageType==="browserStartRecording"){const a=En(l.getState());if(a.scribeId)gr({...e,...a},t,n);else{const{taskId:c}=H(l.getState());e.taskId=c,Ha(e,t,n)}}if(e.messageType==="openSidePanel"){ct(t.tab.windowId,e.route,{queryParams:e.queryParams,frontendUrl:G.FRONTEND_URL});return}if(e.messageType==="openGuideMeSidepanel"&&ja(e,j),e.messageType==="getTabSelectorData"){const a=xi();return n({allowMicrophone:a}),!0}if(e.messageType==="tldExtract"){let a;try{a=Is(e.url)}catch{}if(!a)try{a=new URL(e.url).host}catch{a=""}n({result:a})}return e.messageType==="speechTranscriber"?(Bp((r=e.payload)==null?void 0:r.message,(s=e.payload)==null?void 0:s.data).then(a=>{n(a)}),!0):(ss().then(async()=>{var d,u,h,_,b,E,O,T,R,P,J,re,S,U,le,fe,K,ve,Le,$e,rt;if(!e.messageType)return;if(e.messageType==="captureAdditionalScreenshot"){const{url:g,timestamp:m,contentScriptLoadTimestamp:p,type:o}=e,f=l.getState(),y=(u=(d=H(f))==null?void 0:d.actionsQueue)==null?void 0:u.at(-1);if(!y)return;if(o!=="initial"&&y.timestamp>=p){console.log("Skipping additional screenshot - last action happened after page started loading");return}const v=await Dt();if(!(v!=null&&v.base64Image))return;try{const{internal_url:w,download_url:A}=await Ai(v.base64Image);l.dispatch(Qr({tempId:y.tempId,partialAction:{additional_screenshot_data:{url:g,timestamp:m,type:o||"post_navigation",internal_url:w||null,download_url:A||null}}}))}catch(w){console.error("Failed to upload additional screenshot:",w)}}if(e.messageType==="runSuggestedScribeAnalysis"){Xp();return}if(e.messageType===Pc.messageType)return $n().then(g=>{n(g)}).catch(g=>{n({...Lc,payload:g.message})}),!0;if(e.messageType==="analyzeActions"){try{I({message:"analyze_actions_started",category:"analyze_actions",level:"info"});const g=await $n();I({message:"analyze_actions_response",category:"analyze_actions",level:"info",data:{response:g}}),I({message:"analyze_actions_payload",category:"analyze_actions",level:"info",data:{payload:g.payload}}),(_=(h=g.payload)==null?void 0:h.analysis)!=null&&_.patterns?I({message:"analyze_actions_patterns_found",category:"analyze_actions",level:"info",data:{patterns:g.payload.analysis.patterns}}):I({message:"analyze_actions_no_patterns",category:"analyze_actions",level:"info"}),n({success:!0,payload:g.payload})}catch(g){$(g,{tags:{component:"analyze_actions"},extra:{message:"[Analyze] Error analyzing actions"}}),n({success:!1,error:g.message})}return!0}if(e.messageType==="clearSuggestedScribes"){try{I({message:"suggested_scribes_clearing_pending",category:"suggested_scribes",level:"info"}),await Rs(),n({success:!0})}catch(g){$(g,{tags:{component:"suggested_scribes"},extra:{message:"[Suggested Scribes] Error clearing suggested scribes"}}),n({success:!1,error:g.message})}return!0}if(e.messageType==="long_running_recorder_action"){I({message:"long_running_recorder_action_received",category:"long_running_recorder",level:"info",data:{action:e.action}});const g=((b=t==null?void 0:t.tab)==null?void 0:b.id)??(t==null?void 0:t.tabId)??0,{action:m}=e;return m.kind===oe.KEYBOARD_ACTIONS.PRESS?$g(m,g):(io(g),St.delete(g),tn(m,g)),n({status:"success"}),!0}e.messageType==="selectMicrophone"&&e.microphoneId&&(Ja(e.microphoneId),n({status:"success"})),e.messageType==="audioDevicesEnumerated"&&(l.dispatch(Pi(e.devices)),n({status:"success"}));const{lastSentNotification:a}=Te(l.getState()),c=H(l.getState()),i=_e(l.getState());if(e.messageType==="getTabs")return ps().then(g=>n(g)),!0;if(e.messageType==="getAllWindows")return chrome.windows.getAll({populate:!1},g=>{n(g)}),!0;if(e.messageType==="getLastFocusedWindow")return chrome.windows.getLastFocused({populate:!1},g=>{n(g)}),!0;if(e.messageType==="removePopup"&&chrome.action.setPopup({popup:""}),e.messageType==="sidepanelClosed"&&(Ut(!1),Mt(),chrome.tabs.sendMessage({messageType:"stopDropPin"})),e.messageType==="liveTargetClicked"&&yc(),e.messageType==="trackGuideMeDom"&&_c({...e,api:j}),e.messageType==="reducedDom"&&bc(j,e.action,e.reducedDom),e.messageType==="shouldInjectScribeButton")return yg(t.tab.url).then(g=>{n(g)}).catch(()=>{n(!1)}),!0;if(e.messageType==="checkServerAvailability"&&tt(),e.messageType==="networkConnectionStatus"){const{isOnline:g}=e.data;return tt().then(m=>{if(!m){const{networkError:p,s3ConnectionError:o,backendConnectionError:f,networkOrServerError:y}=ot(l.getState()),v=!!(p||y),w=!!(o||f);chrome.runtime.sendMessage({messageType:"networkConnectionStatus",data:{isOnline:g,internetConnection:v,scribeServerError:w}})}chrome.runtime.sendMessage({messageType:"networkConnectionStatus",data:{isOnline:g,internetConnection:null,scribeServerError:null}})}),!0}if(e.messageType==="checkForLocalStorageScribes")return On().then(g=>{n({localScribeDetected:g})}),!0;if(e.messageType==="endAndSaveLocalStorageScribes")return Li().then(g=>{n({savingLocalScribe:g})}),!0;if(e.messageType==="discardLocalStorageScribes"&&(Ye(),n({message:"discarded"})),e.messageType==="getIsScribeEditMode"){const g=Ni(l.getState());n({isScribeEditMode:g})}if(e.messageType==="getEntryPoint"){const{entryPoint:g}=H(l.getState());n({entryPoint:g})}if(e.messageType==="requestFlags"&&n(Re(l.getState())),e.messageType==="getUserData"&&n(l.getState().auth.userData),e.messageType==="getUserGrowthState"){const g=Fi(l.getState());n(g)}if(e.messageType==="currentDomForCopilot"&&$p({dom:e.currentDom,url:e.url,sessionId:e.sessionId}),e.messageType==="widgetFetch"){const{url:g,method:m,body:p,params:o,headers:f,isAuthenticated:y}=e;return it(j,g,m,p,o,f,y).then(v=>{n(v)}),!0}if(["widgetOpenSelectModal","widgetOpenRecordModal","widgetSelectedFromModal","widgetCancelModal"].includes(e.messageType))if(e.messageType==="widgetOpenRecordModal")l.dispatch(gs(!0));else{if(e.messageType==="widgetSelectedFromModal")return Z(t.tab,e,()=>{n(!0)}),!0;if(e.messageType==="widgetCancelModal")return Z(t.tab,e,()=>{n(!0)}),!0}if(e.messageType==="closedGmailRecordModal")l.dispatch(gs(!1));else if(e.messageType==="requestDomainsReceived"){const{domains:g,currentRecommendedScribeCount:m}=Te(l.getState());g!==void 0&&(chrome.runtime.sendMessage({messageType:"scribeCountReceived",count:m}),n(!0));return}if(e.messageType==="trackEvent"){const{name:g,details:m}=e;z(g,m),n(!0);return}if(e.messageType==="trackNewRelicLog"){const{name:g,details:m}=e;D(g,m),n(!0);return}if(e.messageType==="trackMixpanelEvent"){const{name:g,details:m}=e;z(g,m),n(!0);return}if(e.messageType==="getStore"){n(l.getState());return}if(e.messageType==="changeLiveBlurSettings"){hs(e.liveBlurEnabled),l.dispatch(Ui(e.liveBlurSettings)),n({status:"success"});return}if(jp(e,t,n,l),e.messageType==="changeRecordAudioSetting"){const{audioRecordingEnabled:g}=e;l.dispatch(Mi(g)),n({status:"success"})}if(e.messageType===jt.CLOSE_AUDIO_TAB&&ms().then(g=>{g!=null&&g.id&&chrome.tabs.remove(g.id,()=>{chrome.runtime.lastError&&console.error(`Error closing tab: ${chrome.runtime.lastError.message}`)})}),e.messageType===jt.MICROPHONE_ERROR&&l.dispatch($i(e.errorType)),(e==null?void 0:e.messageType)==="startCopilot"&&(l.dispatch(At(!0)),ye((E=t.tab)==null?void 0:E.id,q.Copilot)),(e==null?void 0:e.messageType)==="startCopilotSearch"){const g=await ee();ye((O=t.tab)==null?void 0:O.id,q.Assistant,{queryParams:{copilotEntry:!0,url:g.url}})}if(e.messageType==="startDropPin"){ee().then(g=>{chrome.tabs.sendMessage(g.id,{messageType:"startDropPin"})});return}if(e.messageType==="stopDropPin"){ee().then(g=>{chrome.tabs.sendMessage(g.id,{messageType:"stopDropPin"})});return}if(e.messageType&&e.messageType.startsWith("popup")){if(D("popup_message",{messageType:e.messageType,...e}),e.messageType==="popupLogIn")pg();else if(e.messageType==="popupGoToMyLibrary")dg();else if(e.messageType==="popupGoToMyDocuments")ug();else if(e.messageType==="popupGoToOptionsPage")is(q.Options);else if(e.messageType==="popupStartRecord"){if(l.dispatch(At(!1)),e.source===ks.SIDEPANEL){const g=(T=await ji())==null?void 0:T.origin;if(Ee(g))return Za({openTabSelector:!0}),n({isRecording:!0}),!0;ye((R=t.tab)==null?void 0:R.id,q.Recorder)}if(l.dispatch(An),!_e(l.getState()))return ee().then(g=>{l.dispatch(Pn(e.source)),chrome.extension.isAllowedFileSchemeAccess().then(m=>{g&&!Ee(g.url,m)?(vt(g,null,Ft.EXTENSION),n({isRecording:!0})):n({isRecording:!1,isAllowedFileSchemeAccess:m})})}),!0}else if(e.messageType==="popupStopRecording")ut();else if(e.messageType==="popupOpenANewTab"){const g=`${Cn()}${i?"":"?intent=newrecording"}`;chrome.tabs.create({url:g})}else if(e.messageType==="popupDiscardRecordingWhileStopping"){l.dispatch(Pt(!1));const g=H(l.getState());D("recording_deleted",{...g,reason:"user_aborted_while_stopping"}),Rn()}return}if(e.messageType==="contentScriptLoaded"){const g=l.getState(),{userSettings:m}=pt(g),{areaSelectorRecording:p}=Re(g),{liveBlurEnabled:o,liveBlurSettings:f}=Lt(g),{status:y}=he(g);(!a||Date.now()-a>6e4)&&(m!=null&&m.extension_notifications_enabled)&&(cg(),l.dispatch(Qu(Date.now()))),n({recordingStatus:y,areaSelectorRecording:p,liveBlurEnabled:o,liveBlurSettings:f}),i&&((P=t.tab)==null?void 0:P.id)===c.currentTab.id&&l.dispatch(Ln({url:e.currentTab,host:e.currentHost})),(J=t.tab)!=null&&J.id&&((re=c.recordedTabs)==null?void 0:re.indexOf(t.tab.id))===-1&&i&&l.dispatch(Nn(t.tab.id));return}if((S=t.tab)!=null&&S.id&&["getIframePosition","assignIframeId"].indexOf(e.messageType)!==-1)return chrome.tabs.sendMessage(t.tab.id,e).then(g=>{n({...g,error:null})}).catch(g=>{n({error:g})}),!0;if(e.messageType==="optionsChanged"&&Xt(),e.messageType==="getSPSEnabled"){const{userData:g}=pt(l.getState());n((U=g==null?void 0:g.active_organization)==null?void 0:U.smart_privacy_screen_enabled)}if(e.messageType==="getCustomUrls"){n(G);return}if(e.messageType==="recordingControlsIndicatorPressed"){const{menuOpen:g}=Lt(l.getState());l.dispatch(gt(!g))}else if(e.messageType==="recordingControlsPausePressed")no();else if(e.messageType==="recordingControlsDeletePressed")l.dispatch(Pt(!0));else if(e.messageType==="recordingControlsDeleteConfirmPressed"){l.dispatch(Pt(!1));const g=H(l.getState());D("recording_deleted",{...g,reason:"user_aborted_capture"}),Ye(),Rn()}else if(e.messageType==="recordingControlsDeleteCancelPressed")l.dispatch(Pt(!1));else if(e.messageType==="recordingControlsScreenPositionPressed"){const{screenPositionMenuOpen:g}=Lt(l.getState());l.dispatch(Fn(!g))}else e.messageType==="recordingControlsScreenPositionClosed"?l.dispatch(Fn(!1)):e.messageType==="recordingControlsScreenPositionMenuButtonPressed"?(Cp("recordingControlsPosition",e.position),l.dispatch(gt(!1))):e.messageType==="recordingCompletedPressed"?(l.dispatch(gt(!1)),ut()):e.messageType==="recordingControlsClickOutside"?l.dispatch(gt(!1)):e.messageType==="recordingControlsScreenPositionMenuClickOutside"?l.dispatch(Fn(!1)):e.messageType==="endRecordingWithCutoffCancelGotItPressed"&&l.dispatch(qi(!1));if(e.messageType==="scribeViewerCollapse")z("scribe_viewer_collapsed"),l.dispatch(Wi());else if(e.messageType==="scribeViewerExpand")z("scribe_viewer_expanded"),l.dispatch(Bi());else if(e.messageType==="scribeViewerSetPosition")z("scribe_viewer_position_set",{position:e.position===Gi.RIGHT?"right":"left"}),l.dispatch(zi(e.position));else if(e.messageType==="scribeViewerOpenInScribe"){const{scribe:{id:g,name:m}}=bn(l.getState());z("scribe_viewer_opened_in_scribe",{id:g,name:m});const p=vn(g,m,!1,"","scribe",`${G.FRONTEND_URL}/`);chrome.tabs.query({currentWindow:!0}).then(o=>{o=o.filter(f=>f.url.includes(p)),o.length>0?chrome.tabs.update(o[0].id,{active:!0}):chrome.tabs.create({url:p})})}else if(e.messageType==="scribeViewerCloseViewer"){const{scribe:{id:g,name:m},progress:p}=bn(l.getState());z("scribe_viewer_close_viewer",{id:g,name:m,progress:p}),l.dispatch(Vi())}else if(e.messageType==="openAssistant")Qt(`${G.FRONTEND_URL}/sidebar/assistant?url=${e.href}`).then(g=>{g&&chrome.windows.update(g,{focused:!0})}),z("extension_dropdown_open_recommended_clicked",null,j);else if(e.messageType==="scribeViewerWidthChanged")l.dispatch(Hi(e.width));else if(e.messageType==="scribeViewerProgress")l.dispatch(Ji(e));else if(e.messageType==="closeStartingRecordingModal")l.dispatch(fs(!1)),l.dispatch(gt(!1));else if(e.messageType==="closeDropdown")l.dispatch(Fe(!1));else if(e.messageType==="fetchDocuments")wg(e).then(g=>{l.dispatch(ip(g))});else if(e.messageType==="createPin")Tg(e);else if(e.messageType==="clearPins")Eg();else if(e.messageType==="fetchPins")Ig().then(g=>{l.dispatch(sr(g))});else if(e.messageType==="setHoveredPin")l.dispatch(op(e.pinId));else if(e.messageType==="suggestionsRequested"){const{domains:g}=Te(l.getState()),m=e.source===ks.SIDEPANEL,p=m?await ee():t.tab,o=e.domain||await Ki();return kg({domain:o,query:e.query}).then(n),mr()&&(p!=null&&p.id)&&(g!==void 0&&wt(p.id,m),m||fr(p.id)),!0}else{if(e.messageType==="browserContextNeeded"&&t.tab)return chrome.windows.get(t.tab.windowId).then(g=>{n({tab:t.tab,window:g})}),!0;if(e.messageType==="action")Ga(e,t,n);else if(e.messageType==="getExtensionStatus"){const{status:g}=he(l.getState()),m=Be(l.getState());n({installed:!0,options:m,status:g,version:chrome.runtime.getManifest().version})}else if(e.messageType==="updateSuggestedScribeStatus"){try{const g=(await Mn()).transaction(["suggestedScribes"],"readonly").objectStore("suggestedScribes"),m=await new Promise((p,o)=>{const f=g.get(e.id);f.onsuccess=()=>p(f.result),f.onerror=()=>o(f.error)});if(!m)throw new Error(`Suggested Scribe not found: ${e.id}`);if(e.status==="accepted"){const p=(await Ve()).transaction([me],"readonly").objectStore(me),o=new Set(e.filteredActionIds||[]),f=m.source_actions.filter(C=>!o.has(C));I({message:"suggested_scribes_using_filtered_actions",category:"suggested_scribes",level:"info",data:{filtered:f.length,total:m.source_actions.length}});const y=await Promise.all(f.map(C=>new Promise((M,W)=>{const Q=p.get(C);Q.onsuccess=()=>{Q.result?M(Q.result):W(new Error(`Action not found: ${C}`))},Q.onerror=()=>W(Q.error)}))),v=[...await Promise.all(y.map(async C=>{if(C.screenshot)try{const M=await j.post("/signed_urls/",{name:"a screenshot"}),{upload_url:W,internal_url:Q,download_url:ke}=M.data;return await Kr(W,C.screenshot,"image/jpeg",{contentEncoding:"base64",timeout:6e4}),{...C,screenshot_url:Q,download_url:ke,screenshot_upload_status:"SUCCESS"}}catch(M){$(M,{tags:{component:"screenshot_upload"},extra:{message:"[Screenshot Upload] Error uploading screenshot"}});const{screenshot:W,...Q}=C;return Q}return C}))].sort((C,M)=>(C.timestamp||0)-(M.timestamp||0));v.forEach((C,M)=>{const W=M===0?C.timestamp:v[M-1].timestamp;C.start_timestamp=W,C.end_timestamp=C.timestamp}),I({message:"suggested_scribes_dehydrated_actions",category:"suggested_scribes",level:"info",data:{actionCount:v.length}});const w=v.map(({target_element:C,id:M,...W})=>({...W,tempId:M}));if(w.length>0&&w[0].kind!=="instruction"){const C=w[0];w.unshift({kind:"instruction",description:`Navigate to ${C.url}`,url:C.url,domain:C.domain||Nt(C.url)||"",tabId:C.tabId,tempId:Ue()})}const A=(ve=(K=(fe=(le=l.getState())==null?void 0:le.auth)==null?void 0:fe.userData)==null?void 0:K.active_organization)==null?void 0:ve.id;if(!A)throw new Error("No active organization found");const L=await j.post("/scribe_file/",{name:m.title,actions:w,recorder_type:"web",recorder_os:Vr(),created_with_copilot:!1,create_with_id:!0,id:Ue(),entry_point:"extension",insert_before_action:null,organization_id:A,task_id:"",transcribed_audio:null,capture_type:Yi.ExtensionAutoCapture});if(!L.status||!(L.status>=200&&L.status<300))throw new Error("Failed to create scribe");I({message:"suggested_scribe_created_successfully",category:"suggested_scribes",level:"info"});const{id:te,name:Y}=L.data;I({message:"suggested_scribes_deleting_source_actions",category:"suggested_scribes",level:"info",data:{actionCount:m.source_actions.length}});const k=await Ve(),X=k.transaction([me],"readwrite"),de=X.objectStore(me);await Promise.all(m.source_actions.map(C=>new Promise(M=>{const W=de.delete(C);W.onsuccess=()=>{I({message:"suggested_scribes_deleted_source_action",category:"suggested_scribes",level:"info",data:{actionId:C}}),M()},W.onerror=Q=>{var ke;I({message:"suggested_scribes_failed_delete_action",category:"suggested_scribes",level:"warning",data:{actionId:C,error:((ke=Q.target.error)==null?void 0:ke.message)||"Unknown error"}}),M()}}))),await new Promise(C=>{X.oncomplete=()=>{k.close(),C()},X.onerror=()=>{k.close(),C()}}),I({message:"suggested_scribes_all_actions_deleted",category:"suggested_scribes",level:"info"}),chrome.tabs.create({url:Xi(te,Y)})}await Nc(e.id,e.status,e.filteredActionIds),n({success:!0})}catch(g){$(g,{tags:{component:"suggested_scribes_update_status"},extra:{message:"[Suggested Scribes] Error updating status"}}),n({success:!1,error:g.message})}return!0}else if(e.messageType==="storeSuggestedScribe"){try{const g=await Fc(e.suggestion);I({message:"suggested_scribes_stored_new",category:"suggested_scribes",level:"info",data:{suggestionId:g}}),n({success:!0,id:g})}catch(g){$(g,{tags:{component:"suggested_scribes_store"},extra:{message:"[Suggested Scribes] Error storing suggestion"}}),n({success:!1,error:g.message})}return!0}else if(e.messageType==="analyzeActions"){try{I({message:"analyze_actions_started",category:"analyze_actions",level:"info"});const g=await $n();I({message:"analyze_actions_response",category:"analyze_actions",level:"info",data:{response:g}}),I({message:"analyze_actions_payload",category:"analyze_actions",level:"info",data:{payload:g.payload}}),($e=(Le=g.payload)==null?void 0:Le.analysis)!=null&&$e.patterns?I({message:"analyze_actions_patterns_found",category:"analyze_actions",level:"info",data:{patterns:g.payload.analysis.patterns}}):I({message:"analyze_actions_no_patterns",category:"analyze_actions",level:"info"}),n({success:!0,payload:g.payload})}catch(g){$(g,{tags:{component:"analyze_actions"},extra:{message:"[Analyze] Error analyzing actions"}}),n({success:!1,error:g.message})}return!0}else if(e.messageType==="clearSuggestedScribes"){try{I({message:"suggested_scribes_clearing_pending",category:"suggested_scribes",level:"info"}),await Rs(),n({success:!0})}catch(g){$(g,{tags:{component:"suggested_scribes"},extra:{message:"[Suggested Scribes] Error clearing suggested scribes"}}),n({success:!1,error:g.message})}return!0}}if(e.messageType==="getSuggestedScribeForPreview"){try{if(!e.id)return I({message:"suggested_scribe_preview_no_id",category:"suggested_scribes",level:"warning"}),n({success:!1,error:"No scribe ID provided"}),!0;I({message:"suggested_scribe_preview_loading",category:"suggested_scribes",level:"info",data:{scribeId:e.id}});const g=(await Mn()).transaction(["suggestedScribes"],"readonly").objectStore("suggestedScribes"),m=await new Promise((v,w)=>{const A=g.get(e.id);A.onsuccess=()=>{A.result?v(A.result):w(new Error(`Scribe not found: ${e.id}`))},A.onerror=L=>{w(new Error(`Failed to fetch scribe: ${L.target.error}`))}});I({message:"suggested_scribe_preview_found",category:"suggested_scribes",level:"info",data:{scribeId:e.id,actionCount:((rt=m.source_actions)==null?void 0:rt.length)||0}});const p=Array.isArray(m.source_actions)?m.source_actions:[],o=await Uc(p),f=await Promise.all(o.map(async v=>{if(v.screenshot instanceof Blob)try{const w=await br(v.screenshot);return{...v,screenshot:w,has_screenshot:!0}}catch(w){return $(w,{tags:{component:"suggested_scribe_preview"},extra:{message:"Error converting screenshot to base64"}}),{...v,screenshot:null,has_screenshot:!1}}return v})),y={...m,actions:f};I({message:"suggested_scribe_preview_loaded",category:"suggested_scribes",level:"info",data:{scribeId:e.id,actionCount:f.length}}),n({success:!0,scribe:y})}catch(g){$(g,{tags:{component:"suggested_scribe_preview"},extra:{message:"Error getting suggested scribe for preview"}}),n({success:!1,error:g.message||"Unknown error occurred"})}return!0}if(e.messageType==="updateLocalOption")return I({message:"local_option_updating",category:"local_options",level:"info",data:{key:e.key,value:e.value}}),Un(e.key,e.value).then(()=>{Xt(),n({status:"success"})}),!0;if(e.messageType==="getSuggestedScribeTask"){try{if(!e.taskId)return I({message:"suggested_scribe_task_no_id",category:"suggested_scribes",level:"warning"}),n({success:!1,error:"No task ID provided"}),!0;I({message:"task_fetching_status",category:"suggested_scribes",level:"info",data:{taskId:e.taskId}});const g=await Mc(e.taskId);if(!g)return I({message:"task_not_found",category:"suggested_scribes",level:"warning",data:{taskId:e.taskId}}),n({success:!1,error:"Task not found"}),!0;I({message:"task_status_fetched",category:"suggested_scribes",level:"info",data:{taskId:e.taskId,status:g.status}}),n({success:!0,task:g})}catch(g){$(g,{tags:{component:"suggested_scribe_task"},extra:{message:"[Task] Error fetching task"}}),n({success:!1,error:g.message||"Unknown error"})}return!0}if(e.messageType==="openScribeViewer"&&za(e),e.messageType==="updateSelectedSuggestionsFilter"){const{filter:g}=e;l.dispatch(Qi(g))}if(e.messageType==="getSelectedSuggestionsFilter"&&n(Zi(l.getState())),e.messageType==="getActiveAnalyzeTask")return Ds().then(g=>{n({success:!0,taskId:g})}).catch(g=>{$(g,{tags:{component:"active_analyze_task"},extra:{message:"[Task] Error fetching active analyze task"}}),n({success:!1,error:(g==null?void 0:g.message)||"Unknown error"})}),!0;if(e.messageType==="getAllowedDomains")return Os().then(g=>{n({allowedDomains:g})}).catch(()=>{n({allowedDomains:[]})}),!0;if(e.messageType==="inferPersona")return $c().then(g=>{n({data:{persona:g}})}).catch(g=>{console.error("[Persona] Error fetching persona:",g),n({data:null,error:(g==null?void 0:g.message)||"Unknown error"})}),!0}),!0)});function Qa(){l.dispatch(Fe(!0)),chrome.action.setPopup({popup:"src/scripts/main-content/index.html"}),chrome.action.openPopup(),chrome.action.setPopup({popup:""})}async function Za({openTabSelector:e=!1}={}){const t=l.getState().auth.userData,n=await Cs("recordingControlsPreference")==="floating-button";if(t){const r=_e(l.getState()),s={entryPoint:Ft.EXTENSION,isScribeEditMode:!1,taskId:""};if(n){r?Qa():hr(s);return}e&&hr(s);return}n&&Qa()}async function bg(e){const t=Xe();if(t){let s=q.Home;at(l.getState())?s=q.Copilot:_e(l.getState())&&(s=q.Recorder),ye(e.id,s)}await pr(),D("icon_click_listener_entered",e),z("sidekick_opened",{location:"extension_toolbar"});const n=await chrome.tabs.query({});n.length===1&&Z(n[0],{messageType:"OverrideShowContent"});const[r]=await chrome.tabs.query({active:!0,currentWindow:!0});if(r){const s=new URL(r.url);if(Ee(s.origin))Za();else{ir({tabId:r.id});const{dropdownOpen:a}=he(l.getState());a||(nt({callSource:"iconClickListener"}),await pr(),await tt()),t||l.dispatch(Fe(!a)),yr(r)}}D("icon_click_listener_exited")}chrome.action.onClicked.addListener(bg);const vg=5*60*1e3;function wt(e,t=!1){t?chrome.runtime.sendMessage({messageType:"domainsReceived"}):Z(e,{messageType:"domainsReceived"})}async function wg(e){var n;const t=await it(j,`c5f3bf32c4a909b4959e61009ddc299ad952efa5c6a406bddb/search?q=${e.query}&app_tags=[]&authors=[]&orgs=[]&results_type=workspace`);return t.ok?(n=t.data)==null?void 0:n.elastic_response:[]}async function eo(){var r,s;const{userData:e}=pt(l.getState()),t=(s=(r=e==null?void 0:e.active_organization)==null?void 0:r.super_organization)==null?void 0:s.allow_community,n=await it(Ci,"suggestions/domains/");if(n.ok){const{user:a,gallery:c}=n.data,i=t?c:{};return l.dispatch(Zu(Number(new Date))),_p(a,i)}}const to=()=>{eo().then(e=>{chrome.tabs.query({active:!0,currentWindow:!0},function(t){var n;t&&((n=t[0])!=null&&n.id)&&wt(t[0])}),l.dispatch(Da(e))})},Sg=e=>e&&e.replace("www.","").toLowerCase(),Eg=async()=>{chrome.storage.local.set({pins:[]}),l.dispatch(sr([]))},Tg=async e=>{const t=[e.pin],n=await chrome.storage.local.get("pins"),r=n!=null&&n.pins?[...n.pins,...t]:t;chrome.storage.local.set({pins:r}),l.dispatch(sr(r))},Ig=async()=>{var e;return((e=await chrome.storage.local.get("pins"))==null?void 0:e.pins)||[]},kg=async({domain:e,query:t})=>{const{domains:n}=Te(l.getState())||{domains:[]};let r="search",s=`search?q=${encodeURIComponent(t)}`;const a=!t||t==="";let c=null;if(a){if(n&&!(Sg(e)in n))return{user:[],gallery:[]};try{const d=await Ds();d&&(console.log("[Suggestions] Re-using active analysis task:",d),c=d)}catch(d){console.error("[Suggestions] Error fetching active analysis task:",d)}r="domainOnly",s=`suggestions?url=${e}`}const i=await it(j,s);if(i.ok){let d=[],u=[];if(r==="domainOnly")d=i.data.user,u=i.data.gallery;else{const{active:h,gallery:_,super_org:b,other:E}=i.data,O=h.concat(b,E),T=O.map(({id:R})=>R);d=O.filter(({id:R},P)=>!T.includes(R,P+1)).sort((R,P)=>P.view_count-R.view_count),u=_}return{user:d,gallery:u,taskId:c,isAsynchronous:!!c}}return{user:[],gallery:[],taskId:c,isAsynchronous:!!c}},Cg=async(e,t,n=0)=>{const{domains:r,lastFetched:s}=Te(l.getState());let a;if(r===void 0||s+vg<Number(new Date)){const c=await eo();if(l.dispatch(Da(c)),c===void 0)return n;wt(t),a=Pa(e,c)}else a=Pa(e,r);return a!==null?a:n},fr=async e=>{const{showBadgeNotifications:t}=Be(l.getState()),{userData:n}=pt(l.getState()),r=_e(l.getState());Oi&&chrome.action.setBadgeBackgroundColor({color:"#7048ec"}),n&&!r?chrome.tabs.get(e,async s=>{if(s!=null&&s.url){const a=new URL(s.url),{protocol:c}=a;if(c==="http:"||c==="https:"){const i=await Cg(s.url,s);i&&await Ri(e)?(t?chrome.action.setBadgeText({text:i>99?"99+":i.toString(),tabId:e}):chrome.action.setBadgeText({text:"",tabId:e}),l.dispatch(xa(i)),yr(s)):(l.dispatch(xa(0)),yr(s))}}}):chrome.action.setBadgeText({text:"",tabId:e})},yr=e=>{const{currentRecommendedScribeCount:t}=Te(l.getState());Z(e,{messageType:"scribeCountReceived",count:t}),chrome.runtime.sendMessage({messageType:"scribeCountReceived",count:t})},_r=async()=>{const[e,t]=await Promise.all([chrome.tabs.query({}),ee()]);e.forEach(n=>{Z(n,{messageType:"currentTabChanged",selfTab:t})}),chrome.runtime.sendMessage({messageType:"currentTabChanged",selfTab:t})};chrome.windows.onFocusChanged.addListener(_r);const Og=async(e,t,n)=>{var s,a;if(((s=await ee())==null?void 0:s.id)!==e)return;const{domains:r}=Te(l.getState());if(mr()&&(r!==void 0&&t.status==="complete"&&wt(n),t.status==="loading"&&fr(e)),await ls()&&!((a=n.pendingUrl)!=null&&a.includes("/sidebar/assistant"))&&!n.url.includes("/sidebar/assistant")){const c=await ds();Ma(n.url),await ye(n.id,q.Assistant,{queryParams:{...c.queryParams,url:n.url},frontendUrl:G.FRONTEND_URL})}_r()};chrome.tabs.onUpdated.addListener(Og),Hp();const Rg=(e,t)=>{const n=async(r,s)=>{if(!(!e||r!==e.id)&&s.status==="complete"){const a=await chrome.tabs.get(r);a&&t(a),chrome.tabs.onUpdated.removeListener(n)}};chrome.tabs.onUpdated.addListener(n)},Dg=async e=>{const{domains:t}=Te(l.getState()),n=await ds(),{tabId:r}=e;if(await ls()){const[s]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!s)return;t!==void 0&&wt(s),Ma(s.url),await ye(s.id,q.Assistant,{queryParams:{...n.queryParams,url:s.url},frontendUrl:G.FRONTEND_URL})}mr()&&fr(r),_r()},no=async()=>{var s;const{status:e}=he(l.getState());let t=H(l.getState());const n=e===ae.RECORDING?ae.PAUSED_RECORDING:ae.RECORDING;if(l.dispatch(ys(n)),n===ae.RECORDING&&l.dispatch(ec(Date.now())),n===ae.RECORDING&&Ec(pt(l.getState()).userData)&&hs(!1),n===ae.RECORDING){const[a]=await chrome.tabs.query({active:!0,currentWindow:!0});t.recordedTabs.find(c=>c===a.id)||(l.dispatch(Nn(a.id)),t=H(l.getState()))}const r=(s=await ms())==null?void 0:s.id;[...t.recordedTabs,r].forEach(a=>{try{a&&chrome.tabs.sendMessage(a,{messageType:"extensionStatusChange",status:n})}catch{}})};chrome.tabs.onActivated.addListener(Dg),chrome.windows.onFocusChanged.addListener(function(e){e===chrome.windows.WINDOW_ID_NONE&&chrome.tabs.query({active:!0,lastFocusedWindow:!0}).then(t=>{t.forEach(n=>chrome.tabs.sendMessage(n.id,{messageType:"switchedAwayFromBrowser"}))})}),ss().then(()=>{const{status:e}=he(l.getState());e===ae.ENDING_RECORDING?ut():e===ae.RECORDING&&(as(),os())}),es.persist(),bi(e=>{e.addEventProcessor(t=>(t.release=self.SENTRY_RELEASE.id,t))});const xg=async(e,t,n=null,r=1)=>{try{if(!e)return null;const s=await createImageBitmap(e),a=typeof r=="number"&&r>1?r:1,c=Math.round(s.width/a),i=Math.round(s.height/a),d=new OffscreenCanvas(c,i);d.getContext("2d").drawImage(s,0,0,c,i);const u=(t==null?void 0:t.x)!=null?t.x/a:c/2,h=(t==null?void 0:t.y)!=null?t.y/a:i/2;let _=Math.max(600,Math.min(1400,c)),b=Math.max(400,Math.min(768,i));_=Math.min(_,c),b=Math.min(b,i);let E=Math.max(0,Math.floor(u-_/2)),O=Math.max(0,Math.floor(h-b/2));E+_>c&&(E=c-_),O+b>i&&(O=i-b);let T=new OffscreenCanvas(_,b),R=T.getContext("2d");if(R.drawImage(d,E,O,_,b,0,0,_,b),Math.min(_,b)>768){const S=768/Math.min(_,b),U=Math.round(_*S),le=Math.round(b*S),fe=new OffscreenCanvas(U,le);fe.getContext("2d").drawImage(T,0,0,U,le),T=fe,R=T.getContext("2d")}const P=T.width,J=T.height;if(t&&typeof t.x=="number"&&typeof t.y=="number"){const S=u-E,U=h-O,le=Math.max(P,J),fe=Math.max(20,Math.min(60,le*.03)),K=fe/2;R.strokeStyle="rgba(255,0,0,0.85)",R.lineWidth=Math.max(6,fe*.25),R.lineCap="round",R.beginPath(),R.moveTo(S-K,U-K),R.lineTo(S+K,U+K),R.moveTo(S+K,U-K),R.lineTo(S-K,U+K),R.stroke()}let re;try{re=await T.convertToBlob({type:"image/webp",quality:.7})}catch{re=await T.convertToBlob({type:"image/jpeg",quality:.7})}return I({message:"long_running_recorder_annotated_screenshot",category:"long_running_recorder",level:"info",data:{size:(re==null?void 0:re.size)||0}}),re}catch(s){return $(s,{tags:{component:"long_running_recorder"},extra:{message:"[Long Running Recorder] Failed to optimise + annotate screenshot"}}),null}},tn=async(e,t)=>{try{I({message:"long_running_recorder_screenshot_start",category:"long_running_recorder",level:"info",data:{actionId:e.id}});const n=await chrome.tabs.captureVisibleTab(null,{format:"jpeg",quality:70});I({message:"long_running_recorder_screenshot_captured",category:"long_running_recorder",level:"info",data:{actionId:e.id,sizeKB:Math.round(n.length/1024)}});const r=await(await fetch(n)).blob();let s=null;e.kind==="mouse_click_action"&&e.position&&(s=await xg(r,e.position,e.viewport,e.devicePixelRatio));const a=await br(s||r);try{let i="";try{i=(await new Promise(_=>{chrome.storage.local.get(["options"],b=>{_(b.options?JSON.parse(b.options):{})})})).longRunningRecorderPersona||"",I({message:"long_running_recorder_persona",category:"long_running_recorder",level:"info",data:{persona:i}})}catch(_){$(_,{tags:{component:"long_running_recorder"},extra:{message:"[Long Running Recorder] Error getting persona"}})}const d=_=>{if(!_||typeof _!="string")return{imageFormat:"jpeg",base64:""};const b=_.match(/^data:image\/(.*?);base64,(.*)$/);return b?{imageFormat:b[1]||"jpeg",base64:b[2]}:{imageFormat:"jpeg",base64:_}},{imageFormat:u,base64:h}=d(a)}catch{}const c={...e,screenshot:r,...s?{annotated_screenshot:s}:{},timestamp:e.timestamp||Date.now(),tabId:t};await ro(c)}catch(n){$(n,{tags:{component:"long_running_recorder"},extra:{message:"[Long Running Recorder] Error capturing screenshot"}}),await ro({...e,timestamp:e.timestamp||Date.now(),tabId:t,captureError:n.message})}},ro=async e=>{try{const t=await Ve(),n=t.transaction([me],"readwrite"),r=n.objectStore(me);I({message:"long_running_recorder_storing_action",category:"long_running_recorder",level:"info",data:{id:e.id,type:e.type,kind:e.kind,url:e.url,timestamp:new Date(e.timestamp).toLocaleString(),hasScreenshot:!!e.screenshot}});const s=await new Promise(i=>{const d=r.get(e.id);d.onsuccess=u=>i(u.target.result),d.onerror=()=>i(null)});let a=e;s&&!e.screenshot&&s.screenshot&&(a={...e,screenshot:s.screenshot});const c=r.put(a);await new Promise((i,d)=>{c.onsuccess=()=>{I({message:"long_running_recorder_action_stored",category:"long_running_recorder",level:"info",data:{actionId:e.id}}),so(),i()},c.onerror=u=>{$(u.target.error,{tags:{component:"long_running_recorder"},extra:{message:"[Long Running Recorder] Error storing action",actionId:e.id}}),d(u.target.error)},n.oncomplete=()=>{t.close(),i()},n.onerror=d})}catch(t){$(t,{tags:{component:"long_running_recorder"},extra:{message:"[Long Running Recorder] Error storing action in IndexedDB"}})}},Ve=()=>new Promise((e,t)=>{const n=indexedDB.open(Oc,Rc);n.onupgradeneeded=r=>{const s=r.target.result;if(!s.objectStoreNames.contains(me)){const a=s.createObjectStore(me,{keyPath:"id"});a.createIndex("timestamp","timestamp",{unique:!1}),a.createIndex("url","url",{unique:!1})}},n.onsuccess=r=>e(r.target.result),n.onerror=r=>t(r.target.error)}),br=e=>new Promise((t,n)=>{if(!e){t(null);return}const r=new FileReader;r.onloadend=()=>t(r.result),r.onerror=n,r.readAsDataURL(e)}),vr=10,Ag=8e3;let wr=!1,nn=null;async function Pg(){const e=(await Ve()).transaction([me],"readonly").objectStore(me);return new Promise((t,n)=>{let r=0;const s=e.openCursor();s.onsuccess=a=>{const c=a.target.result;if(!c){t(r);return}c.value.long_description||(r+=1),c.continue()},s.onerror=a=>n(a.target.error)})}async function so(){const e=await Pg();e>=vr?ao(0):e>0&&ao(Ag)}function ao(e=0){nn!==null&&clearTimeout(nn),nn=setTimeout(async()=>{nn=null,await oo()},e)}async function Lg(){const e=(await Ve()).transaction([me],"readonly").objectStore(me),t=[];return new Promise((n,r)=>{const s=e.openCursor();s.onsuccess=async a=>{const c=a.target.result;if(!c||t.length>=vr){n(t);return}const{value:i}=c;i.long_description||t.push(i),c.continue()},s.onerror=a=>r(a.target.error)})}async function Ng(e){var r;if(!e)return{base64:"",imageFormat:"jpeg"};if(typeof e=="string"){const s=e.match(/^data:image\/(.*?);base64,(.*)$/);if(s)return{imageFormat:s[1]||"jpeg",base64:s[2]}}const t=await br(e),n=t.match(/^data:image\/(.*?);base64,(.*)$/);return n?{imageFormat:n[1]||"jpeg",base64:n[2]}:{imageFormat:((r=e.type)==null?void 0:r.split("/")[1])||"webp",base64:t}}async function oo(){if(!wr){wr=!0;try{for(;;){const e=await Lg();if(!e.length)break;const t=await Dc(),n=[],r=s=>{let a="click";switch(s.kind){case"mouse_click_action":case"mouse_start_drag_action":case"mouse_end_drag_action":case"mouse_cancel_drag_action":a="click";break;case"keyboard_action":case"keyboard_sequence_action":case"keyboard_combination_action":a="type";break;case"scroll_action":a="scroll";break;default:a="click"}let c;const i=(s.target_tag||"").toLowerCase();return["input","button","select","textarea","a"].includes(i)&&(c=i==="a"?"link":i),{mappedType:a,mappedKind:c}};for(const s of e){const{imageFormat:a,base64:c}=await Ng(s.annotated_screenshot||s.screenshot),{mappedType:i,mappedKind:d}=r(s),u=typeof s.target_text=="string"?s.target_text.slice(0,500):void 0;let h=typeof s.description=="string"?s.description:"";h=h.trim().slice(0,1e3),h||(h=i==="type"?"Type text":i==="scroll"?"Scroll page":"Click element");const _={id:s.id,screenshot_data_base64:c,image_format:a||"jpeg",type:i,current_description:h,...u?{target_text:u}:{},...s.target_tag?{target_tag:s.target_tag}:{},url:s.url};d&&(_.kind=d),n.push(_)}try{const s=await xc.post(`${Ac}/api/v1/long_recorder/actions/enhance`,{persona:t,actions:n}),a=(i=>i?Array.isArray(i.enhanced_actions)?i.enhanced_actions:i.enhanced_actions&&typeof i.enhanced_actions=="object"&&!Array.isArray(i.enhanced_actions)?Object.entries(i.enhanced_actions).map(([d,u])=>({id:d,...u})):Object.entries(i).map(([d,u])=>({id:d,...u})):[])(s.data);a.length||I({message:"long_running_recorder_no_enhancements",category:"long_running_recorder",level:"warning"});const c=(await Ve()).transaction([me],"readwrite").objectStore(me);for(const i of a)if(i&&i.long_description&&i.id){const d=c.get(i.id);d.onsuccess=()=>{const u=d.result;u&&c.put({...u,description:i.short_description||i.description||u.description,long_description:i.long_description,action_confidence:i.action_confidence})}}}catch(s){$(s,{tags:{component:"long_running_recorder"},extra:{message:"[Long Running Recorder] Bulk enhancement error"}});break}if(e.length<vr)break}}finally{wr=!1}}}async function Fg(){await oo()}so(),chrome.runtime.onMessage.addListener((e,t,n)=>{if(e.messageType==="flushEnhancements")return Fg().then(()=>n({status:"done"})),!0});const Sr=new Map,Ug=1e3,St=new Map;function Mg(e=[],t=[]){const n=[...e];return t.forEach(r=>{r&&r.toLowerCase()===oe.BACKSPACE?n.length>0&&n.pop():n.push(r)}),n}function $g(e,t){let n=Sr.get(t);n||(n={actions:[],timeoutId:null},Sr.set(t,n)),n.actions.push(e),n.timeoutId&&clearTimeout(n.timeoutId),n.timeoutId=setTimeout(()=>{io(t)},Ug)}function io(e){var s,a;const t=Sr.get(e);if(!t||t.actions.length===0)return;const n=t.actions;t.actions=[],t.timeoutId&&(clearTimeout(t.timeoutId),t.timeoutId=null);let r;try{r=In(n,((a=(s=_s())==null?void 0:s.toLowerCase)==null?void 0:a.call(s))||"mac")}catch{r=[]}r.filter(c=>c.kind===oe.KEYBOARD_ACTIONS.SEQUENCE||c.kind===oe.KEYBOARD_ACTIONS.COMBINATION).forEach(c=>{if(c.id||(c.id=Ue()),c.kind===oe.KEYBOARD_ACTIONS.SEQUENCE){const i=St.get(e);if(i&&i.target_xpath&&i.target_xpath===c.target_xpath){const d=Mg(i.keys||[],c.keys||[]),u={...i,keys:d,end_timestamp:c.end_timestamp||c.timestamp||Date.now(),timestamp:c.end_timestamp||c.timestamp||Date.now()};u.long_description=void 0,tn(u,e),St.set(e,u)}else tn(c,e),St.set(e,c)}else tn(c,e),St.delete(e)})}

import"./modulepreload-polyfill-3cfb730f.js";import{d as q,h as G,e as r,g as i,f as u,j as g,u as h,o as L,k as _,r as l,l as F,m as P,n as k,U as x}from"./store-fcbe2a1f.js";import"./sidepanel-active-state-3bb41945.js";import{g as B}from"./capture-helpers-db115b06.js";import"./_commonjsHelpers-de833af9.js";import"./v4-c70744d4.js";import"./index.esm-e3d6f8ec.js";import"./domUtils-6bdec28b.js";import"./getTargetElementAttributes-3f1109f1.js";const N=()=>{P().then(t=>{t!=null&&t.url&&k(`${(t==null?void 0:t.frontendUrl)??x.FRONTEND_URL}/${t==null?void 0:t.url}`)})};N(),chrome.storage.local.onChanged.addListener(t=>{t!=null&&t[q.RouteConfig]&&G(t[q.RouteConfig])}),chrome.runtime.onMessage.addListener(({messageType:t,data:e})=>{var w,M,f,S,I,T,y,C,b,v,R,U;if(t===r.UpdateLiveIndex){const s=i();s&&((w=s.contentWindow)==null||w.postMessage("advanceLiveStep","*"))}if(t===r.PreviousLiveStep){const s=i();s&&((M=s.contentWindow)==null||M.postMessage({messageType:"guideMePreviousStep"},"*"))}if(t===r.SetGuideMeStepNotFound){const s=i();s&&(e!=null&&e.dom?chrome.tabs.captureVisibleTab({format:"jpeg"}).then(async n=>{var c;const{uploadUrl:o,downloadUrl:d}=await u({sessionId:e.sessionId,requestId:e.requestId,pathPrefix:`guide_me/current_dom_screenshot/${e.sessionId}`,name:"Guide Me"}),a=g(n);h({screenshotBlob:a,uploadUrl:o}),(c=s.contentWindow)==null||c.postMessage({messageType:"showGuideMeStepNotFoundMsg",data:{showMessage:e==null?void 0:e.showMessage,message:e==null?void 0:e.message,dom:e==null?void 0:e.dom,url:e==null?void 0:e.url,sessionId:e==null?void 0:e.sessionId,requestId:e==null?void 0:e.requestId,currentDomScreenshot:d}},"*")}):(f=s.contentWindow)==null||f.postMessage({messageType:"showGuideMeStepNotFoundMsg",data:{showMessage:e==null?void 0:e.showMessage,message:e==null?void 0:e.message,dom:e==null?void 0:e.dom,url:e==null?void 0:e.url,sessionId:e==null?void 0:e.sessionId,requestId:e==null?void 0:e.requestId}},"*"))}if(t===r.Recapture){const s=i();s&&((S=s.contentWindow)==null||S.postMessage({messageType:"initRecapture"},"*"))}if(t===r.CompleteStepRecapture){const s=i();s&&((I=s.contentWindow)==null||I.postMessage({messageType:"completeStepRecapture"},"*"))}if(t===r.CancelStepRecapture){const s=i();s&&((T=s.contentWindow)==null||T.postMessage({messageType:"cancelStepRecapture"},"*"))}if(t===r.ExtensionStateUpdate&&l.isRecording){const s=i();s&&((y=s.contentWindow)==null||y.postMessage({messageType:t,data:e},"*"))}if(t===r.StartRecording&&e.liveTranscriptions&&(l.isRecording=!0,chrome.tabs.query({active:!0,lastFocusedWindow:!0},s=>{const n=s[0];e.inCopilotMode||L(n==null?void 0:n.id,_.Recorder,{queryParams:{url:e.url||(n==null?void 0:n.url)||""},frontendUrl:e.frontendUrl})})),t==="savedCopilotScribe"){const s=i();if(s){const n={messageType:"savedCopilotScribe"};(C=s==null?void 0:s.contentWindow)==null||C.postMessage(n,"*")}}if(t===r.EndRecording&&(chrome.runtime.sendMessage({messageType:"trackNewRelicLog",name:"sidepanel_end_recording",details:{liveTranscriptions:e.liveTranscriptions,localRecordingState:l}}),l.isRecording=!1,e.liveTranscriptions?(F(),setTimeout(()=>{window.close()},50)):P().then(s=>{(s==null?void 0:s.path)===_.Recorder&&(F(),window.close())})),t===r.GuideMeOtherElementClicked||t===r.GuideMeCaptureFreshPageScreenshot){const s=i(),n=t===r.GuideMeOtherElementClicked?`guide_me/user_screenshots/${e.sessionId}`:`guide_me/fresh_page_screenshots/${e.sessionId}`;chrome.tabs.captureVisibleTab({format:"jpeg"}).then(async o=>{var p;const{uploadUrl:d,downloadUrl:a}=await u({sessionId:e.sessionId,requestId:e.requestId,pathPrefix:n,name:"Guide Me"}),c=g(o);h({screenshotBlob:c,uploadUrl:d});const m={messageType:t,screenshot:o,downloadUrl:a,...e};(p=s==null?void 0:s.contentWindow)==null||p.postMessage(m,"*")})}if(t===r.SendScreenshotCoordinates){const s=i();chrome.tabs.query({active:!0,lastFocusedWindow:!0},n=>{const o=n[0];chrome.scripting.executeScript({target:{tabId:o==null?void 0:o.id},func:()=>window.devicePixelRatio}).then(d=>{chrome.tabs.captureVisibleTab({format:"jpeg"}).then(async a=>{var W;const{uploadUrl:c,downloadUrl:m}=await u({sessionId:e.sessionId,requestId:e.requestId,pathPrefix:`copilot/model_screenshots/${e.sessionId}`,name:"Copilot"}),p=g(a);h({screenshotBlob:p,uploadUrl:c});const E={messageType:"sendScreenshotCoordinates",screenshot:a,dpr:d[0].result,downloadUrl:m,...e};(W=s==null?void 0:s.contentWindow)==null||W.postMessage(E,"*")}).then(()=>{chrome.tabs.sendMessage(o.id,{messageType:"screenshotCaptureDone"})})}).catch(()=>{var a;const d={messageType:"sendScreenshotCoordinates",dpr:1,...e};chrome.tabs.sendMessage(o.id,{messageType:"screenshotCaptureDone"}),(a=s==null?void 0:s.contentWindow)==null||a.postMessage(d,"*")})})}if(t===r.SendDomtoSidepanel){const s=i(),{dom:n,url:o,sessionId:d}=e;if(s){const a={messageType:"sendDomToSidepanel",dom:n,url:o,sessionId:d};(b=s==null?void 0:s.contentWindow)==null||b.postMessage(a,"*")}}if(t===r.PauseCopilotFromBrowser){const s=i();if(s){const n={messageType:"pauseCopilotFromBrowser",source:"sidepanel.ts"};(v=s==null?void 0:s.contentWindow)==null||v.postMessage(n,"*")}}if(t===r.StopCopilotFromBrowser){const s=i();if(s){const n={messageType:"stopCopilotFromBrowser"};(R=s==null?void 0:s.contentWindow)==null||R.postMessage(n,"*")}}if(t===r.NetworkConnectionStatus){const s=i();s&&((U=s.contentWindow)==null||U.postMessage({messageType:"checkServerAvailability",isOnline:e.isOnline,internetConnection:e==null?void 0:e.internetConnection,scribeServerError:e==null?void 0:e.scribeServerError},"*"))}}),document.addEventListener("keydown",B(document));

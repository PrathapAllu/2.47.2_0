import{f as _,g as v}from"./index.esm-e3d6f8ec.js";import{as as P,at as R,k as K,au as L,ao as g,av as C,aw as O}from"./store-fcbe2a1f.js";import{v as A}from"./v4-c70744d4.js";import{g as I}from"./domUtils-6bdec28b.js";import{g as w}from"./getTargetElementAttributes-3f1109f1.js";const u=1e3;async function D(){const t=A(),a=t;return new Promise((e,r)=>{let o=!1;setTimeout(()=>{o||r(new Error(`Timeout while waiting over ${u}ms for iframe offset response in experimental CAP-440 algorithm.`))},u);const i=l=>{var m;(m=l.data)!=null&&m.iframeOffsetResponseId&&(o=!0,window.removeEventListener("message",i),e({left:l.data.left,top:l.data.top}))};window.addEventListener("message",i);const c={tempFramePathId:a,iframeOffsetRequestId:t,left:0,top:0};window.parent.postMessage(c,"*")})}const T=async t=>{let a={left:0,top:0};if(window!==window.top)try{a=await D()}catch(e){console.warn(`Failed to get accumulated frame offset for ${t}:`,e)}return a},p={iframeId:null},h=t=>{try{return t.self!==t.top}catch{return!0}},M=()=>window.frameElement?window.frameElement.src:window.location.href,k=async t=>t?new Promise(a=>{chrome.runtime.sendMessage({messageType:"getIframePosition",location:O(M()),iframeId:t},e=>{chrome.runtime.lastError||!e?a({error:chrome.runtime.lastError||!0}):a(e)})}):{error:"No iframeId provided"},y=t=>{const a=t||window;return h(a)?a.frameElement===null?!0:a.frameElement?y(a.parent):!1:!1},E=async(t,a)=>{var o,i;const{iframeId:e}=a;window.location&&(t.url=window.location.href,t.domain=window.location.hostname,t.page_title=document.title);let r=t;if(y(window)){if((i=P((o=R(t.url))==null?void 0:o.pathname))!=null&&i.endsWith(K.Recorder))return;let{url:c,domain:l,page_title:m,error:n}=await k(e);r={...t,...n?{}:{url:c,domain:l,page_title:m}}}chrome.runtime.sendMessage({messageType:"action",action:r})},S=t=>a=>{var d,f;if(t.activeElement&&t.activeElement.type==="password")return;const e=Date.now(),{key:r,shiftKey:o,altKey:i,ctrlKey:c,metaKey:l}=a;if(!r||L(r))return;let m=null;try{a.target?m=_(a.target):console.log("No event target found for selector.")}catch{console.log("Could not generate selector.")}const n=w(a.target),s=v(a.target,{ignoreId:!0});E({kind:g.KEYBOARD_ACTIONS.PRESS,direction:g.KEY_DIRECTIONS.DOWN,modifiers:{shiftKey:o,altKey:i,ctrlKey:c,metaKey:l},target_selector:m,target_xpath:s,target_tag:(d=a.target)==null?void 0:d.tagName,target_element:I((f=a.target)==null?void 0:f.outerHTML),target_element_attributes:n,key:C(r),timestamp:e},{iframeId:p.iframeId})},H=(t,a)=>{let e;const r=i=>{a(i),e()},o=()=>{e()};e=()=>{t.removeEventListener("blur",o),t.removeEventListener("change",r)},t.addEventListener("blur",o),t.addEventListener("change",r)},Y=t=>async a=>{var o;const e=a.target,r=e;if((r==null?void 0:r.type)!=="password"&&(e!=null&&e.isContentEditable)||(e==null?void 0:e.tagName)==="TEXTAREA"||(e==null?void 0:e.tagName)==="INPUT"&&["text","email","search","tel","url","number"].includes(r==null?void 0:r.type)){let i=null;try{i=_(e)}catch{console.log("Could not generate selector for input blur.")}const c=w(e),l=w((o=t==null?void 0:t.defaultView)==null?void 0:o.frameElement),m=v(e,{ignoreId:!0}),n=window,s=e.getBoundingClientRect(),d=n&&n.devicePixelRatio||1,f=await T("input blur"),b=s.left+s.width/2,x=s.top+s.height/2,N={kind:g.INPUT_BLUR,direction:"blur",timestamp:Date.now(),position:{x:(s.x+f.left+s.width/2)*d,y:(s.y+f.top+s.height/2)*d},viewport:{width:n.innerWidth,height:n.innerHeight},was_in_iframe:h(n),iframe_attributes:l,scrollPosition:{x:n.scrollX,y:n.scrollY},position_within_element:{x:b,y:x},devicePixelRatio:d,target_selector:i,target_xpath:m,target_tag:e==null?void 0:e.tagName,target_element:I(e==null?void 0:e.outerHTML),target_element_attributes:c};E(N,{iframeId:p.iframeId})}};export{u as C,p as a,T as b,h as c,E as d,Y as e,S as g,y as i,H as r};
